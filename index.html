<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>EventMap2 - Global Festival Tracker</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <!-- Leaflet MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"/>

  <style>
    body { margin:0; padding:0; overflow:hidden; background:#000; font-family: Pretendard, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    #map { height:100vh; width:100vw; background:#000000; }

    /* #upgrade: ì§€ë„ ë‹¤í¬ëª¨ë“œ ê³ ì •(ë” ê²€ì •) - íƒ€ì¼ ì´ë¯¸ì§€ë§Œ í•„í„°(ì´ì¤‘ ë°˜ì „ ë°©ì§€) */
    #map .leaflet-tile { filter: invert(100%) hue-rotate(180deg) brightness(82%) contrast(110%); }
    #map .leaflet-container { background:#000; }

    /* #upgrade: ë“œë˜ê·¸ ì…€ë ‰ì…˜ ë°•ìŠ¤(Alt+Drag) */
    .selection-box {
      position:absolute;
      border:2px solid #2196F3;
      background: rgba(33,150,243,0.20);
      z-index: 9999;
      pointer-events:none;
      display:none;
    }

    /* #upgrade: Region Glow í´ë¦¬ê³¤ ë°œê´‘ */
    @keyframes pulse-glow {
      0%   { stroke-opacity:0.35; stroke-width:2; }
      50%  { stroke-opacity:1.00; stroke-width:5; }
      100% { stroke-opacity:0.35; stroke-width:2; }
    }
    .region-glow-path {
      stroke: #ffeb3b;
      fill: #ffeb3b;
      fill-opacity: 0.08;
      animation: pulse-glow 2s infinite;
    }

    /* ìƒì„¸ ì‹œíŠ¸ */
    #detailSheet { transition: transform 0.28s ease-in-out; }

    /* #upgrade: 64x64 ì›í˜• ì´ë¯¸ì§€ ë§ˆì»¤(divIcon) */
    .marker-wrap {
      width:64px; height:64px;
      border-radius:9999px;
      border:3px solid rgba(255,255,255,0.92);
      box-shadow: 0 6px 14px rgba(0,0,0,0.45);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#111;
      transform: translateZ(0);
    }
    .marker-img {
      width:100%; height:100%;
      object-fit:cover;
      display:block;
      transform: translateZ(0);
    }
    .marker-wrap:hover { transform: scale(1.07); }
    .marker-selected { border-color:#ffeb3b !important; box-shadow: 0 0 18px rgba(255,235,59,0.55), 0 6px 14px rgba(0,0,0,0.45); }

    /* í´ëŸ¬ìŠ¤í„°(ì‚°ì ë„ ëŠë‚Œ) */
    .marker-cluster-small { background-color: rgba(110, 204, 57, 0.60); }
    .marker-cluster-small div { background-color: rgba(110, 204, 57, 0.60); }
    .marker-cluster-medium { background-color: rgba(240, 194, 12, 0.60); }
    .marker-cluster-medium div { background-color: rgba(240, 194, 12, 0.60); }
    .cluster-high-density { background-color: rgba(255, 59, 48, 0.72); }
    .cluster-high-density div { background-color: rgba(255, 59, 48, 0.72); }

    .no-scrollbar::-webkit-scrollbar { display:none; }
    .no-scrollbar { -ms-overflow-style:none; scrollbar-width:none; }

    /* #upgrade: ìƒë‹¨ UI hover/focusì¼ ë•Œë§Œ ìµœê·¼ê²€ìƒ‰ í‘œì‹œ */
    .top-hover-show { opacity:0; pointer-events:none; transform: translateY(-2px); transition: opacity .18s ease, transform .18s ease; }
    .top-hover-zone:hover .top-hover-show,
    .top-hover-zone:focus-within .top-hover-show { opacity:1; pointer-events:auto; transform: translateY(0); }

    /* #upgrade: ì„ íƒ ì•¡ì…˜ë°” */
    .actionbar { transition: transform .18s ease, opacity .18s ease; }
  </style>
</head>

<body class="bg-black text-white">

  <!-- #upgrade: 1ë‹¨ - ë„¤ì´ë²„ ê²€ìƒ‰ form (ì‹¤ì œ ì—°ë™) -->
  <div class="fixed top-3 left-1/2 -translate-x-1/2 z-[1000] w-[90%] max-w-[540px] top-hover-zone">
    <form id="naverForm"
          action="https://search.naver.com/search.naver"
          method="GET"
          target="_blank"
          class="bg-gray-900/90 backdrop-blur-md rounded-full shadow-2xl border border-gray-700 p-2 flex items-center gap-2">
      <div class="pl-3 text-green-500 font-bold select-none">N</div>
      <input id="searchInput"
             name="query"
             type="text"
             placeholder="ì¶•ì œ/ì§€ì—­/íƒœê·¸ ê²€ìƒ‰ (Enter=ë„¤ì´ë²„, ì…ë ¥ì¤‘=ì‹¤ì‹œê°„ í•„í„°)"
             class="bg-transparent border-none text-white px-2 py-2 w-full focus:outline-none placeholder-gray-400 text-sm"/>

      <button type="button"
              id="btnInternalSearch"
              class="bg-slate-700 hover:bg-slate-600 text-white rounded-full px-3 py-2 text-xs border border-slate-600">
        ë‚´ë¶€í•„í„°
      </button>

      <button type="submit"
              class="bg-green-600 hover:bg-green-500 text-white rounded-full w-10 h-10 flex items-center justify-center transition-colors"
              title="ë„¤ì´ë²„ ê²€ìƒ‰">
        ğŸ”
      </button>
    </form>

    <!-- #upgrade: ìµœê·¼ ê²€ìƒ‰ì–´ 5ê°œ(ìƒë‹¨ ì˜ì—­ hover/focusì—ë§Œ í‘œì‹œ) -->
    <div id="recentSearchRow"
         class="top-hover-show mt-2 flex gap-1 flex-wrap justify-center">
    </div>
  </div>

  <!-- #upgrade: 2ë‹¨ - êµ­ê°€ íƒ­ -->
  <div class="fixed top-[74px] left-1/2 -translate-x-1/2 z-[900] w-[92%] max-w-[620px] flex justify-center gap-2">
    <button onclick="setCountry('Korea')" id="btn-Korea"
            class="px-4 py-1.5 rounded-full text-sm font-semibold bg-blue-600 text-white border border-blue-400/40 transition-all">ğŸ‡°ğŸ‡· í•œêµ­</button>
    <button onclick="setCountry('Japan')" id="btn-Japan"
            class="px-4 py-1.5 rounded-full text-sm font-semibold bg-gray-800 text-gray-400 hover:bg-gray-700 border border-gray-600 transition-all">ğŸ‡¯ğŸ‡µ ì¼ë³¸</button>
    <button onclick="setCountry('Memo')" id="btn-Memo"
            class="px-4 py-1.5 rounded-full text-sm font-semibold bg-gray-800 text-gray-400 hover:bg-gray-700 border border-gray-600 transition-all">ğŸ“ ë©”ëª¨</button>
  </div>

  <!-- #upgrade: 3ë‹¨ - ì„œë¸Œ íƒ­(1ì¤„) -->
  <div id="subTabContainer"
       class="fixed top-[118px] left-1/2 -translate-x-1/2 z-[850] w-full max-w-[860px] px-3 flex gap-2 overflow-x-auto no-scrollbar justify-start md:justify-center">
  </div>

  <!-- #upgrade: 3ë‹¨ - Memoìš© ì¶”ê°€ í•„í„°(2ì¤„) -->
  <div id="subTabContainer2"
       class="fixed top-[156px] left-1/2 -translate-x-1/2 z-[840] w-full max-w-[860px] px-3 flex gap-2 overflow-x-auto no-scrollbar justify-start md:justify-center hidden">
  </div>

  <!-- ì§€ë„ -->
  <div id="map"></div>

  <!-- selection box(Alt+Drag) -->
  <div id="selectionBox" class="selection-box"></div>

  <!-- #upgrade: ì„ íƒ ì•¡ì…˜ë°”(ì„ íƒëœ ë§ˆì»¤ íƒœê·¸/ìƒ‰ ì²˜ë¦¬) -->
  <div id="selectionActionBar"
       class="fixed bottom-3 left-1/2 -translate-x-1/2 z-[950] actionbar opacity-0 pointer-events-none transform translate-y-3
              bg-gray-900/90 backdrop-blur rounded-2xl border border-gray-700 shadow-xl px-3 py-2 flex items-center gap-2">
    <div class="text-xs text-gray-300" id="selectionCount">ì„ íƒ 0</div>
    <button id="btnAddTagSelected" class="text-xs px-2 py-1 rounded-lg bg-indigo-600 hover:bg-indigo-500 border border-indigo-400/30">íƒœê·¸ ì¶”ê°€</button>
    <button id="btnBrightenSelected" class="text-xs px-2 py-1 rounded-lg bg-slate-700 hover:bg-slate-600 border border-slate-600">ë°ê²Œ</button>
    <button id="btnDarkenSelected" class="text-xs px-2 py-1 rounded-lg bg-slate-700 hover:bg-slate-600 border border-slate-600">ì–´ë‘¡ê²Œ</button>
    <button id="btnClearSelection" class="text-xs px-2 py-1 rounded-lg bg-gray-800 hover:bg-gray-700 border border-gray-600">ESC í•´ì œ</button>
  </div>

  <!-- #upgrade: ìƒì„¸ ì‹œíŠ¸(30% ê°ì†Œ) -->
  <div id="detailSheet"
       class="fixed bottom-0 left-0 w-full h-[25vh] bg-gray-900 rounded-t-3xl
              shadow-[0_-5px_20px_rgba(0,0,0,0.8)] transform translate-y-full z-[1000]
              flex flex-col border-t border-gray-700">

    <div class="w-12 h-1.5 bg-gray-600 rounded-full mx-auto mt-3 mb-2"></div>
    <button id="closeSheetBtn" class="absolute top-4 right-4 text-gray-400 hover:text-white">âœ•</button>

    <div class="flex h-full p-4 gap-4 overflow-hidden">
      <div class="w-[28%] h-full rounded-xl overflow-hidden shadow-lg relative bg-gray-800">
        <img id="sheetImage" src="" class="w-full h-full object-cover opacity-95" alt="Event">
        <div class="absolute bottom-0 left-0 bg-gradient-to-t from-black to-transparent w-full h-1/2"></div>
      </div>

      <!-- VIEW MODE -->
      <div id="sheetViewMode" class="w-[72%] flex flex-col text-left overflow-y-auto no-scrollbar">
        <div class="flex items-center gap-2 mb-1">
          <span id="sheetCountry" class="text-xs px-2 py-0.5 rounded bg-gray-700 text-gray-300"></span>
          <span id="sheetRegion" class="text-xs px-2 py-0.5 rounded bg-blue-900 text-blue-200"></span>
        </div>
        <h2 id="sheetTitle" class="text-xl md:text-2xl font-bold text-white mb-1 leading-tight"></h2>
        <p id="sheetDesc" class="text-gray-300 text-sm mb-2 font-light leading-relaxed"></p>

        <div class="mt-auto">
          <p class="text-[11px] text-gray-500 uppercase tracking-wider mb-1">Guest / Celeb</p>
          <div id="sheetCeleb" class="flex flex-wrap gap-2"></div>
        </div>

        <div class="mt-2">
          <p class="text-[11px] text-gray-500 uppercase tracking-wider mb-1">Tags</p>
          <div id="sheetTags" class="flex flex-wrap gap-1"></div>
        </div>

        <div class="mt-2 flex gap-2 flex-wrap">
          <button id="btnNaverSearchFromSheet"
                  class="text-xs px-2 py-1 rounded-lg bg-green-700 hover:bg-green-600 border border-green-400/30">
            ë„¤ì´ë²„ë¡œ ê²€ìƒ‰
          </button>
          <button id="btnAddLabelFromSheet"
                  class="text-xs px-2 py-1 rounded-lg bg-indigo-600 hover:bg-indigo-500 border border-indigo-400/30">
            ë¼ë²¨ ì¶”ê°€
          </button>
          <button id="btnEditMemo"
                  class="text-xs px-2 py-1 rounded-lg bg-slate-700 hover:bg-slate-600 border border-slate-600 hidden">
            ë©”ëª¨ ìˆ˜ì •
          </button>
        </div>
      </div>

      <!-- INPUT MODE (Memo ìƒì„±/ìˆ˜ì •) -->
      <div id="sheetInputMode" class="w-[72%] hidden overflow-y-auto no-scrollbar">
        <div class="grid grid-cols-2 gap-2">
          <div class="col-span-2">
            <label class="text-[11px] text-gray-400">ì œëª©</label>
            <input id="inTitle" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-2 py-1 text-sm outline-none" />
          </div>

          <div class="col-span-2">
            <label class="text-[11px] text-gray-400">ìš”ì•½</label>
            <textarea id="inDesc" rows="2" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-2 py-1 text-sm outline-none"></textarea>
          </div>

          <div>
            <label class="text-[11px] text-gray-400">ê²ŒìŠ¤íŠ¸(,ë¡œ êµ¬ë¶„)</label>
            <input id="inCeleb" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-2 py-1 text-sm outline-none" />
          </div>

          <div>
            <label class="text-[11px] text-gray-400">í…Œë§ˆ</label>
            <select id="inTheme" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-2 py-1 text-sm outline-none">
              <option value="">(ì—†ìŒ)</option>
              <option value="ìŒì‹">ìŒì‹</option>
              <option value="ë¬¸í™”">ë¬¸í™”</option>
              <option value="ìŒì•…">ìŒì•…</option>
            </select>
          </div>

          <div class="col-span-2">
            <label class="text-[11px] text-gray-400">íƒœê·¸(#ì—†ì´ ,ë¡œ)</label>
            <input id="inTags" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-2 py-1 text-sm outline-none" />
          </div>

          <div class="col-span-2">
            <label class="text-[11px] text-gray-400">ì´ë¯¸ì§€ URL(ì„ íƒ)</label>
            <input id="inImg" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-2 py-1 text-sm outline-none" />
          </div>
        </div>

        <div class="mt-2 flex gap-2 flex-wrap">
          <button id="btnSaveMemo" class="text-xs px-3 py-1 rounded-lg bg-blue-600 hover:bg-blue-500 border border-blue-400/30">ì €ì¥</button>
          <button id="btnDeleteMemo" class="text-xs px-3 py-1 rounded-lg bg-rose-700 hover:bg-rose-600 border border-rose-400/30">ì‚­ì œ</button>
          <button id="btnCancelInput" class="text-xs px-3 py-1 rounded-lg bg-gray-800 hover:bg-gray-700 border border-gray-600">ì·¨ì†Œ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

  <script>
    /******************************************************************
     * #upgrade: ë©”ì¸ ìƒíƒœ/ìŠ¤í† ë¦¬ì§€ í‚¤(ë³€ë™ì„± ì¤„ì´ê¸°: ì „ì—­ ì„ ì–¸)
     ******************************************************************/
    const STORAGE = {
      MEMOS: "eventmap2.memos",
      SEARCH_HISTORY: "eventmap2.searchHistory",
      CUSTOM_TAGS: "eventmap2.customTags",
      TAG_OVERRIDES: "eventmap2.tagOverrides",          // { [eventId]: ["tag1","tag2"] }
      COLOR_LEVELS: "eventmap2.colorLevels"             // { [id]: -3..+3 }
    };

    const THEMES = ["ìŒì‹","ë¬¸í™”","ìŒì•…"];
    const MAX_RECENT = 5;

    let map;
    let cluster;
    let currentCountry = "Korea"; // Korea | Japan | Memo
    let currentSubFilter = "ì „ì²´"; // region/theme/tag/memoName filter
    let searchQuery = "";

    // ì„ íƒ(Alt+Drag)
    let selectionBoxEl;
    let isSelecting = false;
    let selectStart = null; // L.Point
    let selectedIds = new Set(); // marker ids (event.id or memo.id)

    // ë§ˆì»¤ ê´€ë¦¬
    const markerById = new Map(); // id -> L.Marker
    let regionGlowLayer = null;   // L.GeoJSON layer

    // GeoJSON ìºì‹œ
    let geoCache = { Korea: null, Japan: null };

    /******************************************************************
     * #upgrade: mockEvents(ìš”êµ¬: í•œêµ­ 24ê°œ + ì¼ë³¸ 13ê°œ)
     * - ì‹¤ì œ ë°ì´í„° ì—°ë™(TourAPI/Jalan)ì€ ì„œë²„/í‚¤ í•„ìš”í•˜ë¯€ë¡œ êµ¬ì¡°ë§Œ ìœ ì§€.
     ******************************************************************/
    const mockEvents = [
      // ---- Korea (24) ----
      { id: 1,  title:"ì„œìš¸ ì„¸ê³„ ë¶ˆê½ƒì¶•ì œ", lat:37.528, lng:126.934, country:"Korea", region:"ì„œìš¸", tags:["ë¶ˆê½ƒ","ì•¼ê²½","í•œê°•"], theme:"ë¬¸í™”", celeb:["ë¶ˆê½ƒë””ìì´ë„ˆ"], imageUrl:"https://source.unsplash.com/256x256/?fireworks,seoul", summary:"ì—¬ì˜ë„ í•œê°•ê³µì› ê°€ì„ ë¶ˆê½ƒ í–‰ì‚¬", color:"#3b82f6" },
      { id: 2,  title:"ë¶€ì‚° êµ­ì œ ì˜í™”ì œ", lat:35.171, lng:129.127, country:"Korea", region:"ë¶€ì‚°", tags:["ì˜í™”","ë¬¸í™”","í•´ìš´ëŒ€"], theme:"ë¬¸í™”", celeb:["ì†¡ê°•í˜¸","íƒ•ì›¨ì´"], imageUrl:"https://source.unsplash.com/256x256/?cinema,busan", summary:"ì•„ì‹œì•„ ëŒ€í‘œ ì˜í™”ì œ", color:"#8b5cf6" },
      { id: 3,  title:"ë³´ë ¹ ë¨¸ë“œ ì¶•ì œ", lat:36.309, lng:126.516, country:"Korea", region:"ì¶©ë‚¨", tags:["ì•¡í‹°ë¹„í‹°","ì—¬ë¦„","í•´ë³€"], theme:"ë¬¸í™”", celeb:["ì‹¸ì´"], imageUrl:"https://source.unsplash.com/256x256/?mud,festival", summary:"ëŒ€ì²œí•´ìˆ˜ìš•ì¥ ë¨¸ë“œ ì²´í—˜", color:"#22c55e" },
      { id: 4,  title:"ì „ì£¼ ë¹„ë¹”ë°¥ ì¶•ì œ", lat:35.814, lng:127.153, country:"Korea", region:"ì „ë¶", tags:["ìŒì‹","ì „í†µ","ë¯¸ì‹"], theme:"ìŒì‹", celeb:["ë°±ì¢…ì›"], imageUrl:"https://source.unsplash.com/256x256/?bibimbap", summary:"ì „ì£¼ ëŒ€í‘œ ìŒì‹ ì¶•ì œ", color:"#f59e0b" },
      { id: 5,  title:"ì§„í•´ êµ°í•­ì œ", lat:35.150, lng:128.665, country:"Korea", region:"ê²½ë‚¨", tags:["ë²šê½ƒ","ë´„","ì‚¬ì§„"], theme:"ë¬¸í™”", celeb:["ë¡œì´í‚´"], imageUrl:"https://source.unsplash.com/256x256/?cherryblossom,korea", summary:"êµ­ë‚´ ìµœëŒ€ ë²šê½ƒ ì¶•ì œ", color:"#ec4899" },
      { id: 6,  title:"ìë¼ì„¬ ì¬ì¦ˆí˜ìŠ¤í‹°ë²Œ", lat:37.817, lng:127.514, country:"Korea", region:"ê²½ê¸°", tags:["ìŒì•…","ì¬ì¦ˆ","ìº í•‘"], theme:"ìŒì•…", celeb:["ë‚˜ìœ¤ì„ "], imageUrl:"https://source.unsplash.com/256x256/?jazz,festival", summary:"ìì—° ì† ì¬ì¦ˆ", color:"#06b6d4" },
      { id: 7,  title:"ê°•ë¦‰ ì»¤í”¼ ì¶•ì œ", lat:37.751, lng:128.876, country:"Korea", region:"ê°•ì›", tags:["ì»¤í”¼","ë°”ë‹¤","ì¹´í˜"], theme:"ìŒì‹", celeb:["ë°”ë¦¬ìŠ¤íƒ€"], imageUrl:"https://source.unsplash.com/256x256/?coffee,beach", summary:"ì•ˆëª© ì»¤í”¼ê±°ë¦¬ ì¤‘ì‹¬", color:"#a16207" },
      { id: 8,  title:"ì•ˆë™ êµ­ì œ íƒˆì¶¤ í˜ìŠ¤í‹°ë²Œ", lat:36.568, lng:128.729, country:"Korea", region:"ê²½ë¶", tags:["ì „í†µ","ê³µì—°","íƒˆì¶¤"], theme:"ë¬¸í™”", celeb:["í•˜íšŒíƒˆíŒ€"], imageUrl:"https://source.unsplash.com/256x256/?traditional,korea", summary:"íƒˆì¶¤/ì „í†µ ê³µì—°", color:"#f97316" },
      { id: 9,  title:"ì¶˜ì²œ ë§ˆì„ì¶•ì œ", lat:37.881, lng:127.729, country:"Korea", region:"ê°•ì›", tags:["ê³µì—°","ê±°ë¦¬ì˜ˆìˆ "], theme:"ë¬¸í™”", celeb:["ë§ˆì„íŒ€"], imageUrl:"https://source.unsplash.com/256x256/?street,performance", summary:"ë„ì‹œ ì „ì²´ê°€ ë¬´ëŒ€", color:"#10b981" },
      { id: 10, title:"ì²­ì£¼ ê³µì˜ˆë¹„ì—”ë‚ ë ˆ", lat:36.642, lng:127.489, country:"Korea", region:"ì¶©ë¶", tags:["ê³µì˜ˆ","ì „ì‹œ"], theme:"ë¬¸í™”", celeb:["íë ˆì´í„°"], imageUrl:"https://source.unsplash.com/256x256/?craft,exhibition", summary:"ê³µì˜ˆ/ë””ìì¸ ì „ì‹œ", color:"#6366f1" },
      { id: 11, title:"ëª©í¬ í•­êµ¬ì¶•ì œ", lat:34.811, lng:126.392, country:"Korea", region:"ì „ë‚¨", tags:["í•­êµ¬","ìŒì‹","ë°”ë‹¤"], theme:"ìŒì‹", celeb:["ì…°í”„"], imageUrl:"https://source.unsplash.com/256x256/?seafood,market", summary:"í•­êµ¬ ë„ì‹œ ì¶•ì œ", color:"#0ea5e9" },
      { id: 12, title:"ê´‘ì£¼ ë¹„ì—”ë‚ ë ˆ(ë¬¸í™”í–‰ì‚¬)", lat:35.160, lng:126.851, country:"Korea", region:"ì „ë‚¨", tags:["ì „ì‹œ","ì˜ˆìˆ "], theme:"ë¬¸í™”", celeb:["ì•„í‹°ìŠ¤íŠ¸"], imageUrl:"https://source.unsplash.com/256x256/?art,gallery", summary:"í˜„ëŒ€ë¯¸ìˆ  í–‰ì‚¬", color:"#a855f7" },
      { id: 13, title:"ëŒ€êµ¬ ì¹˜ë§¥í˜ìŠ¤í‹°ë²Œ", lat:35.871, lng:128.601, country:"Korea", region:"ê²½ë¶", tags:["ì¹˜í‚¨","ë§¥ì£¼","ìŒì‹"], theme:"ìŒì‹", celeb:["DJ"], imageUrl:"https://source.unsplash.com/256x256/?chicken,beer", summary:"ì—¬ë¦„ ì•¼ì™¸ ë¨¹ê±°ë¦¬", color:"#f59e0b" },
      { id: 14, title:"ì œì£¼ ë“¤ë¶ˆì¶•ì œ", lat:33.450, lng:126.570, country:"Korea", region:"ì œì£¼", tags:["ë¶ˆ","ì „í†µ"], theme:"ë¬¸í™”", celeb:["í•´ì„¤ê°€"], imageUrl:"https://source.unsplash.com/256x256/?bonfire,jeju", summary:"ì œì£¼ ë´„ ì „í†µ í–‰ì‚¬", color:"#ef4444" },
      { id: 15, title:"ì„œê·€í¬ ìœ ì±„ê½ƒ ì¶•ì œ", lat:33.254, lng:126.560, country:"Korea", region:"ì œì£¼", tags:["ê½ƒ","ë´„","ì‚¬ì§„"], theme:"ë¬¸í™”", celeb:["í¬í† ê·¸ë˜í¼"], imageUrl:"https://source.unsplash.com/256x256/?flowers,jeju", summary:"ìœ ì±„ê½ƒ ëª…ì†Œ", color:"#22c55e" },
      { id: 16, title:"ëŒ€ì „ ê³¼í•™ì¶•ì œ", lat:36.350, lng:127.384, country:"Korea", region:"ì¶©ë‚¨", tags:["ê³¼í•™","ì²´í—˜"], theme:"ë¬¸í™”", celeb:["ê³¼í•™ì»¤ë®¤ë‹ˆì¼€ì´í„°"], imageUrl:"https://source.unsplash.com/256x256/?science,expo", summary:"ì²´í—˜í˜• ê³¼í•™ í–‰ì‚¬", color:"#3b82f6" },
      { id: 17, title:"ìˆ˜ì› í™”ì„±ë¬¸í™”ì œ", lat:37.286, lng:127.009, country:"Korea", region:"ê²½ê¸°", tags:["ì „í†µ","ì„±ê³½"], theme:"ë¬¸í™”", celeb:["ê³µì—°íŒ€"], imageUrl:"https://source.unsplash.com/256x256/?fortress,korea", summary:"í™”ì„± ì„±ê³½ ë¬¸í™”í–‰ì‚¬", color:"#f97316" },
      { id: 18, title:"ì¸ì²œ íœíƒ€í¬íŠ¸ ë½ í˜ìŠ¤í‹°ë²Œ", lat:37.400, lng:126.650, country:"Korea", region:"ê²½ê¸°", tags:["ìŒì•…","ë½"], theme:"ìŒì•…", celeb:["ë°´ë“œ"], imageUrl:"https://source.unsplash.com/256x256/?rock,concert", summary:"ë½ í˜ìŠ¤í‹°ë²Œ", color:"#06b6d4" },
      { id: 19, title:"ì•„ì‚° ì˜¨ì²œë¬¸í™”ì¶•ì œ", lat:36.790, lng:127.000, country:"Korea", region:"ì¶©ë‚¨", tags:["ì˜¨ì²œ","íë§"], theme:"ë¬¸í™”", celeb:["ê°€ìˆ˜"], imageUrl:"https://source.unsplash.com/256x256/?hot,spring", summary:"ì˜¨ì²œ/ë¬¸í™”", color:"#0ea5e9" },
      { id: 20, title:"ì¶©ì£¼ ì„¸ê³„ë¬´ìˆ ì¶•ì œ", lat:36.991, lng:127.925, country:"Korea", region:"ì¶©ë¶", tags:["ë¬´ìˆ ","ê³µì—°"], theme:"ë¬¸í™”", celeb:["ì‹œë²”ë‹¨"], imageUrl:"https://source.unsplash.com/256x256/?martial,arts", summary:"ì„¸ê³„ ë¬´ìˆ  ì²´í—˜", color:"#8b5cf6" },
      { id: 21, title:"ì—¬ìˆ˜ ë°¤ë°”ë‹¤ ë¶ˆê½ƒ/ë¹› í–‰ì‚¬(í…Œë§ˆ)", lat:34.760, lng:127.662, country:"Korea", region:"ì „ë‚¨", tags:["ì•¼ê²½","ë¹›"], theme:"ë¬¸í™”", celeb:["ê°€ìˆ˜"], imageUrl:"https://source.unsplash.com/256x256/?night,lights", summary:"ì•¼ê°„ í…Œë§ˆ í–‰ì‚¬", color:"#ec4899" },
      { id: 22, title:"êµ°ì‚° ì‹œê°„ì—¬í–‰ ì¶•ì œ", lat:35.967, lng:126.736, country:"Korea", region:"ì „ë¶", tags:["ê·¼ëŒ€","ë„ì‹œ"], theme:"ë¬¸í™”", celeb:["í•´ì„¤ì‚¬"], imageUrl:"https://source.unsplash.com/256x256/?vintage,street", summary:"ê·¼ëŒ€ë¬¸í™” í…Œë§ˆ", color:"#f59e0b" },
      { id: 23, title:"í†µì˜ êµ­ì œìŒì•…ì œ(í…Œë§ˆ)", lat:34.854, lng:128.433, country:"Korea", region:"ê²½ë‚¨", tags:["ìŒì•…","í´ë˜ì‹"], theme:"ìŒì•…", celeb:["ì—°ì£¼ì"], imageUrl:"https://source.unsplash.com/256x256/?orchestra,concert", summary:"ìŒì•… í–‰ì‚¬", color:"#06b6d4" },
      { id: 24, title:"ìš¸ì‚° ê³ ë˜ì¶•ì œ(í…Œë§ˆ)", lat:35.538, lng:129.311, country:"Korea", region:"ë¶€ì‚°", tags:["ë°”ë‹¤","í¼ë ˆì´ë“œ"], theme:"ë¬¸í™”", celeb:["MC"], imageUrl:"https://source.unsplash.com/256x256/?parade,sea", summary:"í•´ì–‘ í…Œë§ˆ í–‰ì‚¬", color:"#22c55e" },

      // ---- Japan (13) ----
      { id: 101, title:"ê¸°ì˜¨ ë§ˆì¸ ë¦¬", lat:35.003, lng:135.768, country:"Japan", region:"êµí† ", tags:["ì „í†µ","ë§ˆì¸ ë¦¬","ì—¬ë¦„"], theme:"ë¬¸í™”", celeb:["êµí† "], imageUrl:"https://source.unsplash.com/256x256/?kyoto,festival", summary:"ì¼ë³¸ 3ëŒ€ ë§ˆì¸ ë¦¬", color:"#f59e0b" },
      { id: 102, title:"ì‚¿í¬ë¡œ ëˆˆ ì¶•ì œ", lat:43.061, lng:141.354, country:"Japan", region:"í™‹ì¹´ì´ë„", tags:["ê²¨ìš¸","ëˆˆ","ì¡°ê°"], theme:"ë¬¸í™”", celeb:["ìœ í‚¤ë¯¸ì¿ "], imageUrl:"https://source.unsplash.com/256x256/?sapporo,snow", summary:"ëˆˆ ì¡°ê° ì „ì‹œ", color:"#0ea5e9" },
      { id: 103, title:"ìŠ¤ë¯¸ë‹¤ê°• ë¶ˆê½ƒë†€ì´", lat:35.710, lng:139.796, country:"Japan", region:"ë„ì¿„", tags:["ë¶ˆê½ƒ","ì—¬ë¦„","ìœ ì¹´íƒ€"], theme:"ë¬¸í™”", celeb:[], imageUrl:"https://source.unsplash.com/256x256/?tokyo,fireworks", summary:"ë„ì¿„ ë¶ˆê½ƒë†€ì´", color:"#ef4444" },
      { id: 104, title:"í…ì§„ ë§ˆì¸ ë¦¬", lat:34.696, lng:135.519, country:"Japan", region:"ì˜¤ì‚¬ì¹´", tags:["ë§ˆì¸ ë¦¬","ë°°","ë¶ˆê½ƒ"], theme:"ë¬¸í™”", celeb:[], imageUrl:"https://source.unsplash.com/256x256/?osaka,festival", summary:"ë¬¼ê³¼ ë¶ˆì˜ ì¶•ì œ", color:"#f97316" },
      { id: 105, title:"ë‚˜í•˜ ëŒ€ì¤„ë‹¤ë¦¬ê¸°", lat:26.212, lng:127.679, country:"Japan", region:"ì˜¤í‚¤ë‚˜ì™€", tags:["ì „í†µ","ì•¡í‹°ë¹„í‹°"], theme:"ë¬¸í™”", celeb:[], imageUrl:"https://source.unsplash.com/256x256/?okinawa,festival", summary:"ëŒ€í˜• ì¤„ë‹¤ë¦¬ê¸°", color:"#22c55e" },
      { id: 106, title:"í›„ì¿ ì˜¤ì¹´ í•˜ì¹´íƒ€ ê¸°ì˜¨ ì•¼ë§ˆì¹´ì‚¬", lat:33.590, lng:130.401, country:"Japan", region:"í›„ì¿ ì˜¤ì¹´", tags:["ì „í†µ","ë ˆì´ìŠ¤"], theme:"ë¬¸í™”", celeb:[], imageUrl:"https://source.unsplash.com/256x256/?fukuoka,festival", summary:"ì•¼ë§ˆì¹´ì‚¬", color:"#8b5cf6" },
      { id: 107, title:"ë„ì¿„ ì½”ë¯¸ì¼€(í…Œë§ˆ)", lat:35.629, lng:139.797, country:"Japan", region:"ë„ì¿„", tags:["ì„œë¸Œì»¬ì²˜","í–‰ì‚¬"], theme:"ë¬¸í™”", celeb:[], imageUrl:"https://source.unsplash.com/256x256/?anime,event", summary:"ëŒ€í˜• ë™ì¸ì§€ í–‰ì‚¬", color:"#3b82f6" },
      { id: 108, title:"ì˜¤ì‚¬ì¹´ ì•¼í‚¤ë‹ˆì¿ /ë¯¸ì‹(í…Œë§ˆ)", lat:34.693, lng:135.502, country:"Japan", region:"ì˜¤ì‚¬ì¹´", tags:["ìŒì‹","ë¯¸ì‹"], theme:"ìŒì‹", celeb:[], imageUrl:"https://source.unsplash.com/256x256/?japanese,food", summary:"ë¯¸ì‹ í…Œë§ˆ", color:"#f59e0b" },
      { id: 109, title:"êµí†  ë‹¨í’ ë¼ì´íŠ¸ì—…(í…Œë§ˆ)", lat:35.011, lng:135.768, country:"Japan", region:"êµí† ", tags:["ë‹¨í’","ì•¼ê°„"], theme:"ë¬¸í™”", celeb:[], imageUrl:"https://source.unsplash.com/256x256/?kyoto,autumn", summary:"ì•¼ê°„ ë¼ì´íŠ¸ì—…", color:"#ef4444" },
      { id: 110, title:"í™‹ì¹´ì´ë„ ë¼ë©˜(í…Œë§ˆ)", lat:43.062, lng:141.354, country:"Japan", region:"í™‹ì¹´ì´ë„", tags:["ìŒì‹","ë¼ë©˜"], theme:"ìŒì‹", celeb:[], imageUrl:"https://source.unsplash.com/256x256/?ramen", summary:"ë¯¸ì‹ í…Œë§ˆ", color:"#f97316" },
      { id: 111, title:"í›„ì¿ ì˜¤ì¹´ ì¬ì¦ˆ/ë¼ì´ë¸Œ(í…Œë§ˆ)", lat:33.594, lng:130.401, country:"Japan", region:"í›„ì¿ ì˜¤ì¹´", tags:["ìŒì•…","ë¼ì´ë¸Œ"], theme:"ìŒì•…", celeb:[], imageUrl:"https://source.unsplash.com/256x256/?live,music", summary:"ë¼ì´ë¸Œ ê³µì—°", color:"#06b6d4" },
      { id: 112, title:"ë„ì¿„ í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ë§ˆì¼“(í…Œë§ˆ)", lat:35.676, lng:139.650, country:"Japan", region:"ë„ì¿„", tags:["ë§ˆì¼“","ê²¨ìš¸"], theme:"ë¬¸í™”", celeb:[], imageUrl:"https://source.unsplash.com/256x256/?christmas,market", summary:"ê²¨ìš¸ ë§ˆì¼“", color:"#22c55e" },
      { id: 113, title:"ì˜¤í‚¤ë‚˜ì™€ ë°”ë‹¤/ìŠ¤ë…¸í´(í…Œë§ˆ)", lat:26.212, lng:127.680, country:"Japan", region:"ì˜¤í‚¤ë‚˜ì™€", tags:["ë°”ë‹¤","ì•¡í‹°ë¹„í‹°"], theme:"ë¬¸í™”", celeb:[], imageUrl:"https://source.unsplash.com/256x256/?snorkeling,sea", summary:"ë°”ë‹¤ ì•¡í‹°ë¹„í‹°", color:"#0ea5e9" }
    ];

    /******************************************************************
     * #upgrade: Memo ë°ì´í„°(ë¡œì»¬ìŠ¤í† ë¦¬ì§€)
     ******************************************************************/
    function loadMemos() {
      try { return JSON.parse(localStorage.getItem(STORAGE.MEMOS) || "[]"); }
      catch { return []; }
    }
    function saveMemos(memos) {
      localStorage.setItem(STORAGE.MEMOS, JSON.stringify(memos));
    }

    /******************************************************************
     * #upgrade: íƒœê·¸ override / ìƒ‰ ë ˆë²¨ ì €ì¥(ì„ íƒ/ë¼ë²¨ ê¸°ëŠ¥)
     ******************************************************************/
    function loadTagOverrides() {
      try { return JSON.parse(localStorage.getItem(STORAGE.TAG_OVERRIDES) || "{}"); }
      catch { return {}; }
    }
    function saveTagOverrides(obj) {
      localStorage.setItem(STORAGE.TAG_OVERRIDES, JSON.stringify(obj));
    }
    function loadColorLevels() {
      try { return JSON.parse(localStorage.getItem(STORAGE.COLOR_LEVELS) || "{}"); }
      catch { return {}; }
    }
    function saveColorLevels(obj) {
      localStorage.setItem(STORAGE.COLOR_LEVELS, JSON.stringify(obj));
    }

    /******************************************************************
     * #upgrade: ìµœê·¼ ê²€ìƒ‰ì–´(5ê°œ)
     ******************************************************************/
    function loadSearchHistory() {
      try { return JSON.parse(localStorage.getItem(STORAGE.SEARCH_HISTORY) || "[]"); }
      catch { return []; }
    }
    function pushSearchHistory(q) {
      if (!q) return;
      const list = loadSearchHistory().filter(x => x !== q);
      list.unshift(q);
      while (list.length > MAX_RECENT) list.pop();
      localStorage.setItem(STORAGE.SEARCH_HISTORY, JSON.stringify(list));
      renderRecentSearchRow();
    }
    function renderRecentSearchRow() {
      const row = document.getElementById("recentSearchRow");
      const list = loadSearchHistory();
      row.innerHTML = "";
      list.forEach(q => {
        const b = document.createElement("button");
        b.className = "text-xs px-2 py-1 rounded-full bg-gray-800/80 hover:bg-gray-700 border border-gray-700 text-gray-200";
        b.textContent = q;
        b.onclick = () => {
          document.getElementById("searchInput").value = q;
          applySearchFilter(q);
        };
        row.appendChild(b);
      });
    }

    /******************************************************************
     * #upgrade: ë§ˆì»¤ ì•„ì´ì½˜ ìƒì„±(ë©”ì¸ ì¸ì: item, selected, colorLevel)
     ******************************************************************/
    function buildMarkerIcon(item, selected, colorLevel) {
      const level = Math.max(-3, Math.min(3, colorLevel || 0));
      const brightness = 100 + (level * 10);
      const saturate = 110 + (level * 8);

      const isMemo = item.country === "Memo";
      const border = isMemo ? "rgba(148,163,184,0.95)" : "rgba(255,255,255,0.92)";
      const fallbackImg = "https://source.unsplash.com/256x256/?map,marker";
      const img = item.imageUrl || fallbackImg;

      const wrapClass = selected ? "marker-wrap marker-selected" : "marker-wrap";

      const html =
        `<div class="${wrapClass}" style="border-color:${border}">
           <img class="marker-img" src="${img}" alt=""
                style="filter: brightness(${brightness}%) saturate(${saturate}%);" />
         </div>`;

      return L.divIcon({
        className: "custom-div-icon",
        html,
        iconSize: [64, 64],
        iconAnchor: [32, 32]
      });
    }

    /******************************************************************
     * #upgrade: ì§€ë„ ì´ˆê¸°í™”(ë©”ì¸ ë¡œì§)
     ******************************************************************/
    function initializeMap() {
      map = L.map("map", { zoomControl: false }).setView([35.9, 127.5], 7);

      // OSM íƒ€ì¼ + CSS í•„í„°ë¡œ ë‹¤í¬ ê³ ì •
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(map);

      // MarkerCluster (count <5 ì´ˆë¡, <10 ë…¸ë‘, >=10 ë¹¨ê°•)
      cluster = L.markerClusterGroup({
        iconCreateFunction: function(c) {
          const count = c.getChildCount();
          let cls = "marker-cluster-small";
          if (count >= 10) cls = "cluster-high-density";
          else if (count >= 5) cls = "marker-cluster-medium";

          return new L.DivIcon({
            html: `<div style="width:40px;height:40px;border-radius:9999px;display:flex;align-items:center;justify-content:center;color:white;font-weight:800;">
                    <span>${count}</span>
                  </div>`,
            className: cls,
            iconSize: new L.Point(40, 40)
          });
        }
      });
      map.addLayer(cluster);

      // #upgrade: Memo ìƒì„±(ì§€ë„ í´ë¦­) - Memo ëª¨ë“œì—ì„œë§Œ
      map.on("click", (e) => {
        if (currentCountry !== "Memo") return;
        createMemoAt(e.latlng);
      });

      loadEventMarkers();
    }

    /******************************************************************
     * #upgrade: ì´ë²¤íŠ¸/ë©”ëª¨ ë§ˆì»¤ ë¡œë“œ(ë©”ì¸ ì¸ì: currentCountry, filter, searchQuery)
     ******************************************************************/
    function getDatasetForCurrentCountry() {
      if (currentCountry === "Memo") return loadMemos().map(m => ({ ...m, country: "Memo" }));
      return mockEvents.filter(x => x.country === currentCountry);
    }

    function normalize(s) { return (s || "").toString().trim().toLowerCase(); }

    function getMergedTags(item) {
      const overrides = loadTagOverrides();
      const add = overrides[item.id] || [];
      const base = Array.isArray(item.tags) ? item.tags : [];
      const merged = [...new Set([...base, ...add])];
      return merged;
    }

    function matchesSearch(item, q) {
      if (!q) return true;
      const nq = normalize(q);
      const tags = getMergedTags(item).join(" ");
      const hay = normalize([item.title, item.region, item.country, item.theme, tags, item.summary].join(" "));
      return hay.includes(nq);
    }

    function matchesSubFilter(item, f) {
      if (!f || f === "ì „ì²´") return true;

      // Memo ëª¨ë“œ: fê°€ "ìŒì‹/ë¬¸í™”/ìŒì•…"ì´ë©´ themeë¡œ ë§¤ì¹­
      if (currentCountry === "Memo" && THEMES.includes(f)) {
        return item.theme === f;
      }

      // Memo ëª¨ë“œ: "íƒœê·¸:xxx", "ë©”ëª¨:yyy"
      if (currentCountry === "Memo") {
        if (f.startsWith("íƒœê·¸:")) {
          const t = f.slice(3);
          return getMergedTags(item).includes(t);
        }
        if (f.startsWith("ë©”ëª¨:")) {
          const name = f.slice(3);
          return (item.title || "") === name;
        }
      }

      // Korea/Japan: region ë²„íŠ¼
      return item.region === f;
    }

    function loadEventMarkers() {
      cluster.clearLayers();
      markerById.clear();

      const levels = loadColorLevels();
      const dataset = getDatasetForCurrentCountry();

      dataset.forEach(item => {
        if (!matchesSubFilter(item, currentSubFilter)) return;
        if (!matchesSearch(item, searchQuery)) return;

        const isSelected = selectedIds.has(item.id);
        const icon = buildMarkerIcon(item, isSelected, levels[item.id]);

        const marker = L.marker([item.lat, item.lng], { icon });
        marker.featureData = item;

        marker.on("click", () => {
          showDetailSheet(item, false);
          map.panTo([item.lat, item.lng], { animate: true, duration: 0.5 });
        });

        markerById.set(item.id, marker);
        cluster.addLayer(marker);
      });

      updateSelectionActionBar();
    }

    /******************************************************************
     * #upgrade: êµ­ê°€ íƒ­(ë©”ì¸ ì¸ì: country)
     ******************************************************************/
    function setCountry(country) {
      currentCountry = country;
      currentSubFilter = "ì „ì²´";
      searchQuery = document.getElementById("searchInput").value || "";

      // íƒ­ ìŠ¤íƒ€ì¼
      ["Korea","Japan","Memo"].forEach(c => {
        const btn = document.getElementById(`btn-${c}`);
        const active = (c === country);
        btn.className = active
          ? "px-4 py-1.5 rounded-full text-sm font-semibold bg-blue-600 text-white border border-blue-400/40 transition-all"
          : "px-4 py-1.5 rounded-full text-sm font-semibold bg-gray-800 text-gray-400 hover:bg-gray-700 border border-gray-600 transition-all";
      });

      // Memo 2ì¤„ í•„í„° on/off
      document.getElementById("subTabContainer2").classList.toggle("hidden", country !== "Memo");

      // region glow ì œê±°
      clearRegionGlow();

      // ì„ íƒ ì´ˆê¸°í™”(êµ­ê°€ ë³€ê²½ ì‹œ)
      deselectAll();

      renderSubTabs();
      loadEventMarkers();

      // êµ­ê°€ë³„ ì´ë™
      if (country === "Korea") map.flyTo([35.9, 127.5], 7);
      if (country === "Japan") map.flyTo([36.2048, 138.2529], 6);
      if (country === "Memo") map.flyTo([35.9, 127.5], 7);
    }

    /******************************************************************
     * #upgrade: 3ë‹¨ íƒ­ ë Œë”ë§
     ******************************************************************/
    function mkChip(label, onClick) {
      const b = document.createElement("button");
      b.className = "px-3 py-1 bg-gray-800/80 backdrop-blur text-gray-300 text-xs rounded-lg border border-gray-600 hover:bg-gray-700 whitespace-nowrap transition-colors";
      b.textContent = label;
      b.onclick = onClick;
      return b;
    }

    function renderSubTabs() {
      const c1 = document.getElementById("subTabContainer");
      const c2 = document.getElementById("subTabContainer2");
      c1.innerHTML = "";
      c2.innerHTML = "";

      if (currentCountry === "Korea") {
        const regions = ["ì „ì²´","ì„œìš¸","ê²½ê¸°","ê°•ì›","ì¶©ë‚¨","ì¶©ë¶","ì „ë¶","ì „ë‚¨","ê²½ë¶","ê²½ë‚¨","ë¶€ì‚°","ì œì£¼"];
        regions.forEach(r => c1.appendChild(mkChip(r, () => applySubFilter(r, true))));
      } else if (currentCountry === "Japan") {
        const regions = ["ì „ì²´","ë„ì¿„","ì˜¤ì‚¬ì¹´","êµí† ","í›„ì¿ ì˜¤ì¹´","í™‹ì¹´ì´ë„","ì˜¤í‚¤ë‚˜ì™€"];
        regions.forEach(r => c1.appendChild(mkChip(r, () => applySubFilter(r, true))));
      } else {
        // Memo: 1ì¤„=í…Œë§ˆ + ë¼ë²¨ì¶”ê°€
        c1.appendChild(mkChip("ì „ì²´", () => applySubFilter("ì „ì²´", false)));
        THEMES.forEach(t => c1.appendChild(mkChip(t, () => applySubFilter(t, false))));
        c1.appendChild(mkChip("+ ë¼ë²¨ ì¶”ê°€", () => addCustomLabelPrompt()));

        // Memo: 2ì¤„=íƒœê·¸/ë©”ëª¨ëª…
        const memos = loadMemos();
        const tags = new Set();
        memos.forEach(m => (m.tags || []).forEach(t => tags.add(t)));
        [...tags].slice(0, 24).forEach(t => c2.appendChild(mkChip(`íƒœê·¸:${t}`, () => applySubFilter(`íƒœê·¸:${t}`, false))));
        memos.slice(0, 24).forEach(m => c2.appendChild(mkChip(`ë©”ëª¨:${m.title || "ë¬´ì œ"}`, () => applySubFilter(`ë©”ëª¨:${m.title || "ë¬´ì œ"}`, false))));
      }
    }

    function applySubFilter(filter, maybeGlow) {
      currentSubFilter = filter;

      // #upgrade: ì§€ì—­ íƒ­ í´ë¦­ ì‹œ í´ë¦¬ê³¤ ë°œê´‘
      if (maybeGlow && filter !== "ì „ì²´") {
        showRegionGlow(filter);
      } else {
        clearRegionGlow();
      }

      loadEventMarkers();
    }

    function addCustomLabelPrompt() {
      const label = prompt("ìƒˆ ë¼ë²¨ ì´ë¦„(íƒœê·¸)ì„ ì…ë ¥:");
      if (!label) return;
      // Memoë“  Eventë“ : ì„ íƒëœ ë§ˆì»¤ì— íƒœê·¸ ì ìš©
      applyTagToSelected(label.trim());
      renderSubTabs();
      loadEventMarkers();
    }

    /******************************************************************
     * #upgrade: Region Glow(í´ë¦¬ê³¤) - GeoJSON ë¡œë“œ + ë§¤í•‘
     ******************************************************************/
    async function fetchGeoJsonWithFallback(urls) {
      for (const url of urls) {
        try {
          const r = await fetch(url, { cache: "force-cache" });
          if (!r.ok) continue;
          const j = await r.json();
          return j;
        } catch {}
      }
      return null;
    }

    function clearRegionGlow() {
      if (regionGlowLayer) {
        map.removeLayer(regionGlowLayer);
        regionGlowLayer = null;
      }
    }

    function getFeatureNameProps(p) {
      if (!p) return "";
      return [
        p.name, p.NAME_1, p.NAME, p.NL_NAME_1, p.ENG_NM,
        p.prefecture, p.prefecture_name, p.prefecture_en,
        p.prefecture_kanji, p.prefecture_romaji, p.nam, p.admin
      ].filter(Boolean).join(" ");
    }

    function matchRegionFeature(country, featureProps, region) {
      const text = normalize(getFeatureNameProps(featureProps));

      // Korea(í•œêµ­ì–´ ê¸°ì¤€)
      const KR = {
        "ì„œìš¸": ["seoul", "ì„œìš¸", "ì„œìš¸íŠ¹ë³„ì‹œ"],
        "ê²½ê¸°": ["gyeonggi", "ê²½ê¸°", "ê²½ê¸°ë„"],
        "ê°•ì›": ["gangwon", "ê°•ì›", "ê°•ì›ë„"],
        "ì¶©ë‚¨": ["chungcheongnam", "ì¶©ë‚¨", "ì¶©ì²­ë‚¨ë„"],
        "ì¶©ë¶": ["chungcheongbuk", "ì¶©ë¶", "ì¶©ì²­ë¶ë„"],
        "ì „ë¶": ["jeollabuk", "ì „ë¶", "ì „ë¼ë¶ë„"],
        "ì „ë‚¨": ["jeollanam", "ì „ë‚¨", "ì „ë¼ë‚¨ë„"],
        "ê²½ë¶": ["gyeongsangbuk", "ê²½ë¶", "ê²½ìƒë¶ë„"],
        "ê²½ë‚¨": ["gyeongsangnam", "ê²½ë‚¨", "ê²½ìƒë‚¨ë„"],
        "ë¶€ì‚°": ["busan", "ë¶€ì‚°", "ë¶€ì‚°ê´‘ì—­ì‹œ"],
        "ì œì£¼": ["jeju", "ì œì£¼", "ì œì£¼íŠ¹ë³„ìì¹˜ë„"]
      };

      const JP = {
        "ë„ì¿„": ["tokyo", "æ±äº¬"],
        "ì˜¤ì‚¬ì¹´": ["osaka", "å¤§é˜ª"],
        "êµí† ": ["kyoto", "äº¬éƒ½"],
        "í›„ì¿ ì˜¤ì¹´": ["fukuoka", "ç¦å²¡"],
        "í™‹ì¹´ì´ë„": ["hokkaido", "åŒ—æµ·é“"],
        "ì˜¤í‚¤ë‚˜ì™€": ["okinawa", "æ²–ç¸„"]
      };

      const dict = (country === "Korea") ? KR : JP;
      const keys = dict[region] || [region];
      return keys.some(k => text.includes(normalize(k)));
    }

    async function ensureGeoLoadedForCountry(country) {
      if (geoCache[country]) return geoCache[country];

      if (country === "Korea") {
        // southkorea-maps (provinces geojson)
        geoCache.Korea = await fetchGeoJsonWithFallback([
          "https://raw.githubusercontent.com/southkorea/southkorea-maps/master/gadm/json/skorea-provinces-geo.json",
          "https://raw.githubusercontent.com/southkorea/southkorea-maps/master/kostat/2013/json/skorea_provinces_geo_simple.json"
        ]);
      }
      if (country === "Japan") {
        // piuccio/open-data-jp-prefectures-geojson (output folder)
        geoCache.Japan = await fetchGeoJsonWithFallback([
          "https://raw.githubusercontent.com/piuccio/open-data-jp-prefectures-geojson/master/output/prefectures.geojson",
          "https://raw.githubusercontent.com/piuccio/open-data-jp-prefectures-geojson/master/output/prefectures.json",
          "https://raw.githubusercontent.com/piuccio/open-data-jp-prefectures-geojson/master/output/prefectures.geo.json"
        ]);
      }
      return geoCache[country];
    }

    async function showRegionGlow(regionName) {
      clearRegionGlow();

      const geo = await ensureGeoLoadedForCountry(currentCountry);
      if (!geo || !geo.features) return;

      const features = geo.features.filter(f => matchRegionFeature(currentCountry, f.properties, regionName));
      if (!features.length) return;

      regionGlowLayer = L.geoJSON({ type:"FeatureCollection", features }, {
        style: () => ({ color:"#ffeb3b", weight:3, opacity:0.95, fillOpacity:0.08, className:"region-glow-path" })
      }).addTo(map);

      try { map.fitBounds(regionGlowLayer.getBounds(), { padding:[40,40], animate:true }); } catch {}
    }

    /******************************************************************
     * #upgrade: Alt + Drag ì„ íƒ(Leaflet bounds.contains ì‚¬ìš©)
     ******************************************************************/
    function setupSelection() {
      selectionBoxEl = document.getElementById("selectionBox");
      const container = map.getContainer();

      const start = (ev) => {
        if (!ev.altKey || ev.button !== 0) return;
        isSelecting = true;
        map.dragging.disable();

        selectStart = map.mouseEventToContainerPoint(ev);
        selectionBoxEl.style.display = "block";
        selectionBoxEl.style.left = `${selectStart.x}px`;
        selectionBoxEl.style.top = `${selectStart.y}px`;
        selectionBoxEl.style.width = "0px";
        selectionBoxEl.style.height = "0px";
      };

      const move = (ev) => {
        if (!isSelecting) return;
        const p = map.mouseEventToContainerPoint(ev);
        const minX = Math.min(selectStart.x, p.x);
        const minY = Math.min(selectStart.y, p.y);
        const w = Math.abs(p.x - selectStart.x);
        const h = Math.abs(p.y - selectStart.y);

        selectionBoxEl.style.left = `${minX}px`;
        selectionBoxEl.style.top = `${minY}px`;
        selectionBoxEl.style.width = `${w}px`;
        selectionBoxEl.style.height = `${h}px`;
      };

      const end = (ev) => {
        if (!isSelecting) return;
        isSelecting = false;
        map.dragging.enable();
        selectionBoxEl.style.display = "none";

        const pEnd = map.mouseEventToContainerPoint(ev);

        // #upgrade: ì»¨í…Œì´ë„ˆ í¬ì¸íŠ¸ 2ê°œ -> LatLngBounds ë³€í™˜
        const p1 = L.point(selectStart.x, selectStart.y);
        const p2 = L.point(pEnd.x, pEnd.y);
        const sw = map.containerPointToLatLng(L.point(Math.min(p1.x,p2.x), Math.max(p1.y,p2.y)));
        const ne = map.containerPointToLatLng(L.point(Math.max(p1.x,p2.x), Math.min(p1.y,p2.y)));
        const bounds = L.latLngBounds(sw, ne);

        // ì„ íƒ(í† ê¸€ ì•„ë‹˜: ë“œë˜ê·¸ëŠ” "ì¶”ê°€ ì„ íƒ"ìœ¼ë¡œ)
        markerById.forEach((marker, id) => {
          const ll = marker.getLatLng();
          if (bounds.contains(ll)) {
            selectedIds.add(id);
          }
        });

        refreshSelectionStyles();
        updateSelectionActionBar();
      };

      container.addEventListener("mousedown", start);
      container.addEventListener("mousemove", move);
      container.addEventListener("mouseup", end);
      container.addEventListener("mouseleave", (ev) => { if (isSelecting) end(ev); });
    }

    function refreshSelectionStyles() {
      const levels = loadColorLevels();
      markerById.forEach((marker, id) => {
        const item = marker.featureData;
        const icon = buildMarkerIcon(item, selectedIds.has(id), levels[id]);
        marker.setIcon(icon);
      });
    }

    function deselectAll() {
      selectedIds.clear();
      refreshSelectionStyles();
      updateSelectionActionBar();
    }

    function updateSelectionActionBar() {
      const bar = document.getElementById("selectionActionBar");
      const cnt = selectedIds.size;
      document.getElementById("selectionCount").textContent = `ì„ íƒ ${cnt}`;
      const show = cnt > 0;

      bar.classList.toggle("opacity-0", !show);
      bar.classList.toggle("pointer-events-none", !show);
      bar.classList.toggle("translate-y-3", !show);
    }

    /******************************************************************
     * #upgrade: ì„ íƒëœ ë§ˆì»¤ ì•¡ì…˜(íƒœê·¸/ë°ê¸°)
     ******************************************************************/
    function applyTagToSelected(tag) {
      if (!tag) return;
      const t = tag.trim();
      if (!t) return;

      const overrides = loadTagOverrides();
      selectedIds.forEach(id => {
        overrides[id] = Array.from(new Set([...(overrides[id] || []), t]));
      });
      saveTagOverrides(overrides);
    }

    function adjustSelectedColorLevel(delta) {
      const levels = loadColorLevels();
      selectedIds.forEach(id => {
        const v = (levels[id] ?? 0) + delta;
        levels[id] = Math.max(-3, Math.min(3, v));
      });
      saveColorLevels(levels);
      refreshSelectionStyles();
    }

    /******************************************************************
     * #upgrade: ì‹¤ì‹œê°„ ê²€ìƒ‰(ì…ë ¥ ì´ë²¤íŠ¸) + ìµœê·¼ê²€ìƒ‰ ì €ì¥
     ******************************************************************/
    function applySearchFilter(q) {
      searchQuery = q || "";
      loadEventMarkers();
    }

    /******************************************************************
     * #upgrade: ë„¤ì´ë²„ ê²€ìƒ‰ + ë‚´ë¶€ í•„í„° ë™ì‹œ ì§€ì›
     * - Enter: form submit(ë„¤ì´ë²„)
     * - ì…ë ¥ì¤‘: ë‚´ë¶€í•„í„°
     ******************************************************************/
    function hookSearch() {
      const input = document.getElementById("searchInput");
      const internalBtn = document.getElementById("btnInternalSearch");
      const form = document.getElementById("naverForm");

      input.addEventListener("input", () => {
        applySearchFilter(input.value);
      });

      internalBtn.addEventListener("click", () => {
        pushSearchHistory(input.value.trim());
        applySearchFilter(input.value);
      });

      form.addEventListener("submit", () => {
        pushSearchHistory(input.value.trim());
      });
    }

    /******************************************************************
     * #upgrade: DetailSheet(View/Input ëª¨ë“œ ì „í™˜)
     ******************************************************************/
    let currentSheetItem = null;
    let currentSheetIsInput = false;

    function openSheet() {
      document.getElementById("detailSheet").classList.remove("translate-y-full");
    }
    function closeSheet() {
      document.getElementById("detailSheet").classList.add("translate-y-full");
      currentSheetItem = null;
      currentSheetIsInput = false;
    }

    function showDetailSheet(item, inputMode) {
      currentSheetItem = item;
      currentSheetIsInput = !!inputMode;

      const img = item.imageUrl || "https://source.unsplash.com/256x256/?festival";
      document.getElementById("sheetImage").src = img;

      const view = document.getElementById("sheetViewMode");
      const input = document.getElementById("sheetInputMode");

      view.classList.toggle("hidden", inputMode);
      input.classList.toggle("hidden", !inputMode);

      // View
      document.getElementById("sheetCountry").textContent = item.country;
      document.getElementById("sheetRegion").textContent = item.region || (item.country === "Memo" ? "ë©”ëª¨" : "");
      document.getElementById("sheetTitle").textContent = item.title || "(ë¬´ì œ)";
      document.getElementById("sheetDesc").textContent = item.summary || "";

      const celeb = (item.celeb || []).map(c => `<span class="bg-gray-800 px-2 py-1 rounded text-xs text-blue-300 border border-blue-900">${escapeHtml(c)}</span>`).join("");
      document.getElementById("sheetCeleb").innerHTML = celeb || `<span class="text-xs text-gray-500">(ì—†ìŒ)</span>`;

      const tags = getMergedTags(item).map(t => `<span class="text-gray-300 text-xs bg-gray-800/60 border border-gray-700 rounded-full px-2 py-0.5">#${escapeHtml(t)}</span>`).join("");
      document.getElementById("sheetTags").innerHTML = tags || `<span class="text-xs text-gray-500">(ì—†ìŒ)</span>`;

      // ë²„íŠ¼ë“¤
      const btnEditMemo = document.getElementById("btnEditMemo");
      btnEditMemo.classList.toggle("hidden", item.country !== "Memo");

      document.getElementById("btnNaverSearchFromSheet").onclick = () => {
        const q = `${item.title || ""} ${item.region || ""} ${getMergedTags(item).slice(0,3).join(" ")}`.trim();
        const url = `https://search.naver.com/search.naver?query=${encodeURIComponent(q)}`;
        window.open(url, "_blank");
      };

      document.getElementById("btnAddLabelFromSheet").onclick = () => {
        const t = prompt("ì¶”ê°€í•  ë¼ë²¨(íƒœê·¸) ì´ë¦„:");
        if (!t) return;
        // ë‹¨ì¼ ì„ íƒ(í•´ë‹¹ ë§ˆì»¤)
        const overrides = loadTagOverrides();
        overrides[item.id] = Array.from(new Set([...(overrides[item.id] || []), t.trim()]));
        saveTagOverrides(overrides);
        loadEventMarkers();
        showDetailSheet(item, false);
      };

      btnEditMemo.onclick = () => {
        showMemoInput(item);
      };

      if (inputMode) {
        showMemoInput(item);
      }

      openSheet();
    }

    function showMemoInput(item) {
      // input modeë¡œ
      document.getElementById("sheetViewMode").classList.add("hidden");
      document.getElementById("sheetInputMode").classList.remove("hidden");
      currentSheetIsInput = true;

      document.getElementById("inTitle").value = item.title || "";
      document.getElementById("inDesc").value = item.summary || "";
      document.getElementById("inCeleb").value = (item.celeb || []).join(", ");
      document.getElementById("inTheme").value = item.theme || "";
      document.getElementById("inTags").value = (item.tags || []).join(", ");
      document.getElementById("inImg").value = item.imageUrl || "";

      // ì‚­ì œ ë²„íŠ¼: Memoë§Œ
      document.getElementById("btnDeleteMemo").classList.toggle("hidden", item.country !== "Memo");

      document.getElementById("btnSaveMemo").onclick = () => saveMemoFromInput(item);
      document.getElementById("btnDeleteMemo").onclick = () => deleteMemo(item);
      document.getElementById("btnCancelInput").onclick = () => showDetailSheet(item, false);
    }

    function saveMemoFromInput(item) {
      const title = document.getElementById("inTitle").value.trim();
      const summary = document.getElementById("inDesc").value.trim();
      const celeb = document.getElementById("inCeleb").value.split(",").map(s => s.trim()).filter(Boolean);
      const theme = document.getElementById("inTheme").value || "";
      const tags = document.getElementById("inTags").value.split(",").map(s => s.trim()).filter(Boolean);
      const imageUrl = document.getElementById("inImg").value.trim();

      if (!title) {
        alert("ì œëª©ì€ í•„ìˆ˜");
        return;
      }

      if (item.country !== "Memo") return;

      const memos = loadMemos();
      const idx = memos.findIndex(x => x.id === item.id);
      if (idx >= 0) {
        memos[idx] = { ...memos[idx], title, summary, celeb, theme, tags, imageUrl };
      } else {
        memos.push({ ...item, title, summary, celeb, theme, tags, imageUrl, country:"Memo" });
      }
      saveMemos(memos);

      renderSubTabs();
      loadEventMarkers();
      showDetailSheet({ ...item, title, summary, celeb, theme, tags, imageUrl, country:"Memo" }, false);
    }

    function deleteMemo(item) {
      if (item.country !== "Memo") return;
      if (!confirm("ì´ ë©”ëª¨ë¥¼ ì‚­ì œ?")) return;

      const memos = loadMemos().filter(x => x.id !== item.id);
      saveMemos(memos);

      renderSubTabs();
      loadEventMarkers();
      closeSheet();
    }

    /******************************************************************
     * #upgrade: Memo ìƒì„±(ì§€ë„ í´ë¦­ ì‹œ íšŒìƒ‰ ë§ˆì»¤ + ì¦‰ì‹œ Input Sheet)
     ******************************************************************/
    function createMemoAt(latlng) {
      const memos = loadMemos();
      const id = Date.now(); // ì¶©ë¶„íˆ ìœ ë‹ˆí¬
      const memo = {
        id,
        lat: latlng.lat,
        lng: latlng.lng,
        country: "Memo",
        region: "",
        title: "ìƒˆ ë©”ëª¨",
        summary: "",
        celeb: [],
        theme: "",
        tags: [],
        imageUrl: ""
      };

      memos.push(memo);
      saveMemos(memos);

      // ì„ íƒ ìƒíƒœë¡œ ë§Œë“¤ê³  input ì—´ê¸°
      selectedIds.add(id);
      loadEventMarkers();
      showDetailSheet(memo, true);
      map.panTo([memo.lat, memo.lng], { animate:true, duration:0.4 });
    }

    /******************************************************************
     * #upgrade: ìœ í‹¸
     ******************************************************************/
    function escapeHtml(s) {
      return (s || "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");
    }

    /******************************************************************
     * window.onload
     ******************************************************************/
    window.onload = function() {
      initializeMap();
      hookSearch();
      renderRecentSearchRow();
      renderSubTabs();

      document.getElementById("closeSheetBtn").addEventListener("click", closeSheet);

      // ESCë§Œ: ì„ íƒ í•´ì œ
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") deselectAll();
      });

      // selection actionbar
      document.getElementById("btnAddTagSelected").onclick = () => {
        const t = prompt("ì„ íƒëœ ë§ˆì»¤ë“¤ì— ì¶”ê°€í•  íƒœê·¸:");
        if (!t) return;
        applyTagToSelected(t);
        renderSubTabs();
        loadEventMarkers();
      };
      document.getElementById("btnBrightenSelected").onclick = () => adjustSelectedColorLevel(+1);
      document.getElementById("btnDarkenSelected").onclick = () => adjustSelectedColorLevel(-1);
      document.getElementById("btnClearSelection").onclick = () => deselectAll();

      // Alt+Drag setup(Leaflet map ìƒì„± í›„)
      setupSelection();
    };
  </script>
</body>
</html>

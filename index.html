<!DOCTYPE html>
<html lang="ko" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Event Map (KR/JP)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'google-dark': '#202124', // êµ¬ê¸€ í¬í†  ìŠ¤íƒ€ì¼ ë‹¤í¬
                        'google-gray': '#3c4043',
                        'primary-500': '#10b981',
                        'primary-600': '#059669',
                    },
                    fontFamily: {
                        sans: ['Inter', 'Malgun Gothic', 'Dotum', 'sans-serif'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* ë‹¤í¬ëª¨ë“œ ì „í™˜ íŠ¸ëœì§€ì…˜ */
        body { transition: background-color 0.3s, color 0.3s; }
        
        #map { height: 100vh; width: 100vw; z-index: 10; }

        /* ì»¤ìŠ¤í…€ ë§ˆì»¤ */
        .event-marker {
            width: 50px; height: 50px;
            border-radius: 50%; overflow: hidden;
            border: 3px solid #10b981;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            cursor: pointer; transition: transform 0.2s;
            background: white;
        }
        .event-marker:hover { transform: scale(1.15); z-index: 1000 !important; }
        .event-marker img { width: 100%; height: 100%; object-fit: cover; }

        /* ì§€ì—­ ê°•ì¡° ë°œê´‘ íš¨ê³¼ (Pulse Glow) */
        .glow-circle {
            animation: pulse-ring 2s infinite;
        }
        @keyframes pulse-ring {
            0% { stroke-opacity: 1; fill-opacity: 0.3; transform: scale(0.9); }
            50% { stroke-opacity: 0.5; fill-opacity: 0.1; transform: scale(1.1); }
            100% { stroke-opacity: 1; fill-opacity: 0.3; transform: scale(0.9); }
        }

        /* ë“œë˜ê·¸ ì„ íƒ ë°•ìŠ¤ */
        .selection-box {
            position: absolute; border: 2px dashed #3b82f6;
            background-color: rgba(59, 130, 246, 0.2);
            z-index: 2000; pointer-events: none;
        }

        /* ë°”í…€ ì‹œíŠ¸ */
        #detail-sheet {
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            transform: translateY(100%); z-index: 50;
        }
        #detail-sheet.active { transform: translateY(0); }

        /* ê²€ìƒ‰ì–´ íˆìŠ¤í† ë¦¬ ì¹© */
        .history-chip {
            transition: all 0.2s;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-google-dark text-gray-900 dark:text-gray-100 overflow-hidden">

    <!-- ìƒë‹¨ UI: ê²€ìƒ‰ ë° í•„í„° -->
    <div class="fixed top-4 left-4 right-4 z-[40] flex flex-col gap-2 max-w-md mx-auto pointer-events-none">
        <!-- ê²€ìƒ‰ì°½ -->
        <div class="pointer-events-auto bg-white dark:bg-google-gray rounded-xl shadow-lg p-3 flex flex-col gap-2">
            <input type="text" id="search-input" placeholder="ì¶•ì œëª…, ì§€ì—­, íƒœê·¸ ê²€ìƒ‰ (Alt+ë“œë˜ê·¸ë¡œ ë‹¤ì¤‘ì„ íƒ)" 
                   class="w-full bg-gray-100 dark:bg-[#303134] dark:text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 transition-colors">
            <!-- ê²€ìƒ‰ íˆìŠ¤í† ë¦¬ ë²„í¼ -->
            <div id="search-history" class="flex gap-2 overflow-x-auto text-xs pb-1 scrollbar-hide"></div>
        </div>

        <!-- í•„í„° ë²„íŠ¼ -->
        <div class="pointer-events-auto flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
            <button onclick="filterByTag('all')" class="px-4 py-1.5 bg-white dark:bg-google-gray rounded-full shadow-md text-sm font-semibold whitespace-nowrap hover:bg-gray-100 dark:hover:bg-gray-600 transition">ì „ì²´</button>
            <button onclick="highlightRegion('ì¶©ë‚¨')" class="px-4 py-1.5 bg-white dark:bg-google-gray rounded-full shadow-md text-sm font-semibold whitespace-nowrap hover:bg-gray-100 dark:hover:bg-gray-600 transition">ì¶©ë‚¨(ê°•ì¡°)</button>
            <button onclick="highlightRegion('ë„ì¿„')" class="px-4 py-1.5 bg-white dark:bg-google-gray rounded-full shadow-md text-sm font-semibold whitespace-nowrap hover:bg-gray-100 dark:hover:bg-gray-600 transition">ë„ì¿„(ê°•ì¡°)</button>
            <button onclick="toggleHeatmap()" class="px-4 py-1.5 bg-red-100 dark:bg-red-900 text-red-600 dark:text-red-200 rounded-full shadow-md text-sm font-semibold whitespace-nowrap transition">ğŸ”¥ ì‚°ì ë„/ë§ˆì»¤</button>
            <button onclick="toggleDarkMode()" class="px-4 py-1.5 bg-gray-800 text-white rounded-full shadow-md text-sm font-semibold whitespace-nowrap transition">ğŸŒ™ ë‹¤í¬ëª¨ë“œ</button>
        </div>
    </div>

    <!-- ì§€ë„ ì»¨í…Œì´ë„ˆ -->
    <div id="map" class="relative"></div>

    <!-- ë“œë˜ê·¸ ì„ íƒ ì˜¤ë²„ë ˆì´ (ë™ì  ìƒì„±) -->
    <div id="selection-overlay"></div>

    <!-- í•˜ë‹¨ ì´ë²¤íŠ¸ ìƒì„¸ ì •ë³´ íƒ­ -->
    <div id="detail-sheet" class="fixed bottom-0 left-0 right-0 max-h-[70vh] bg-white dark:bg-[#2d2f31] rounded-t-3xl shadow-2xl p-6 flex flex-col">
        <div class="flex justify-between items-center mb-4 border-b dark:border-gray-600 pb-3">
            <h2 id="sheet-title" class="text-xl font-bold dark:text-white"></h2>
            <button onclick="hideDetailSheet()" class="px-4 py-1.5 bg-gray-200 dark:bg-gray-600 rounded-full text-sm font-bold">ë‹«ê¸°</button>
        </div>
        <div class="overflow-y-auto flex-grow">
            <img id="sheet-image" class="w-full h-48 object-cover rounded-xl mb-4 shadow-md" src="" alt="">
            <div class="mb-4">
                <h3 class="text-sm font-bold text-primary-500 mb-1">ìš”ì•½</h3>
                <p id="sheet-summary" class="text-gray-700 dark:text-gray-300 text-sm whitespace-pre-line"></p>
            </div>
            <div>
                <h3 class="text-sm font-bold text-primary-500 mb-1">ê²ŒìŠ¤íŠ¸</h3>
                <p id="sheet-celeb" class="text-gray-700 dark:text-gray-300 text-sm"></p>
            </div>
        </div>
    </div>

    <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

    <script>
        // 1. ë°ì´í„° ì •ì˜ (í•œì¼ ì¶•ì œ ë°ì´í„°)
        const mockEvents = [
            // í•œêµ­ (ê¸°ì¡´ + í™•ì¥)
            { id: 1, name: "ì²œì•ˆ ë¹µ í˜ìŠ¤í‹°ë²Œ", lat: 36.814, lng: 127.113, region: "ì¶©ë‚¨", tags: ["ìŒì‹", "ë¹µ"], summary: "ë¹µì˜ ë„ì‹œ ì²œì•ˆ!", celeb: "ì´ì—°ë³µ ì…°í”„", img: "https://placehold.co/100/orange/white?text=Bread" },
            { id: 2, name: "ë³´ë ¹ ë¨¸ë“œ ì¶•ì œ", lat: 36.315, lng: 126.541, region: "ì¶©ë‚¨", tags: ["ì²´í—˜", "ì—¬ë¦„"], summary: "ì„¸ê³„ì¸ì˜ ë¨¸ë“œì²´í—˜", celeb: "ì‹¸ì´, ì•„ì´ë¸Œ", img: "https://placehold.co/100/brown/white?text=Mud" },
            { id: 3, name: "ë¶€ì‚° ë¶ˆê½ƒ ì¶•ì œ", lat: 35.153, lng: 129.118, region: "ë¶€ì‚°", tags: ["ë¬¸í™”", "ì•¼ê²½"], summary: "ê´‘ì•ˆë¦¬ í•´ë³€ì˜ ë¶ˆê½ƒ", celeb: "ì—†ìŒ", img: "https://placehold.co/100/purple/white?text=Fire" },
            { id: 4, name: "ì „ì£¼ ë¹„ë¹”ë°¥ ì¶•ì œ", lat: 35.814, lng: 127.152, region: "ì „ë¶", tags: ["ìŒì‹", "ì „í†µ"], summary: "ë§›ì˜ ê³ ì¥ ì „ì£¼", celeb: "ë°±ì¢…ì›", img: "https://placehold.co/100/green/white?text=Bibim" },
            { id: 5, name: "ê°•ë¦‰ ì»¤í”¼ ì¶•ì œ", lat: 37.751, lng: 128.876, region: "ê°•ì›", tags: ["ìŒì‹", "ì»¤í”¼"], summary: "ë°”ë‹¤ì™€ ì»¤í”¼ì˜ ë§Œë‚¨", celeb: "ë°”ë¦¬ìŠ¤íƒ€ ì±”í”¼ì–¸", img: "https://placehold.co/100/black/white?text=Coffee" },
            
            // ì¼ë³¸ (ì‹ ê·œ)
            { id: 101, name: "ë„ì¿„ ê°„ë‹¤ ë§ˆì¸ ë¦¬", lat: 35.698, lng: 139.771, region: "ë„ì¿„", tags: ["ë¬¸í™”", "ì „í†µ"], summary: "ì—ë„ 3ëŒ€ ë§ˆì¸ ë¦¬ ì¤‘ í•˜ë‚˜", celeb: "ì§€ì—­ ì¥ì¸ë“¤", img: "https://placehold.co/100/red/white?text=Kanda" },
            { id: 102, name: "ìŠ¤ë¯¸ë‹¤ê°• ë¶ˆê½ƒë†€ì´", lat: 35.710, lng: 139.805, region: "ë„ì¿„", tags: ["ì•¼ê²½", "ì—¬ë¦„"], summary: "ë„ì¿„ ìµœê³ ì˜ ë¶ˆê½ƒë†€ì´", celeb: "ì—†ìŒ", img: "https://placehold.co/100/blue/white?text=Hanabi" },
            { id: 103, name: "ì˜¤ì‚¬ì¹´ í…ì§„ ë§ˆì¸ ë¦¬", lat: 34.696, lng: 135.519, region: "ì˜¤ì‚¬ì¹´", tags: ["ë¬¸í™”", "ë°°"], summary: "ì²œë…„ì˜ ì—­ì‚¬ë¥¼ ìë‘í•˜ëŠ” ë¬¼ì˜ ì¶•ì œ", celeb: "ì—†ìŒ", img: "https://placehold.co/100/yellow/black?text=Tenjin" },
            { id: 104, name: "ì‚¿í¬ë¡œ ëˆˆ ì¶•ì œ", lat: 43.061, lng: 141.354, region: "í™‹ì¹´ì´ë„", tags: ["ê²¨ìš¸", "ì „ì‹œ"], summary: "ì´ˆëŒ€í˜• ëˆˆ ì¡°ê° ì „ì‹œ", celeb: "í•´ì™¸ ì¡°ê°ê°€", img: "https://placehold.co/100/white/black?text=Snow" }
        ];

        let map, markersLayer, heatLayer;
        let activeGlowLayer = null;
        let isHeatmapMode = false;
        
        // ê²€ìƒ‰ íˆìŠ¤í† ë¦¬ (Circular Buffer ê°œë…, Max 5)
        let searchBuffer = []; 
        const MAX_HISTORY = 5;

        // 2. ì´ˆê¸°í™”
        window.onload = function() {
            initializeMap();
            setupSearch();
            setupDragSelection();
            renderHistory();
        };

        function initializeMap() {
            // í•œì¼ ì¤‘ê°„ ì§€ì ìœ¼ë¡œ ë·° ì„¤ì • (ì¤Œ ë ˆë²¨ 5ë¡œ ë„“ê²Œ)
            map = L.map('map', { zoomControl: false }).setView([36.5, 133], 5);
            
            // íƒ€ì¼ ë ˆì´ì–´ (ë‹¤í¬ëª¨ë“œ ëŒ€ì‘ì„ ìœ„í•´ CartoDB DarkMatter ë˜ëŠ” OpenStreetMap ì‚¬ìš©)
            // ì—¬ê¸°ì„  OSM ê¸°ë³¸ì— CSS í•„í„°ë¡œ ë‹¤í¬ëª¨ë“œ ì²˜ë¦¬ (body í´ë˜ìŠ¤ ë”°ë¼ê°)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: 'OpenStreetMap'
            }).addTo(map);

            L.control.zoom({ position: 'bottomright' }).addTo(map);

            loadEventMarkers(mockEvents);

            // ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ íˆíŠ¸ë§µ/ë§ˆì»¤ ìë™ ì „í™˜ ë¦¬ìŠ¤ë„ˆ
            map.on('zoomend', function() {
                if (isHeatmapMode) updateVisualization();
            });
        }

        // 3. ë§ˆì»¤ ë° ì‚°ì ë„ ë¡œì§
        function loadEventMarkers(events) {
            if (markersLayer) map.removeLayer(markersLayer);
            if (heatLayer) map.removeLayer(heatLayer);

            // ë§ˆì»¤ ê·¸ë£¹
            markersLayer = L.layerGroup();
            
            // íˆíŠ¸ë§µ ë°ì´í„° ì¤€ë¹„ [[lat, lng, intensity], ...]
            const heatData = events.map(e => [e.lat, e.lng, 0.8]); // ê°•ë„ 0.8ë¡œ í†µì¼

            events.forEach(event => {
                const icon = L.divIcon({
                    className: 'custom-icon',
                    html: `<div class="event-marker"><img src="${event.img}" onerror="this.src='https://via.placeholder.com/50'"></div>`,
                    iconSize: [50, 50],
                    iconAnchor: [25, 25]
                });

                const marker = L.marker([event.lat, event.lng], { icon: icon });
                marker.on('click', () => showDetailSheet(event));
                markersLayer.addLayer(marker);
            });

            // íˆíŠ¸ë§µ ë ˆì´ì–´ ìƒì„± (leaflet-heat)
            heatLayer = L.heatLayer(heatData, {
                radius: 40,
                blur: 25,
                maxZoom: 10,
                gradient: {0.4: 'blue', 0.65: 'lime', 1: 'red'} // ë¹¨ê°›ê²Œ í‘œì‹œ
            });

            updateVisualization();
        }

        function updateVisualization() {
            const zoom = map.getZoom();
            // ì‚°ì ë„ ëª¨ë“œì´ê±°ë‚˜, ì¤Œì´ ë„ˆë¬´ ë©€ë©´(<=6) íˆíŠ¸ë§µ í‘œì‹œ
            if (isHeatmapMode || zoom <= 6) {
                if (map.hasLayer(markersLayer)) map.removeLayer(markersLayer);
                if (!map.hasLayer(heatLayer)) map.addLayer(heatLayer);
            } else {
                if (map.hasLayer(heatLayer)) map.removeLayer(heatLayer);
                if (!map.hasLayer(markersLayer)) map.addLayer(markersLayer);
            }
        }

        function toggleHeatmap() {
            isHeatmapMode = !isHeatmapMode;
            updateVisualization();
        }

        // 4. ì§€ì—­ ë°œê´‘ íš¨ê³¼ (ì„ì‹œ ë°œê´‘ìƒ‰)
        function highlightRegion(regionName) {
            if (activeGlowLayer) map.removeLayer(activeGlowLayer);

            // ì§€ì—­ë³„ ëŒ€ëµì  ì¢Œí‘œ (ì‹¤ì œë¡  Polygon ë°ì´í„° í•„ìš”, ì—¬ê¸°ì„  Circleë¡œ ëŒ€ì²´)
            const coords = {
                'ì¶©ë‚¨': [36.5, 126.8],
                'ë„ì¿„': [35.68, 139.76]
            };

            if (coords[regionName]) {
                map.setView(coords[regionName], 9);
                
                // ì€ì€í•œ ë°œê´‘ ì› ìƒì„±
                activeGlowLayer = L.circle(coords[regionName], {
                    color: '#ffeb3b', // ë…¸ë€ìƒ‰ ë°œê´‘
                    fillColor: '#ffeb3b',
                    fillOpacity: 0.3,
                    radius: 40000, // 40km ë°˜ê²½
                    className: 'glow-circle' // CSS ì• ë‹ˆë©”ì´ì…˜ ì ìš©
                }).addTo(map);

                // 3ì´ˆ í›„ ì œê±° (ìì—°ìŠ¤ëŸ½ê²Œ)
                setTimeout(() => {
                    if (activeGlowLayer) map.removeLayer(activeGlowLayer);
                }, 3000);
            }
        }

        // 5. ë“œë˜ê·¸ ì„ íƒ (Alt + Drag)
        function setupDragSelection() {
            const box = document.createElement('div');
            box.className = 'selection-box hidden';
            document.body.appendChild(box);

            let startPoint = null;
            let isDragging = false;

            map.getContainer().addEventListener('mousedown', (e) => {
                if (e.altKey) {
                    map.dragging.disable(); // ì§€ë„ ì´ë™ ë¹„í™œì„±
                    startPoint = { x: e.clientX, y: e.clientY };
                    isDragging = true;
                    box.style.left = startPoint.x + 'px';
                    box.style.top = startPoint.y + 'px';
                    box.style.width = '0px';
                    box.style.height = '0px';
                    box.classList.remove('hidden');
                    box.style.display = 'block';
                }
            });

            window.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const currentX = e.clientX;
                const currentY = e.clientY;
                
                const width = Math.abs(currentX - startPoint.x);
                const height = Math.abs(currentY - startPoint.y);
                const left = Math.min(currentX, startPoint.x);
                const top = Math.min(currentY, startPoint.y);

                box.style.width = width + 'px';
                box.style.height = height + 'px';
                box.style.left = left + 'px';
                box.style.top = top + 'px';
            });

            window.addEventListener('mouseup', (e) => {
                if (isDragging) {
                    isDragging = false;
                    box.style.display = 'none';
                    map.dragging.enable();

                    // ì„ íƒëœ ì˜ì—­ ì¢Œí‘œ ê³„ì‚°
                    const bounds = L.latLngBounds(
                        map.containerPointToLatLng([parseInt(box.style.top), parseInt(box.style.left)]),
                        map.containerPointToLatLng([parseInt(box.style.top) + parseInt(box.style.height), parseInt(box.style.left) + parseInt(box.style.width)])
                    );

                    // ì˜ì—­ ë‚´ ë§ˆì»¤ ì¶”ì¶œ
                    const selected = mockEvents.filter(ev => bounds.contains([ev.lat, ev.lng]));
                    if (selected.length > 0) {
                        alert(`${selected.length}ê°œì˜ ì¶•ì œê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤:\n` + selected.map(s => s.name).join(', '));
                    }
                }
            });
        }

        // 6. ê²€ìƒ‰ ê¸°ëŠ¥ (Debounce + Buffer)
        function setupSearch() {
            const input = document.getElementById('search-input');
            let debounceTimer;

            input.addEventListener('input', (e) => {
                const keyword = e.target.value.trim();
                
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    // í•„í„°ë§ ë¡œì§
                    const filtered = mockEvents.filter(ev => 
                        ev.name.includes(keyword) || 
                        ev.region.includes(keyword) || 
                        ev.tags.some(t => t.includes(keyword))
                    );
                    loadEventMarkers(filtered);
                }, 300); // 300ms Debounce
            });

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    addToHistory(input.value);
                }
            });
        }

        // íˆìŠ¤í† ë¦¬ ê´€ë¦¬ (Ring Buffer st)
        function addToHistory(keyword) {
            if (!keyword) return;
            // ì¤‘ë³µ ì œê±° í›„ ë§¨ ì•ì— ì¶”ê°€
            searchBuffer = searchBuffer.filter(k => k !== keyword);
            searchBuffer.unshift(keyword);
            if (searchBuffer.length > MAX_HISTORY) searchBuffer.pop(); // Max Size ìœ ì§€
            renderHistory();
        }

        function renderHistory() {
            const container = document.getElementById('search-history');
            container.innerHTML = searchBuffer.map(k => 
                `<span onclick="searchByHistory('${k}')" class="history-chip bg-gray-200 dark:bg-gray-700 dark:text-gray-300 px-2 py-1 rounded-md cursor-pointer hover:bg-gray-300 whitespace-nowrap">${k}</span>`
            ).join('');
        }

        function searchByHistory(keyword) {
            document.getElementById('search-input').value = keyword;
            // ê°•ì œ ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°
            document.getElementById('search-input').dispatchEvent(new Event('input'));
        }

        // UI ê´€ë ¨ í•¨ìˆ˜ë“¤
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
        }

        function showDetailSheet(event) {
            const sheet = document.getElementById('detail-sheet');
            document.getElementById('sheet-title').innerText = event.name;
            document.getElementById('sheet-summary').innerText = event.summary;
            document.getElementById('sheet-celeb').innerText = `Guest: ${event.celeb}`;
            document.getElementById('sheet-image').src = event.img;
            sheet.classList.add('active');
            map.panTo([event.lat, event.lng]);
        }

        function hideDetailSheet() {
            document.getElementById('detail-sheet').classList.remove('active');
        }
    </script>
</body>
</html>

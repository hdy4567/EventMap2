<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EventMap2 - Global Festival Tracker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: black; font-family: 'Pretendard', sans-serif; }
        
        /* #upgrade: ì§€ë„ ë‹¤í¬ëª¨ë“œ ì™„ë²½ êµ¬í˜„ - íƒ€ì¼ í˜ì¸ì—ë§Œ í•„í„° ì ìš©í•˜ì—¬ ì´ì¤‘ ë°˜ì „ ë°©ì§€ */
        #map { height: 100vh; width: 100vw; background: #000000; z-index: 0; }
        .leaflet-tile-pane { filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); }
        
        /* #upgrade: ë“œë˜ê·¸ ì…€ë ‰ì…˜ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ - íŒŒë€ìƒ‰ í…Œë‘ë¦¬ */
        .selection-box {
            position: absolute;
            border: 2px solid #2196F3;
            background-color: rgba(33, 150, 243, 0.2);
            z-index: 1000;
            pointer-events: none;
            display: none;
        }

        /* #upgrade: ì§€ì—­ ê²½ê³„ ë°œê´‘ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes pulse-glow {
            0% { stroke-opacity: 0.4; stroke-width: 2; }
            50% { stroke-opacity: 1.0; stroke-width: 5; }
            100% { stroke-opacity: 0.4; stroke-width: 2; }
        }
        .region-glow-path {
            stroke: #ffeb3b;
            fill: #ffeb3b;
            fill-opacity: 0.1;
            animation: pulse-glow 2s infinite;
        }

        /* ìƒì„¸ ì‹œíŠ¸ ì• ë‹ˆë©”ì´ì…˜ */
        #detailSheet { transition: transform 0.3s ease-in-out; }
        
        /* ì»¤ìŠ¤í…€ ë§ˆì»¤ ìŠ¤íƒ€ì¼ */
        .custom-marker {
            width: 64px; height: 64px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            object-fit: cover;
            transition: transform 0.2s;
        }
        .custom-marker:hover { transform: scale(1.1); z-index: 1000 !important; }
        .marker-selected { border-color: #ffeb3b; box-shadow: 0 0 15px #ffeb3b; transform: scale(1.1); }

        /* í´ëŸ¬ìŠ¤í„° ìƒ‰ìƒ ë¡œì§ (ì´ˆë¡ < ë…¸ë‘ < ë¹¨ê°•) */
        .marker-cluster-small { background-color: rgba(110, 204, 57, 0.6); } /* < 5 */
        .marker-cluster-small div { background-color: rgba(110, 204, 57, 0.6); }
        .marker-cluster-medium { background-color: rgba(240, 194, 12, 0.6); } /* < 10 */
        .marker-cluster-medium div { background-color: rgba(240, 194, 12, 0.6); }
        .cluster-high-density { background-color: rgba(255, 59, 48, 0.7); } /* >= 10 */
        .cluster-high-density div { background-color: rgba(255, 59, 48, 0.7); }

        /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-black text-white">

    <!-- 1ë‹¨: ë„¤ì´ë²„ ê²€ìƒ‰ì°½ (ìƒë‹¨ ê³ ì •) -->
    <div class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 w-[90%] max-w-md bg-gray-900/90 backdrop-blur-md rounded-full shadow-2xl border border-gray-700 p-2 flex items-center transition-all hover:w-full hover:max-w-lg">
        <div class="pl-4 text-green-500 font-bold">N</div>
        <input type="text" id="searchInput" placeholder="ì¶•ì œ, ì§€ì—­, íƒœê·¸ ê²€ìƒ‰ (ë„¤ì´ë²„ ì—°ë™)" 
               class="bg-transparent border-none text-white px-4 py-2 w-full focus:outline-none placeholder-gray-400 text-sm">
        <button onclick="executeSearch()" class="bg-green-600 hover:bg-green-500 text-white rounded-full p-2 w-10 h-10 flex items-center justify-center transition-colors">
            ğŸ”
        </button>
    </div>

    <!-- 2ë‹¨: êµ­ê°€ íƒ­ -->
    <div class="fixed top-20 left-1/2 transform -translate-x-1/2 z-40 w-[90%] max-w-lg flex justify-center gap-2">
        <button onclick="setCountry('Korea')" id="btn-Korea" class="px-4 py-1.5 rounded-full text-sm font-semibold bg-gray-800 text-gray-400 hover:bg-gray-700 border border-gray-600 transition-all">ğŸ‡°ğŸ‡· í•œêµ­</button>
        <button onclick="setCountry('Japan')" id="btn-Japan" class="px-4 py-1.5 rounded-full text-sm font-semibold bg-gray-800 text-gray-400 hover:bg-gray-700 border border-gray-600 transition-all">ğŸ‡¯ğŸ‡µ ì¼ë³¸</button>
        <button onclick="setCountry('Memo')" id="btn-Memo" class="px-4 py-1.5 rounded-full text-sm font-semibold bg-gray-800 text-gray-400 hover:bg-gray-700 border border-gray-600 transition-all">ğŸ“ ë©”ëª¨</button>
    </div>

    <!-- 3ë‹¨: ì„œë¸Œ íƒ­ (ì§€ì—­/íƒœê·¸) -->
    <div id="subTabContainer" class="fixed top-32 left-1/2 transform -translate-x-1/2 z-30 w-full max-w-2xl px-4 flex gap-2 overflow-x-auto no-scrollbar justify-start md:justify-center">
        <!-- JSë¡œ ë™ì  ë Œë”ë§ -->
    </div>

    <!-- ìµœê·¼ ê²€ìƒ‰ì–´ (ë¡œì»¬ìŠ¤í† ë¦¬ì§€) -->
    <div id="recentSearchContainer" class="fixed top-44 right-4 z-30 flex flex-col items-end gap-1 pointer-events-none opacity-0 transition-opacity hover:opacity-100">
        <!-- JS ë¡œë“œ -->
    </div>

    <!-- ì§€ë„ ì»¨í…Œì´ë„ˆ -->
    <div id="map"></div>

    <!-- ë“œë˜ê·¸ ì…€ë ‰ì…˜ ë°•ìŠ¤ -->
    <div id="selectionBox" class="selection-box"></div>

    <!-- ìƒì„¸ ì •ë³´ ì‹œíŠ¸ (í•˜ë‹¨) -->
    <div id="detailSheet" class="fixed bottom-0 left-0 w-full h-[35vh] bg-gray-900 rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.8)] transform translate-y-full z-50 flex flex-col border-t border-gray-700">
        <div class="w-12 h-1.5 bg-gray-600 rounded-full mx-auto mt-3 mb-2"></div>
        <button id="closeSheetBtn" class="absolute top-4 right-4 text-gray-400 hover:text-white">âœ•</button>
        
        <div class="flex h-full p-4 gap-4 overflow-hidden">
            <div class="w-1/3 h-full rounded-xl overflow-hidden shadow-lg relative bg-gray-800">
                <img id="sheetImage" src="" class="w-full h-full object-cover opacity-90" alt="Event">
                <div class="absolute bottom-0 left-0 bg-gradient-to-t from-black to-transparent w-full h-1/2"></div>
            </div>
            <div class="w-2/3 flex flex-col text-left overflow-y-auto no-scrollbar">
                <div class="flex items-center gap-2 mb-1">
                    <span id="sheetCountry" class="text-xs px-2 py-0.5 rounded bg-gray-700 text-gray-300"></span>
                    <span id="sheetRegion" class="text-xs px-2 py-0.5 rounded bg-blue-900 text-blue-200"></span>
                </div>
                <h2 id="sheetTitle" class="text-2xl font-bold text-white mb-2 leading-tight"></h2>
                <p id="sheetDesc" class="text-gray-300 text-sm mb-3 font-light leading-relaxed"></p>
                
                <div class="mt-auto">
                    <p class="text-xs text-gray-500 uppercase tracking-wider mb-1">Guest / Celeb</p>
                    <div id="sheetCeleb" class="flex flex-wrap gap-2"></div>
                </div>
                <div class="mt-2">
                    <p class="text-xs text-gray-500 uppercase tracking-wider mb-1">Tags</p>
                    <div id="sheetTags" class="flex flex-wrap gap-1"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script>
        // #upgrade: ë°ì´í„° - TourAPI(í•œêµ­) ë° Jalan(ì¼ë³¸) ì°¸ì¡° êµ¬ì¡° (ID, Lat, Lng, Color, Region, Tags ë“±)
        const mockEvents = [
            // [í•œêµ­ ë°ì´í„°]
            { id: 1, title: "ì„œìš¸ ì„¸ê³„ ë¶ˆê½ƒì¶•ì œ", lat: 37.528, lng: 126.934, region: "ì„œìš¸", country: "Korea", tags: ["ë¶ˆê½ƒ", "ì•¼ê²½", "í•œê°•"], celeb: ["ë¶ˆê½ƒë””ìì´ë„ˆ"], img: "https://source.unsplash.com/random/200x200/?fireworks", desc: "ì—¬ì˜ë„ í•œê°•ê³µì›ì—ì„œ í¼ì³ì§€ëŠ” ê°€ì„ ë°¤ì˜ ë¶ˆê½ƒ í–¥ì—°" },
            { id: 2, title: "ë¶€ì‚° êµ­ì œ ì˜í™”ì œ", lat: 35.171, lng: 129.127, region: "ë¶€ì‚°", country: "Korea", tags: ["ì˜í™”", "ë¬¸í™”", "í•´ìš´ëŒ€"], celeb: ["ì†¡ê°•í˜¸", "íƒ•ì›¨ì´"], img: "https://source.unsplash.com/random/200x200/?cinema", desc: "ì•„ì‹œì•„ ìµœëŒ€ì˜ ì˜í™” ì¶•ì œ, ë¶€ì‚° í•´ìš´ëŒ€ì™€ ì„¼í…€ì‹œí‹° ì¼ëŒ€" },
            { id: 3, title: "ë³´ë ¹ ë¨¸ë“œ ì¶•ì œ", lat: 36.309, lng: 126.516, region: "ì¶©ë‚¨", country: "Korea", tags: ["ì•¡í‹°ë¹„í‹°", "ì—¬ë¦„", "í•´ë³€"], celeb: ["ì‹¸ì´", "ì•„ì´ë¸Œ"], img: "https://source.unsplash.com/random/200x200/?mud", desc: "ëŒ€ì²œí•´ìˆ˜ìš•ì¥ì—ì„œ ì¦ê¸°ëŠ” ì„¸ê³„ì ì¸ ë¨¸ë“œ ì²´í—˜ ì¶•ì œ" },
            { id: 4, title: "ì „ì£¼ ë¹„ë¹”ë°¥ ì¶•ì œ", lat: 35.814, lng: 127.153, region: "ì „ë¶", country: "Korea", tags: ["ìŒì‹", "ì „í†µ", "ë¯¸ì‹"], celeb: ["ë°±ì¢…ì›"], img: "https://source.unsplash.com/random/200x200/?bibimbap", desc: "ë§›ê³¼ ë©‹ì˜ ê³ ì¥ ì „ì£¼ì—ì„œ ì—´ë¦¬ëŠ” í•œêµ­ ëŒ€í‘œ ìŒì‹ ì¶•ì œ" },
            { id: 5, title: "ì§„í•´ êµ°í•­ì œ", lat: 35.150, lng: 128.665, region: "ê²½ë‚¨", country: "Korea", tags: ["ë²šê½ƒ", "ë´„", "ì‚¬ì§„"], celeb: ["ë¡œì´í‚´"], img: "https://source.unsplash.com/random/200x200/?cherryblossom", desc: "êµ­ë‚´ ìµœëŒ€ ë²šê½ƒ ì¶•ì œ, ì—¬ì¢Œì²œ ë¡œë§ìŠ¤ë‹¤ë¦¬" },
            { id: 6, title: "ê°€í‰ ìë¼ì„¬ ì¬ì¦ˆí˜ìŠ¤í‹°ë²Œ", lat: 37.817, lng: 127.514, region: "ê²½ê¸°", country: "Korea", tags: ["ìŒì•…", "ì¬ì¦ˆ", "ìº í•‘"], celeb: ["ë‚˜ìœ¤ì„ ", "ì¬ì¦ˆë°´ë“œ"], img: "https://source.unsplash.com/random/200x200/?jazz", desc: "ìì—° ì†ì—ì„œ ì¦ê¸°ëŠ” ê°€ì„ ë‚­ë§Œ ì¬ì¦ˆ í˜ìŠ¤í‹°ë²Œ" },
            { id: 7, title: "ê°•ë¦‰ ì»¤í”¼ ì¶•ì œ", lat: 37.751, lng: 128.876, region: "ê°•ì›", country: "Korea", tags: ["ì»¤í”¼", "ë°”ë‹¤", "ì¹´í˜"], celeb: ["ë°”ë¦¬ìŠ¤íƒ€"], img: "https://source.unsplash.com/random/200x200/?coffee", desc: "ì•ˆëª©í•´ë³€ ì»¤í”¼ê±°ë¦¬ì™€ í•¨ê»˜í•˜ëŠ” í–¥ê¸‹í•œ ì»¤í”¼ ì¶•ì œ" },
            { id: 8, title: "ì•ˆë™ êµ­ì œ íƒˆì¶¤ í˜ìŠ¤í‹°ë²Œ", lat: 36.568, lng: 128.729, region: "ê²½ë¶", country: "Korea", tags: ["ì „í†µ", "ê³µì—°", "íƒˆì¶¤"], celeb: ["í•˜íšŒíƒˆíŒ€"], img: "https://source.unsplash.com/random/200x200/?mask", desc: "í•˜íšŒë§ˆì„ê³¼ íƒˆì¶¤ê³µì›ì—ì„œ ì—´ë¦¬ëŠ” í•œêµ­ ì „í†µ ë¬¸í™” ì¶•ì œ" },
            
            // [ì¼ë³¸ ë°ì´í„°]
            { id: 101, title: "ê¸°ì˜¨ ë§ˆì¸ ë¦¬", lat: 35.003, lng: 135.768, region: "êµí† ", country: "Japan", tags: ["ì „í†µ", "ë§ˆì¸ ë¦¬", "ì—¬ë¦„"], celeb: ["êµí† ì‹œì¥"], img: "https://source.unsplash.com/random/200x200/?kyoto", desc: "ì²œë…„ì˜ ì—­ì‚¬ë¥¼ ê°€ì§„ ì¼ë³¸ 3ëŒ€ ë§ˆì¸ ë¦¬ ì¤‘ í•˜ë‚˜" },
            { id: 102, title: "ì‚¿í¬ë¡œ ëˆˆ ì¶•ì œ", lat: 43.061, lng: 141.354, region: "í™‹ì¹´ì´ë„", country: "Japan", tags: ["ê²¨ìš¸", "ëˆˆ", "ì¡°ê°"], celeb: ["ìœ í‚¤ë¯¸ì¿ "], img: "https://source.unsplash.com/random/200x200/?snow", desc: "ì˜¤ë„ë¦¬ ê³µì›ì—ì„œ í¼ì³ì§€ëŠ” ê±°ëŒ€í•œ ëˆˆ ì¡°ê° ì „ì‹œ" },
            { id: 103, title: "ìŠ¤ë¯¸ë‹¤ê°• ë¶ˆê½ƒë†€ì´", lat: 35.710, lng: 139.796, region: "ë„ì¿„", country: "Japan", tags: ["ë¶ˆê½ƒ", "ì—¬ë¦„", "ìœ ì¹´íƒ€"], celeb: [], img: "https://source.unsplash.com/random/200x200/?tokyo", desc: "ë„ì¿„ì˜ ì—¬ë¦„ ë°¤ì„ ìˆ˜ë†“ëŠ” ì „í†µì ì¸ ë¶ˆê½ƒë†€ì´ ëŒ€íšŒ" },
            { id: 104, title: "í…ì§„ ë§ˆì¸ ë¦¬", lat: 34.696, lng: 135.519, region: "ì˜¤ì‚¬ì¹´", country: "Japan", tags: ["ë§ˆì¸ ë¦¬", "ë°°", "ë¶ˆê½ƒ"], celeb: [], img: "https://source.unsplash.com/random/200x200/?osaka", desc: "ì˜¤ì‚¬ì¹´ í…ë§Œêµ¬ ì‹ ì‚¬ ì¤‘ì‹¬ì˜ ë¬¼ê³¼ ë¶ˆì˜ ì¶•ì œ" },
            { id: 105, title: "ë‚˜í•˜ ëŒ€ì¤„ë‹¤ë¦¬ê¸°", lat: 26.212, lng: 127.679, region: "ì˜¤í‚¤ë‚˜ì™€", country: "Japan", tags: ["ì „í†µ", "ì•¡í‹°ë¹„í‹°", "ê¸°ë„¤ìŠ¤"], celeb: [], img: "https://source.unsplash.com/random/200x200/?okinawa", desc: "ì„¸ê³„ ê¸°ë„¤ìŠ¤ë¶ì— ë“±ì¬ëœ ê±°ëŒ€í•œ ì¤„ë‹¤ë¦¬ê¸° í–‰ì‚¬" }
        ];

        // #upgrade: ì§€ì—­ ê²½ê³„ ë°ì´í„° íŒŒë¼ë¯¸í„°í™” (GeoJSON ëŒ€ì²´ìš© ë‹¨ìˆœí™”ëœ Bounds)
        const regionBoundaryParams = {
            "ì„œìš¸": [[37.41, 126.76], [37.71, 127.19]],
            "ê²½ê¸°": [[36.89, 126.37], [38.29, 127.85]],
            "ë¶€ì‚°": [[34.87, 128.79], [35.39, 129.31]],
            "ë„ì¿„": [[35.50, 138.90], [35.89, 139.92]],
            "ì˜¤ì‚¬ì¹´": [[34.20, 135.00], [35.00, 135.80]]
        };

        // ì „ì—­ ë³€ìˆ˜
        let map;
        let markers;
        let currentCountry = 'Korea'; // Korea, Japan, Memo
        let selectedEvents = new Set();
        let regionRectangle = null; // ì§€ì—­ ë°œê´‘ íš¨ê³¼ ë ˆì´ì–´ ì €ì¥ìš©
        let selectionBox = document.getElementById('selectionBox');
        let isDragging = false;
        let startPoint = null;

        // #upgrade: ìœˆë„ìš° ë¡œë“œ ì‹œ ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        window.onload = function() {
            initializeMap();
            renderCountryTabs(); // ì´ˆê¸° íƒ­ ë Œë”ë§
            
            // #upgrade: ë“œë˜ê·¸ ì„ íƒì„ ìœ„í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (Alt í‚¤ ì¡°í•©)
            document.addEventListener('mousedown', startSelection);
            document.addEventListener('mousemove', updateSelection);
            document.addEventListener('mouseup', endSelection);
            
            // #upgrade: ESC í‚¤ë¡œ ì„ íƒ í•´ì œ
            document.addEventListener('keydown', (e) => {
                if(e.key === 'Escape') deselectAll();
            });

            // ìƒì„¸ ì‹œíŠ¸ ë‹«ê¸°
            document.getElementById('closeSheetBtn').addEventListener('click', closeDetailSheet);
            
            // ë„¤ì´ë²„ ê²€ìƒ‰ ì—”í„°í‚¤
            document.getElementById('searchInput').addEventListener('keypress', (e) => {
                if(e.key === 'Enter') executeSearch();
            });
        };

        // 1. ì§€ë„ ì´ˆê¸°í™” ë° ë§ˆì»¤ ë¡œë“œ
        function initializeMap() {
            // ëŒ€í•œë¯¼êµ­ ì¤‘ì‹¬ ì´ˆê¸°í™”
            map = L.map('map', { zoomControl: false }).setView([35.9, 127.5], 7);
            
            // OSM íƒ€ì¼ (CSS í•„í„°ë¡œ ë‹¤í¬ëª¨ë“œ ì ìš©ë¨)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            // ë§ˆì»¤ í´ëŸ¬ìŠ¤í„° ê·¸ë£¹ ìƒì„± (#upgrade: ë°ì´í„° ë°€ë„ì— ë”°ë¥¸ ìƒ‰ìƒ ë¡œì§)
            markers = L.markerClusterGroup({
                iconCreateFunction: function(cluster) {
                    var count = cluster.getChildCount();
                    var c = 'marker-cluster-small';
                    if (count >= 10) c = 'cluster-high-density'; // ë¹¨ê°•
                    else if (count >= 5) c = 'marker-cluster-medium'; // ë…¸ë‘
                    
                    return new L.DivIcon({
                        html: '<div style="width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;"><span>' + count + '</span></div>',
                        className: c,
                        iconSize: new L.Point(40, 40)
                    });
                }
            });
            
            map.addLayer(markers);
            loadEventMarkers();
        }

        // ë§ˆì»¤ ë¡œë“œ ë¡œì§
        function loadEventMarkers() {
            markers.clearLayers();
            
            mockEvents.forEach(event => {
                // êµ­ê°€ í•„í„°ë§
                if (currentCountry !== 'Memo' && event.country !== currentCountry) return;
                
                const icon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<img src="${event.img}" class="custom-marker" data-id="${event.id}">`,
                    iconSize: [64, 64],
                    iconAnchor: [32, 32]
                });

                const marker = L.marker([event.lat, event.lng], { icon: icon });
                
                // ë§ˆì»¤ ë°ì´í„° ë°”ì¸ë”©
                marker.featureData = event; 

                marker.on('click', () => {
                    showDetailSheet(event);
                    map.panTo([event.lat, event.lng], { animate: true, duration: 0.5 });
                });

                markers.addLayer(marker);
            });
        }

        // #upgrade: 3ë‹¨ ë ˆì´ì•„ì›ƒ - êµ­ê°€ íƒ­ ì„ íƒ
        function setCountry(country) {
            currentCountry = country;
            
            // íƒ­ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            ['Korea', 'Japan', 'Memo'].forEach(c => {
                const btn = document.getElementById(`btn-${c}`);
                if(c === country) {
                    btn.classList.replace('bg-gray-800', 'bg-blue-600');
                    btn.classList.replace('text-gray-400', 'text-white');
                } else {
                    btn.classList.replace('bg-blue-600', 'bg-gray-800');
                    btn.classList.replace('text-white', 'text-gray-400');
                }
            });

            renderSubTabs(); // í•˜ìœ„ íƒ­ ê°±ì‹ 
            loadEventMarkers(); // ì§€ë„ ë§ˆì»¤ ê°±ì‹ 
            
            // êµ­ê°€ ë³€ê²½ ì‹œ ì§€ë„ ì´ë™
            if(country === 'Korea') map.flyTo([35.9, 127.5], 7);
            if(country === 'Japan') map.flyTo([36.2048, 138.2529], 6);
        }

        // #upgrade: 3ë‹¨ ë ˆì´ì•„ì›ƒ - ì„œë¸Œ íƒ­ ë Œë”ë§
        function renderCountryTabs() { setCountry('Korea'); }

        function renderSubTabs() {
            const container = document.getElementById('subTabContainer');
            container.innerHTML = ''; // ì´ˆê¸°í™”

            let items = [];
            if (currentCountry === 'Korea') {
                items = ['ì „ì²´', 'ì„œìš¸', 'ê²½ê¸°', 'ê°•ì›', 'ì¶©ë‚¨', 'ì¶©ë¶', 'ì „ë‚¨', 'ì „ë¶', 'ê²½ë‚¨', 'ê²½ë¶', 'ë¶€ì‚°', 'ì œì£¼'];
            } else if (currentCountry === 'Japan') {
                items = ['ì „ì²´', 'ë„ì¿„', 'ì˜¤ì‚¬ì¹´', 'êµí† ', 'í›„ì¿ ì˜¤ì¹´', 'í™‹ì¹´ì´ë„', 'ì˜¤í‚¤ë‚˜ì™€'];
            } else {
                items = ['ìŒì‹', 'ë¬¸í™”', 'ìŒì•…', '+ ë¼ë²¨ ì¶”ê°€'];
            }

            items.forEach(item => {
                const btn = document.createElement('button');
                btn.className = 'px-3 py-1 bg-gray-800/80 backdrop-blur text-gray-300 text-xs rounded-lg border border-gray-600 hover:bg-gray-700 whitespace-nowrap transition-colors';
                btn.innerText = item;
                btn.onclick = () => filterByTagOrRegion(item);
                container.appendChild(btn);
            });
        }

        // #upgrade: ì§€ì—­/íƒœê·¸ í•„í„°ë§ ë° ë°œê´‘ íš¨ê³¼
        function filterByTagOrRegion(filter) {
            // ë¼ë²¨ ì¶”ê°€ ë¡œì§
            if(filter === '+ ë¼ë²¨ ì¶”ê°€') {
                const newLabel = prompt("ìƒˆ ë¼ë²¨ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:");
                if(newLabel) alert(`ë¼ë²¨ [${newLabel}] ìƒì„±ë¨ (DBì €ì¥ í•„ìš”)`);
                return;
            }

            // ì§€ë„ ë°œê´‘ íš¨ê³¼
            if (regionBoundaryParams[filter]) {
                showRegionGlow(filter);
            } else {
                if (regionRectangle) map.removeLayer(regionRectangle); // íš¨ê³¼ ì œê±°
            }

            // ë§ˆì»¤ í•„í„°ë§ (ê°„ë‹¨ êµ¬í˜„)
            markers.eachLayer(layer => {
                const data = layer.featureData;
                const isMatch = filter === 'ì „ì²´' || data.region === filter || data.tags.includes(filter);
                layer.setOpacity(isMatch ? 1 : 0.2); // ë¹„í•´ë‹¹ ë§ˆì»¤ íë¦¬ê²Œ ì²˜ë¦¬
            });
        }

        // #upgrade: ì§€ì—­ ê²½ê³„ ë°œê´‘ íš¨ê³¼ êµ¬í˜„
        function showRegionGlow(regionName) {
            if (regionRectangle) map.removeLayer(regionRectangle);
            
            const bounds = regionBoundaryParams[regionName];
            if (!bounds) return;

            regionRectangle = L.rectangle(bounds, {
                className: 'region-glow-path', // CSS ì• ë‹ˆë©”ì´ì…˜ ì ìš©
                weight: 2,
                color: '#ffeb3b',
                fillOpacity: 0.1
            }).addTo(map);

            map.fitBounds(bounds, { padding: [50, 50], animate: true });
        }

        // #upgrade: ë“œë˜ê·¸ ì…€ë ‰ì…˜ ë¡œì§ (Alt + Drag)
        function startSelection(e) {
            if (!e.altKey || e.button !== 0) return;
            isDragging = true;
            map.dragging.disable(); // ì§€ë„ ì´ë™ ë¹„í™œì„±í™”
            startPoint = { x: e.clientX, y: e.clientY };
            
            selectionBox.style.display = 'block';
            selectionBox.style.left = startPoint.x + 'px';
            selectionBox.style.top = startPoint.y + 'px';
            selectionBox.style.width = '0px';
            selectionBox.style.height = '0px';
        }

        function updateSelection(e) {
            if (!isDragging) return;
            
            const currentX = e.clientX;
            const currentY = e.clientY;
            
            const minX = Math.min(startPoint.x, currentX);
            const minY = Math.min(startPoint.y, currentY);
            const width = Math.abs(currentX - startPoint.x);
            const height = Math.abs(currentY - startPoint.y);
            
            selectionBox.style.left = minX + 'px';
            selectionBox.style.top = minY + 'px';
            selectionBox.style.width = width + 'px';
            selectionBox.style.height = height + 'px';
        }

        function endSelection(e) {
            if (!isDragging) return;
            isDragging = false;
            map.dragging.enable();
            selectionBox.style.display = 'none';
            
            // #upgrade: ì„ íƒ ë¡œì§ (Pixel ì¢Œí‘œ ê¸°ë°˜ êµì°¨ íŒì •)
            const boxRect = selectionBox.getBoundingClientRect();
            
            markers.eachLayer(layer => {
                const latLng = layer.getLatLng();
                const containerPoint = map.latLngToContainerPoint(latLng);
                
                // ë§ˆì»¤ê°€ ë“œë˜ê·¸ ë°•ìŠ¤ ì•ˆì— ìˆëŠ”ì§€ í™•ì¸
                if (containerPoint.x >= boxRect.left && containerPoint.x <= boxRect.right &&
                    containerPoint.y >= boxRect.top && containerPoint.y <= boxRect.bottom) {
                    
                    selectedEvents.add(layer.featureData.id);
                    // ì‹œê°ì  í”¼ë“œë°±
                    const img = layer.getElement().querySelector('img');
                    if(img) img.classList.add('marker-selected');
                }
            });
            
            console.log("Selected IDs:", Array.from(selectedEvents));
        }

        function deselectAll() {
            selectedEvents.clear();
            document.querySelectorAll('.marker-selected').forEach(el => el.classList.remove('marker-selected'));
            if(regionRectangle) map.removeLayer(regionRectangle);
        }

        // #upgrade: ë„¤ì´ë²„ ê²€ìƒ‰ ì—°ë™ (ìƒˆ íƒ­)
        function executeSearch() {
            const query = document.getElementById('searchInput').value;
            if (!query) return;
            
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥ (ìµœê·¼ ê²€ìƒ‰ì–´)
            let history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
            history.unshift(query);
            if(history.length > 5) history.pop();
            localStorage.setItem('searchHistory', JSON.stringify(history));
            
            // ì‹¤ì œ ë„¤ì´ë²„ ê²€ìƒ‰
            window.open(`https://search.naver.com/search.naver?query=${encodeURIComponent(query)}`, '_blank');
        }

        // ìƒì„¸ ì‹œíŠ¸ UI
        function showDetailSheet(event) {
            const sheet = document.getElementById('detailSheet');
            const closeBtn = document.getElementById('closeButton');
            
            document.getElementById('sheetImage').src = event.img;
            document.getElementById('sheetTitle').innerText = event.title;
            document.getElementById('sheetCountry').innerText = event.country;
            document.getElementById('sheetRegion').innerText = event.region;
            document.getElementById('sheetDesc').innerText = event.desc;
            
            const celebContainer = document.getElementById('sheetCeleb');
            celebContainer.innerHTML = event.celeb.map(c => `<span class="bg-gray-800 px-2 py-1 rounded text-xs text-blue-300 border border-blue-900">${c}</span>`).join('');
            
            const tagsContainer = document.getElementById('sheetTags');
            tagsContainer.innerHTML = event.tags.map(t => `<span class="text-gray-400 text-xs">#${t}</span>`).join(' ');

            sheet.classList.remove('translate-y-full');
        }

        function closeDetailSheet() {
            document.getElementById('detailSheet').classList.add('translate-y-full');
        }
    </script>
</body>
</html>

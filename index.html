<!DOCTYPE html>
<html lang="ko" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EventMap2 - Global Festival Map</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#0a0a0a',       // ì•„ì£¼ ê¹Šì€ ê²€ì • (ë°°ê²½)
                            surface: '#1E1E1E',  // ê¸°ë³¸ í‘œë©´ (ì¹´ë“œ, ì‹œíŠ¸)
                            elevated: '#2C2C2C', // ë„ì›Œì§„ ìš”ì†Œ (ë²„íŠ¼, ì¸í’‹)
                            border: '#404040',   // ê²½ê³„ì„ 
                            text: '#E0E0E0',     // ê¸°ë³¸ í…ìŠ¤íŠ¸
                            muted: '#A0A0A0'     // ë³´ì¡° í…ìŠ¤íŠ¸
                        }
                    },
                    animation: {
                        'pulse-glow': 'pulse-glow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        'pulse-glow': {
                            '0%, 100%': { opacity: 1, filter: 'drop-shadow(0 0 5px #ffeb3b)' },
                            '50%': { opacity: .7, filter: 'drop-shadow(0 0 15px #ffeb3b)' }
                        }
                    }
                }
            }
        }
    </script>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <!-- Leaflet Heatmap -->
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <style>
        /* ì§€ë„ ê°•ì œ ë‹¤í¬ ëª¨ë“œ í•„í„° */
        .leaflet-layer {
            filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }
        /* ë§ˆì»¤ ë“±ì€ ë°˜ì „ë˜ì§€ ì•Šë„ë¡ ì¬ë°˜ì „ */
        .leaflet-marker-icon, .leaflet-marker-shadow, .leaflet-popup, .custom-marker-img {
            filter: invert(0%) hue-rotate(0deg) brightness(100%) contrast(100%); 
        }

        /* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #121212; 
        }
        ::-webkit-scrollbar-thumb {
            background: #404040; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #505050; 
        }

        /* ë“œë˜ê·¸ ì„ íƒ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .selection-box {
            position: absolute;
            border: 2px dashed #3b82f6;
            background-color: rgba(59, 130, 246, 0.2);
            z-index: 10000; /* ì§€ë„ ìœ„ì— í‘œì‹œ */
            pointer-events: none; /* ì§€ë„ ì¡°ì‘ ë°©í•´ ê¸ˆì§€ */
            display: none;
        }

        /* ì§€ì—­ ê²½ê³„ ê¸€ë¡œìš° íš¨ê³¼ */
        .region-glow-path {
            stroke: #ffeb3b;
            stroke-width: 3;
            stroke-opacity: 0.8;
            fill: #ffeb3b;
            fill-opacity: 0.1;
            filter: drop-shadow(0 0 8px #ffeb3b);
            animation: pulse-glow 2s infinite;
        }
    </style>
</head>
<body class="bg-dark-bg text-dark-text h-screen w-screen overflow-hidden flex flex-col font-sans selection:bg-blue-500 selection:text-white">

    <!-- ìƒë‹¨ UI ì»¨í…Œì´ë„ˆ (ê²€ìƒ‰, í•„í„°, ìµœê·¼ê²€ìƒ‰) -->
    <div class="absolute top-4 left-1/2 transform -translate-x-1/2 z-[5000] w-[90%] max-w-4xl flex flex-col gap-2 pointer-events-none">
        
        <!-- 1. ê²€ìƒ‰ ë°” & í•„í„° (Pointer events í™œì„±í™”) -->
        <div class="flex flex-wrap items-center gap-2 pointer-events-auto transition-all duration-300">
            <!-- ê²€ìƒ‰ ì…ë ¥ì°½ -->
            <div class="relative group">
                <input type="text" id="searchInput" 
                    class="bg-dark-surface border border-dark-border text-dark-text rounded-full px-5 py-2 w-48 focus:w-80 transition-all duration-300 shadow-lg outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 placeholder-dark-muted text-sm"
                    placeholder="ì´ë²¤íŠ¸, ì§€ì—­, íƒœê·¸ ê²€ìƒ‰...">
                <!-- ê²€ìƒ‰ ì•„ì´ì½˜ -->
                <span class="absolute right-4 top-1/2 -translate-y-1/2 text-dark-muted group-focus-within:text-blue-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                </span>
            </div>

            <!-- êµ­ê°€ ì„ íƒ (2ë‹¨ í•„í„°ì˜ ì‹œì‘) -->
            <select id="countryFilter" class="bg-dark-surface border border-dark-border text-dark-text rounded-full px-4 py-2 text-sm shadow-lg outline-none cursor-pointer hover:bg-dark-elevated">
                <option value="all">ğŸŒ ì „ì²´ êµ­ê°€</option>
                <option value="Korea">ğŸ‡°ğŸ‡· í•œêµ­</option>
                <option value="Japan">ğŸ‡¯ğŸ‡µ ì¼ë³¸</option>
            </select>

            <!-- ì§€ì—­ ì„ íƒ (êµ­ê°€ ì„ íƒì— ë”°ë¼ ë™ì  ë³€ê²½) -->
            <select id="regionFilter" class="hidden bg-dark-surface border border-dark-border text-dark-text rounded-full px-4 py-2 text-sm shadow-lg outline-none cursor-pointer hover:bg-dark-elevated">
                <option value="all">ì „ì²´ ì§€ì—­</option>
            </select>

            <!-- í…Œë§ˆ í•„í„° ë²„íŠ¼ë“¤ -->
            <div class="flex gap-1" id="themeFilters">
                <button class="filter-btn bg-dark-surface border border-dark-border px-3 py-1.5 rounded-full text-xs hover:bg-dark-elevated shadow-md transition-colors" data-tag="food">ğŸ± ìŒì‹</button>
                <button class="filter-btn bg-dark-surface border border-dark-border px-3 py-1.5 rounded-full text-xs hover:bg-dark-elevated shadow-md transition-colors" data-tag="culture">ğŸ­ ë¬¸í™”</button>
                <button class="filter-btn bg-dark-surface border border-dark-border px-3 py-1.5 rounded-full text-xs hover:bg-dark-elevated shadow-md transition-colors" data-tag="music">ğŸµ ìŒì•…</button>
            </div>

            <!-- ì»¤ìŠ¤í…€ ë¼ë²¨ ì¶”ê°€ ë²„íŠ¼ -->
            <button id="addLabelBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-full text-xs shadow-md transition-colors flex items-center gap-1">
                <span>+ ë¼ë²¨</span>
            </button>
        </div>

        <!-- 2. ìµœê·¼ ê²€ìƒ‰ì–´ (ê°€ë¡œ ìŠ¤í¬ë¡¤) -->
        <div id="recentSearches" class="flex gap-2 overflow-x-auto pointer-events-auto py-1 scrollbar-hide opacity-90">
            <!-- JSë¡œ ë™ì  ì¶”ê°€ë¨ -->
        </div>

        <!-- 3. ì„ íƒëœ ë§ˆì»¤ ì‘ì—… íˆ´ë°” (Alt ë“œë˜ê·¸ ì‹œ í‘œì‹œ) -->
        <div id="selectionToolbar" class="hidden bg-dark-elevated border border-blue-500/50 rounded-lg p-3 shadow-2xl flex items-center gap-3 pointer-events-auto animate-fade-in-up">
            <span class="text-sm font-bold text-blue-400"><span id="selectedCount">0</span>ê°œ ì„ íƒë¨</span>
            <div class="h-4 w-px bg-dark-border"></div>
            <button class="text-xs bg-dark-surface hover:bg-gray-700 px-2 py-1 rounded text-white">íƒœê·¸ ì¶”ê°€</button>
            <button class="text-xs bg-red-900/50 hover:bg-red-900 text-red-200 px-2 py-1 rounded">ì‚­ì œ</button>
            <span class="text-[10px] text-gray-500 ml-auto">ESC ë˜ëŠ” Alt ë–¼ë©´ í•´ì œ</span>
        </div>
    </div>

    <!-- ì§€ë„ ì»¨í…Œì´ë„ˆ -->
    <div id="map" class="flex-1 w-full h-full z-0 outline-none"></div>

    <!-- ë“œë˜ê·¸ ì„ íƒ ë°•ìŠ¤ DOM -->
    <div id="selectionBox" class="selection-box"></div>

    <!-- í•˜ë‹¨ ìƒì„¸ ì •ë³´ ì‹œíŠ¸ (Detail Sheet) -->
    <div id="detailSheet" class="fixed bottom-0 left-0 right-0 bg-dark-surface rounded-t-2xl shadow-[0_-5px_20px_rgba(0,0,0,0.5)] transform translate-y-full transition-transform duration-300 z-[6000] max-h-[40vh] border-t border-dark-border">
        <!-- ë‹«ê¸° ë²„íŠ¼ -->
        <button id="closeSheet" class="absolute top-3 right-4 text-dark-muted hover:text-white bg-dark-elevated p-1 rounded-full z-10">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
        
        <!-- í•¸ë“¤ë°” -->
        <div class="w-full h-6 flex justify-center items-center cursor-pointer" id="sheetHandle">
            <div class="w-12 h-1.5 bg-dark-border rounded-full"></div>
        </div>

        <!-- ì»¨í…ì¸  ì˜ì—­ -->
        <div class="p-5 pt-0 overflow-y-auto h-full pb-10 flex gap-5">
            <!-- ì´ë¯¸ì§€ (ë¹„ìœ¨ ìœ ì§€, ê¹¨ì§ ë°©ì§€) -->
            <div class="w-1/3 max-w-[180px] flex-shrink-0">
                <img id="detailImage" src="" alt="Festival Image" class="w-full aspect-[4/3] object-cover rounded-lg shadow-md border border-dark-border bg-dark-elevated">
            </div>
            
            <!-- í…ìŠ¤íŠ¸ ì •ë³´ -->
            <div class="flex-1 flex flex-col gap-1">
                <div class="flex items-start justify-between">
                    <div>
                        <span id="detailCountry" class="text-[10px] uppercase tracking-wider text-blue-400 font-bold mb-1 block">Country</span>
                        <h2 id="detailTitle" class="text-xl font-bold text-white leading-tight">ì¶•ì œ ì œëª©</h2>
                    </div>
                    <span id="detailRegion" class="bg-dark-elevated text-dark-muted text-xs px-2 py-1 rounded border border-dark-border">ì§€ì—­</span>
                </div>
                
                <p id="detailDesc" class="text-sm text-dark-muted mt-2 line-clamp-2">ì¶•ì œ ì„¤ëª…ì´ ì—¬ê¸°ì— ë“¤ì–´ê°‘ë‹ˆë‹¤.</p>
                
                <div class="mt-3 flex flex-wrap gap-1" id="detailTags">
                    <!-- íƒœê·¸ ë°°ì§€ ë™ì  ì‚½ì… -->
                </div>

                <div class="mt-3 pt-3 border-t border-dark-border">
                    <p class="text-xs text-dark-muted">ğŸ¤ Special Guests</p>
                    <p id="detailCeleb" class="text-sm text-white font-medium">ì´ˆì²­ ê²ŒìŠ¤íŠ¸ ëª…ë‹¨</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet & Plugin Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <script>
        // --------------------------------------------------------
        // 2. ë°ì´í„° (Data) - í•œêµ­ ë° ì¼ë³¸ ì¶•ì œ/ë§ˆì¸ ë¦¬ ë°ì´í„°
        // --------------------------------------------------------
        const mockEvents = [
            // --- í•œêµ­ (Korea) ---
            { id: 1, title: 'ì„œìš¸ ë¶ˆê½ƒì¶•ì œ', lat: 37.525, lng: 126.926, country: 'Korea', region: 'Seoul', tags: ['culture', 'fireworks'], desc: 'ì—¬ì˜ë„ í•œê°•ê³µì›ì—ì„œ í¼ì³ì§€ëŠ” ì„¸ê³„ì ì¸ ë¶ˆê½ƒì¶•ì œ.', celeb: 'ë‰´ì§„ìŠ¤', imageUrl: 'https://via.placeholder.com/300x200/1e1e1e/ffffff?text=Seoul+Fireworks' },
            { id: 2, title: 'ë¶€ì‚° êµ­ì œì˜í™”ì œ', lat: 35.171, lng: 129.127, country: 'Korea', region: 'Busan', tags: ['culture', 'movie'], desc: 'ì•„ì‹œì•„ ìµœëŒ€ ê·œëª¨ì˜ ì˜í™”ì œ, í•´ìš´ëŒ€ì™€ ì„¼í…€ì‹œí‹°.', celeb: 'ì†¡ê°•í˜¸, íƒ•ì›¨ì´', imageUrl: 'https://via.placeholder.com/300x200/1e1e1e/ffffff?text=BIFF' },
            { id: 3, title: 'ë³´ë ¹ ë¨¸ë“œì¶•ì œ', lat: 36.315, lng: 126.516, country: 'Korea', region: 'Chungnam', tags: ['activity', 'summer'], desc: 'ëŒ€ì²œí•´ìˆ˜ìš•ì¥ì—ì„œ ì¦ê¸°ëŠ” ì„¸ê³„ì¸ì˜ ë¨¸ë“œ ì²´í—˜.', celeb: 'ì‹¸ì´', imageUrl: 'https://via.placeholder.com/300x200/1e1e1e/ffffff?text=Mud+Festival' },
            { id: 4, title: 'ì§„ì£¼ ë‚¨ê°•ìœ ë“±ì¶•ì œ', lat: 35.180, lng: 128.085, country: 'Korea', region: 'Gyeongnam', tags: ['culture', 'light'], desc: 'ë‚¨ê°• ìœ„ì— ë„ìš°ëŠ” ì•„ë¦„ë‹¤ìš´ ìœ ë“±ì˜ í–¥ì—°.', celeb: 'ì§€ì—­ ì˜ˆìˆ ë‹¨', imageUrl: 'https://via.placeholder.com/300x200/1e1e1e/ffffff?text=Jinju+Lantern' },
            { id: 5, title: 'ì „ì£¼ ë¹„ë¹”ë°¥ì¶•ì œ', lat: 35.814, lng: 127.152, country: 'Korea', region: 'Jeonbuk', tags: ['food'], desc: 'ì „ì£¼ í•œì˜¥ë§ˆì„ì—ì„œ ì¦ê¸°ëŠ” ë¯¸ì‹ ì¶•ì œ.', celeb: 'ë°±ì¢…ì›(ì´ˆì²­)', imageUrl: 'https://via.placeholder.com/300x200/1e1e1e/ffffff?text=Bibimbap' },
            { id: 6, title: 'ì•ˆë™ êµ­ì œíƒˆì¶¤í˜ìŠ¤í‹°ë²Œ', lat: 36.563, lng: 128.723, country: 'Korea', region: 'Gyeongbuk', tags: ['culture', 'dance'], desc: 'ì„¸ê³„ ê°êµ­ì˜ íƒˆì¶¤ì„ í•œìë¦¬ì—ì„œ.', celeb: '-', imageUrl: 'https://via.placeholder.com/300x200/1e1e1e/ffffff?text=Mask+Dance' },
            { id: 7, title: 'ì œì£¼ ë“¤ë¶ˆì¶•ì œ', lat: 33.366, lng: 126.355, country: 'Korea', region: 'Jeju', tags: ['culture', 'fire'], desc: 'ìƒˆë³„ì˜¤ë¦„ ì „ì²´ë¥¼ íƒœìš°ë©° ì†Œì›ì„ ë¹„ëŠ” ì¶•ì œ.', celeb: '-', imageUrl: 'https://via.placeholder.com/300x200/1e1e1e/ffffff?text=Jeju+Fire' },
            { id: 8, title: 'í™”ì²œ ì‚°ì²œì–´ì¶•ì œ', lat: 38.106, lng: 127.705, country: 'Korea', region: 'Gangwon', tags: ['activity', 'winter'], desc: 'ì–¼ìŒ ìœ„ì—ì„œ ì¦ê¸°ëŠ” ë‚šì‹œ ì²´í—˜.', celeb: '-', imageUrl: 'https://via.placeholder.com/300x200/1e1e1e/ffffff?text=Ice+Fishing' },
            { id: 9, title: 'ìë¼ì„¬ ì¬ì¦ˆí˜ìŠ¤í‹°ë²Œ', lat: 37.816, lng: 127.513, country: 'Korea', region: 'Gyeonggi', tags: ['music', 'jazz'], desc: 'ê°€í‰ ìë¼ì„¬ì—ì„œ ì—´ë¦¬ëŠ” ë‚­ë§Œì ì¸ ì¬ì¦ˆ ì¶•ì œ.', celeb: 'ë‚˜ìœ¤ì„ ', imageUrl: 'https://via.placeholder.com/300x200/1e1e1e/ffffff?text=Jazz+Festival' },
            
            // --- ì¼ë³¸ (Japan) ---
            { id: 101, title: 'ê¸°ì˜¨ ë§ˆì¸ ë¦¬', lat: 35.003, lng: 135.768, country: 'Japan', region: 'Kyoto', tags: ['culture', 'history'], desc: 'êµí†  ì•¼ì‚¬ì¹´ ì‹ ì‚¬ì˜ ì œë¡€ë¡œ ì¼ë³¸ 3ëŒ€ ë§ˆì¸ ë¦¬ ì¤‘ í•˜ë‚˜.', celeb: '-', imageUrl: 'https://via.placeholder.com/300x200/1e1e1e/ffffff?text=Gion+Matsuri' },
            { id: 102, title: 'í…ì§„ ë§ˆì¸ ë¦¬', lat: 34.696, lng: 135.519, country: 'Japan', region: 'Osaka', tags: ['culture', 'fireworks'], desc: 'ì˜¤ì‚¬ì¹´ í…ë§Œêµ¬ ì‹ ì‚¬, ë°° ìœ„ì—ì„œ í¼ì³ì§€ëŠ” ë¶ˆê½ƒë†€ì´.', celeb: '-', imageUrl: 'https://via.placeholder.com/300x200/1e1e1e/ffffff?text=Tenjin+Matsuri' },
            { id: 103, title: 'ì¹¸ë‹¤ ë§ˆì¸ ë¦¬', lat: 35.702, lng: 139.768, country: 'Japan', region: 'Tokyo', tags: ['culture'], desc: 'ì—ë„ ì‹œëŒ€ë¶€í„° ì´ì–´ì ¸ ì˜¨ ë„ì¿„ì˜ ëŒ€í‘œ ë§ˆì¸ ë¦¬.', celeb: '-', imageUrl: 'https://via.placeholder.com/300x200/1e1e1e/ffffff?text=Kanda+Matsuri' },
            { id: 104, title: 'ì‚¿í¬ë¡œ ëˆˆì¶•ì œ', lat: 43.061, lng: 141.354, country: 'Japan', region: 'Hokkaido', tags: ['winter', 'art'], desc: 'ì˜¤ë„ë¦¬ ê³µì›ì— ì „ì‹œë˜ëŠ” ê±°ëŒ€í•œ ëˆˆ ì¡°ê°ë“¤.', celeb: '-', imageUrl: 'https://via.placeholder.com/300x200/1e1e1e/ffffff?text=Sapporo+Snow' },
            { id: 105, title: 'í•˜ì¹´íƒ€ ëˆíƒ€ì¿ ', lat: 33.593, lng: 130.404, country: 'Japan', region: 'Fukuoka', tags: ['culture', 'parade'], desc: 'ê³¨ë“ ìœ„í¬ ê¸°ê°„ í›„ì¿ ì˜¤ì¹´ ì‹œë¯¼ë“¤ì´ ì°¸ì—¬í•˜ëŠ” í¼ë ˆì´ë“œ.', celeb: '-', imageUrl: 'https://via.placeholder.com/300x200/1e1e1e/ffffff?text=Dontaku' },
            { id: 106, title: 'ë‚˜í•˜ ì˜¤ì˜¤ì¸ ë‚˜íˆí‚¤', lat: 26.212, lng: 127.679, country: 'Japan', region: 'Okinawa', tags: ['culture', 'activity'], desc: 'ê¸°ë„¤ìŠ¤ë¶ì— ë“±ì¬ëœ ê±°ëŒ€í•œ ì¤„ë‹¤ë¦¬ê¸° í–‰ì‚¬.', celeb: '-', imageUrl: 'https://via.placeholder.com/300x200/1e1e1e/ffffff?text=Okinawa+Rope' },
            { id: 107, title: 'ì„¬ë¨¸ ì†Œë‹‰', lat: 35.644, lng: 140.035, country: 'Japan', region: 'Tokyo', tags: ['music', 'rock'], desc: 'ë„ì¿„ì™€ ì˜¤ì‚¬ì¹´ì—ì„œ ë™ì‹œì— ì—´ë¦¬ëŠ” ëŒ€í˜• ë¡ í˜ìŠ¤í‹°ë²Œ.', celeb: 'Kendrick Lamar', imageUrl: 'https://via.placeholder.com/300x200/1e1e1e/ffffff?text=Summer+Sonic' }
        ];

        // ì§€ì—­ë³„ ê²½ê³„(Bounds) íŒŒë¼ë¯¸í„° (ë‹¨ìˆœ ë°•ìŠ¤ í˜•íƒœ ë˜ëŠ” SVG Polygonìš© ì¢Œí‘œ ëŒ€ëµê°’)
        // ì‹¤ì œ GeoJSON ëŒ€ì‹  ê°„ëµí™”ëœ ì¢Œí‘œ ë²”ìœ„ë¥¼ ì‚¬ìš©í•˜ì—¬ SVG Glow íš¨ê³¼ ì ìš©
        const regionBoundaryParams = {
            'Seoul': { latMin: 37.42, latMax: 37.70, lngMin: 126.76, lngMax: 127.18 },
            'Busan': { latMin: 35.03, latMax: 35.39, lngMin: 128.80, lngMax: 129.30 },
            'Gangwon': { latMin: 37.03, latMax: 38.61, lngMin: 127.13, lngMax: 129.35 },
            'Jeju': { latMin: 33.10, latMax: 33.60, lngMin: 126.10, lngMax: 127.00 },
            'Tokyo': { latMin: 35.50, latMax: 35.83, lngMin: 138.90, lngMax: 139.95 },
            'Osaka': { latMin: 34.40, latMax: 34.80, lngMin: 135.30, lngMax: 135.70 },
            // ... ë‚˜ë¨¸ì§€ ì§€ì—­ë„ í•„ìš” ì‹œ ì¶”ê°€
        };

        // --------------------------------------------------------
        // 3. ì „ì—­ ë³€ìˆ˜ ë° ì´ˆê¸°í™”
        // --------------------------------------------------------
        let map;
        let markersCluster;
        let heatLayer;
        let currentMarkers = []; // í˜„ì¬ í•„í„°ë§ëœ ë§ˆì»¤ ë¦¬ìŠ¤íŠ¸
        let selectedMarkers = new Set(); // Alt ë“œë˜ê·¸ë¡œ ì„ íƒëœ ë§ˆì»¤ IDs
        let boundaryLayer = null; // ì§€ì—­ ê²½ê³„ ë ˆì´ì–´

        // ë“œë˜ê·¸ ì„ íƒ ê´€ë ¨
        let isDragSelecting = false;
        let dragStartPoint = null;
        let selectionBoxDiv = document.getElementById('selectionBox');

        window.onload = initializeMap;

        function initializeMap() {
            // 1. ë§µ ìƒì„± (ëŒ€í•œë¯¼êµ­ ì¤‘ì‹¬)
            map = L.map('map', {
                center: [35.9, 127.5],
                zoom: 7,
                zoomControl: false, // ì¤Œ ì»¨íŠ¸ë¡¤ ìœ„ì¹˜ ì»¤ìŠ¤í…€ ê°€ëŠ¥ì„±ì„ ìœ„í•´ ì¼ë‹¨ ë” (í•„ìš”ì‹œ true)
                preferCanvas: true // ì„±ëŠ¥ ìµœì í™”
            });

            // 2. íƒ€ì¼ ë ˆì´ì–´ (OpenStreetMap)
            // í•„í„°ë§ì€ CSS(.leaflet-layer)ì—ì„œ ì²˜ë¦¬í•˜ì—¬ ë‹¤í¬ëª¨ë“œ êµ¬í˜„
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // 3. í´ëŸ¬ìŠ¤í„° ê·¸ë£¹ ìƒì„±
            markersCluster = L.markerClusterGroup({
                showCoverageOnHover: false,
                maxClusterRadius: 50, // í´ëŸ¬ìŠ¤í„°ë§ ë²”ìœ„
                iconCreateFunction: function(cluster) {
                    // í´ëŸ¬ìŠ¤í„° ì•„ì´ì½˜ë„ ë‹¤í¬ í…Œë§ˆì— ë§ê²Œ ì»¤ìŠ¤í…€ ê°€ëŠ¥
                    var childCount = cluster.getChildCount();
                    var c = ' marker-cluster-';
                    if (childCount < 10) { c += 'small'; }
                    else if (childCount < 100) { c += 'medium'; }
                    else { c += 'large'; }

                    return new L.DivIcon({ 
                        html: '<div><span>' + childCount + '</span></div>', 
                        className: 'marker-cluster' + c, 
                        iconSize: new L.Point(40, 40) 
                    });
                }
            });
            map.addLayer(markersCluster);

            // 4. íˆíŠ¸ë§µ ë ˆì´ì–´ ì¤€ë¹„ (ì´ˆê¸°ëŠ” ë¹„í™œì„±)
            // ë¹¨ê°„ìƒ‰ ìœ„ì£¼ë¡œ ì„¤ì • (0.0~1.0 ì‚¬ì´ ê°’)
            heatLayer = L.heatLayer([], {
                radius: 25,
                blur: 15,
                gradient: { 0.4: 'blue', 0.65: 'lime', 1: 'red' } // ë¹¨ê°„ìƒ‰ ê°•ì¡°
            });

            // 5. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            setupEventListeners();
            
            // 6. ë§ˆì»¤ ë¡œë“œ
            loadEventMarkers(mockEvents);

            // 7. ìµœê·¼ ê²€ìƒ‰ì–´ ë¡œë“œ
            loadRecentSearches();

            // 8. ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ ì‹œê°í™” ë³€ê²½ (í´ëŸ¬ìŠ¤í„° <-> íˆíŠ¸ë§µ)
            map.on('zoomend', toggleHeatmap);
        }

        // --------------------------------------------------------
        // 4. ë¡œì§ ë° ê¸°ëŠ¥ êµ¬í˜„
        // --------------------------------------------------------

        function loadEventMarkers(events) {
            markersCluster.clearLayers();
            currentMarkers = []; // ë¦¬ì…‹

            // íˆíŠ¸ë§µ ë°ì´í„° ìˆ˜ì§‘ìš©
            const heatData = [];

            events.forEach(evt => {
                // ì»¤ìŠ¤í…€ ë§ˆì»¤ ì•„ì´ì½˜ ìƒì„±
                const iconHtml = `
                    <div class="relative w-12 h-12 rounded-full border-2 border-white shadow-lg overflow-hidden transform hover:scale-110 transition-transform custom-marker-img group ${selectedMarkers.has(evt.id) ? 'ring-4 ring-blue-500' : ''}">
                        <img src="${evt.imageUrl}" class="w-full h-full object-cover bg-[#202124]" alt="${evt.title}">
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all"></div>
                    </div>
                `;

                const customIcon = L.divIcon({
                    html: iconHtml,
                    className: '', // ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì œê±°
                    iconSize: [48, 48],
                    iconAnchor: [24, 24]
                });

                const marker = L.marker([evt.lat, evt.lng], { icon: customIcon });
                
                // ë§ˆì»¤ ê°ì²´ì— ë°ì´í„° ë°”ì¸ë”©
                marker.featureData = evt; 

                // í´ë¦­ ì´ë²¤íŠ¸
                marker.on('click', () => {
                    showDetailSheet(evt);
                    
                    // ì§€ì—­ ê¸€ë¡œìš° íš¨ê³¼ íŠ¸ë¦¬ê±° (ìˆëŠ” ê²½ìš°)
                    if(evt.region && regionBoundaryParams[evt.region]) {
                        highlightRegion(evt.region);
                    }
                });

                markersCluster.addLayer(marker);
                currentMarkers.push(marker);
                heatData.push([evt.lat, evt.lng, 1]); // intensity 1
            });

            // íˆíŠ¸ë§µ ë°ì´í„° ì—…ë°ì´íŠ¸
            heatLayer.setLatLngs(heatData);
        }

        // ì§€ì—­ë³„ í•„í„°ë§ (êµ­ê°€ ì„ íƒ ì‹œ ë™ì  ìƒì„±)
        function updateRegionOptions(countryCode) {
            const regionSelect = document.getElementById('regionFilter');
            regionSelect.innerHTML = '<option value="all">ì „ì²´ ì§€ì—­</option>';
            
            if (countryCode === 'all') {
                regionSelect.classList.add('hidden');
                return;
            }

            regionSelect.classList.remove('hidden');
            
            // í•´ë‹¹ êµ­ê°€ì˜ ì§€ì—­ë§Œ ì¶”ì¶œ (ì¤‘ë³µ ì œê±°)
            const regions = [...new Set(mockEvents.filter(e => e.country === countryCode).map(e => e.region))];
            
            regions.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r;
                opt.textContent = r;
                regionSelect.appendChild(opt);
            });
        }

        // í•„í„°ë§ ì ìš© í•¨ìˆ˜
        function applyFilters() {
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            const country = document.getElementById('countryFilter').value;
            const region = document.getElementById('regionFilter').value;
            
            // í™œì„±í™”ëœ í…Œë§ˆ íƒœê·¸ í™•ì¸
            const activeThemes = Array.from(document.querySelectorAll('#themeFilters .filter-btn.ring-2'))
                                     .map(btn => btn.dataset.tag);

            const filtered = mockEvents.filter(evt => {
                const matchKeyword = evt.title.toLowerCase().includes(keyword) || 
                                     evt.tags.some(t => t.includes(keyword)) ||
                                     evt.region.toLowerCase().includes(keyword);
                
                const matchCountry = country === 'all' || evt.country === country;
                const matchRegion = region === 'all' || evt.region === region;
                
                // í…Œë§ˆ: ì„ íƒëœ ê²Œ ì—†ìœ¼ë©´ í†µê³¼, ìˆìœ¼ë©´ í•˜ë‚˜ë¼ë„ ê²¹ì¹˜ë©´ í†µê³¼(OR)
                const matchTheme = activeThemes.length === 0 || 
                                   activeThemes.some(t => evt.tags.includes(t));

                return matchKeyword && matchCountry && matchRegion && matchTheme;
            });

            loadEventMarkers(filtered);
            
            // ê²€ìƒ‰ì–´ ì €ì¥ (í‚¤ì›Œë“œê°€ ìˆì„ ë•Œë§Œ)
            if (keyword.length > 1) saveRecentSearch(keyword);
        }

        // --------------------------------------------------------
        // 5. ì‹œê°í™” ë° UI íš¨ê³¼ (Visualization)
        // --------------------------------------------------------

        // ìƒì„¸ ì‹œíŠ¸ í‘œì‹œ
        function showDetailSheet(data) {
            const sheet = document.getElementById('detailSheet');
            
            document.getElementById('detailImage').src = data.imageUrl;
            document.getElementById('detailTitle').textContent = data.title;
            document.getElementById('detailDesc').textContent = data.desc;
            document.getElementById('detailCeleb').textContent = data.celeb;
            document.getElementById('detailCountry').textContent = data.country;
            document.getElementById('detailRegion').textContent = data.region;

            // íƒœê·¸ ë Œë”ë§
            const tagContainer = document.getElementById('detailTags');
            tagContainer.innerHTML = '';
            data.tags.forEach(tag => {
                const span = document.createElement('span');
                span.className = 'text-[10px] bg-blue-900 text-blue-100 px-2 py-0.5 rounded-full border border-blue-700';
                span.textContent = '#' + tag;
                tagContainer.appendChild(span);
            });

            // ì‹œíŠ¸ ì˜¬ë¦¬ê¸°
            sheet.classList.remove('translate-y-full');
            
            // ë§µ ì¤‘ì‹¬ ì´ë™ (ì‚´ì§ ì•„ë˜ë¡œ ê³µê°„ í™•ë³´)
            map.panTo([data.lat, data.lng]);
        }

        // ì§€ì—­ ê²½ê³„ ê¸€ë¡œìš° íš¨ê³¼ (íŒŒë¼ë¯¸í„° ê¸°ë°˜)
        function highlightRegion(regionName) {
            if (boundaryLayer) {
                map.removeLayer(boundaryLayer);
                boundaryLayer = null;
            }

            const bounds = regionBoundaryParams[regionName];
            if (!bounds) return;

            // ì‚¬ê°í˜• ì¢Œí‘œ ìƒì„±
            const boundsObj = [[bounds.latMin, bounds.lngMin], [bounds.latMax, bounds.lngMax]];
            
            // SVG ìŠ¤íƒ€ì¼ì˜ ì‚¬ê°í˜• ê·¸ë¦¬ê¸° (L.rectangle)
            boundaryLayer = L.rectangle(boundsObj, {
                className: 'region-glow-path', // CSS Animation ì ìš©
                color: 'transparent', // CSS strokeë¡œ ì œì–´
                weight: 0,
                fill: false
            }).addTo(map);

            // ë§µ ë·° ë§ì¶”ê¸° (íŒ¨ë”© ì¶”ê°€í•˜ì—¬ ë‹µë‹µí•¨ í•´ì†Œ)
            map.fitBounds(boundsObj, { padding: [50, 50], animate: true, duration: 1.5 });
        }

        // ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ íˆíŠ¸ë§µ/í´ëŸ¬ìŠ¤í„° ì „í™˜
        function toggleHeatmap() {
            const zoom = map.getZoom();
            // ì¤Œ ë ˆë²¨ì´ 5 ì´í•˜(ì¶•ì†Œë¨)ì¼ ë•Œ íˆíŠ¸ë§µ í™œì„±í™”, ì‚°ì ë„ íš¨ê³¼
            if (zoom <= 5) {
                if (!map.hasLayer(heatLayer)) map.addLayer(heatLayer);
                if (map.hasLayer(markersCluster)) map.removeLayer(markersCluster);
            } else {
                if (map.hasLayer(heatLayer)) map.removeLayer(heatLayer);
                if (!map.hasLayer(markersCluster)) map.addLayer(markersCluster);
            }
        }

        // ìµœê·¼ ê²€ìƒ‰ì–´ ê´€ë¦¬ (LocalStorage)
        function saveRecentSearch(keyword) {
            let searches = JSON.parse(localStorage.getItem('recentSearches') || '[]');
            // ì¤‘ë³µ ì œê±° ë° ìµœì‹ í™”
            searches = searches.filter(s => s !== keyword);
            searches.unshift(keyword);
            if (searches.length > 5) searches.pop(); // ìµœëŒ€ 5ê°œ
            
            localStorage.setItem('recentSearches', JSON.stringify(searches));
            loadRecentSearches();
        }

        function loadRecentSearches() {
            const container = document.getElementById('recentSearches');
            const searches = JSON.parse(localStorage.getItem('recentSearches') || '[]');
            
            container.innerHTML = '';
            searches.forEach(word => {
                const chip = document.createElement('button');
                chip.className = 'flex-shrink-0 bg-dark-surface border border-dark-border text-dark-muted text-xs px-3 py-1 rounded-full hover:bg-dark-elevated hover:text-white transition-colors';
                chip.textContent = word;
                chip.onclick = () => {
                    document.getElementById('searchInput').value = word;
                    applyFilters();
                };
                container.appendChild(chip);
            });
        }

        // --------------------------------------------------------
        // 6. ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì„¤ì • (Alt ë“œë˜ê·¸, UI ì¸í„°ë™ì…˜)
        // --------------------------------------------------------
        function setupEventListeners() {
            // ìƒì„¸ ì‹œíŠ¸ ë‹«ê¸°
            document.getElementById('closeSheet').addEventListener('click', () => {
                document.getElementById('detailSheet').classList.add('translate-y-full');
            });

            // ê²€ìƒ‰ ì…ë ¥ & ì—”í„°
            document.getElementById('searchInput').addEventListener('keyup', (e) => {
                if (e.key === 'Enter') applyFilters();
            });

            // êµ­ê°€ ë³€ê²½ -> ì§€ì—­ ì˜µì…˜ ê°±ì‹ 
            document.getElementById('countryFilter').addEventListener('change', (e) => {
                updateRegionOptions(e.target.value);
                applyFilters();
            });

            // ì§€ì—­ ë³€ê²½
            document.getElementById('regionFilter').addEventListener('change', applyFilters);

            // í…Œë§ˆ íƒœê·¸ ë²„íŠ¼ í† ê¸€
            document.querySelectorAll('#themeFilters .filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.classList.toggle('bg-blue-600');
                    btn.classList.toggle('text-white');
                    btn.classList.toggle('ring-2');
                    btn.classList.toggle('ring-blue-400');
                    applyFilters(); // í•„í„° ì ìš©
                });
            });

            // ---------------------------
            // ë“œë˜ê·¸ ì„ íƒ (Box Select) ë¡œì§
            // ---------------------------
            const mapContainer = document.getElementById('map');

            document.addEventListener('keydown', (e) => {
                // Alt í‚¤ ëˆ„ë¥´ë©´ ë“œë˜ê·¸ ëª¨ë“œ í™œì„±í™” ì»¤ì„œ ë³€ê²½
                if (e.altKey) mapContainer.style.cursor = 'crosshair';
            });

            document.addEventListener('keyup', (e) => {
                if (!e.altKey) {
                    mapContainer.style.cursor = '';
                    // Alt ë–¼ë©´ ì„ íƒ í•´ì œ (ìš”ì²­ì‚¬í•­)
                    clearSelection();
                }
            });

            mapContainer.addEventListener('mousedown', (e) => {
                if (e.altKey) {
                    isDragSelecting = true;
                    map.dragging.disable(); // ì§€ë„ ë“œë˜ê·¸ ë°©ì§€
                    
                    const rect = mapContainer.getBoundingClientRect();
                    dragStartPoint = {
                        x: e.clientX - rect.left,
                        y: e.clientY - rect.top,
                        latLng: map.containerPointToLatLng([e.clientX - rect.left, e.clientY - rect.top])
                    };

                    selectionBoxDiv.style.left = dragStartPoint.x + 'px';
                    selectionBoxDiv.style.top = dragStartPoint.y + 'px';
                    selectionBoxDiv.style.width = '0px';
                    selectionBoxDiv.style.height = '0px';
                    selectionBoxDiv.style.display = 'block';
                }
            });

            mapContainer.addEventListener('mousemove', (e) => {
                if (isDragSelecting && dragStartPoint) {
                    const rect = mapContainer.getBoundingClientRect();
                    const currentX = e.clientX - rect.left;
                    const currentY = e.clientY - rect.top;

                    const width = Math.abs(currentX - dragStartPoint.x);
                    const height = Math.abs(currentY - dragStartPoint.y);
                    const left = Math.min(currentX, dragStartPoint.x);
                    const top = Math.min(currentY, dragStartPoint.y);

                    selectionBoxDiv.style.width = width + 'px';
                    selectionBoxDiv.style.height = height + 'px';
                    selectionBoxDiv.style.left = left + 'px';
                    selectionBoxDiv.style.top = top + 'px';
                }
            });

            document.addEventListener('mouseup', (e) => {
                if (isDragSelecting) {
                    finishDragSelection();
                }
            });
        }

        function finishDragSelection() {
            isDragSelecting = false;
            map.dragging.enable();
            selectionBoxDiv.style.display = 'none';

            if (!dragStartPoint) return;

            // ì„ íƒ ë°•ìŠ¤ì˜ í™”ë©´ ì¢Œí‘œ -> ìœ„ê²½ë„ ë³€í™˜ (Leaflet map bounds ì´ìš©)
            const bounds = map.getBounds(); // í˜„ì¬ ë³´ì´ëŠ” í™”ë©´ ì „ì²´
            
            // ì‹œê°ì  ë°•ìŠ¤ì˜ LatLng Bounds ê³„ì‚° (ì •í™•í•œ êµ¬í˜„ì„ ìœ„í•´ containerPointToLatLng ì‚¬ìš© ê¶Œì¥)
            const boxRect = selectionBoxDiv.getBoundingClientRect();
            const mapRect = document.getElementById('map').getBoundingClientRect();
            
            const nw = map.containerPointToLatLng([
                parseFloat(selectionBoxDiv.style.left), 
                parseFloat(selectionBoxDiv.style.top)
            ]);
            const se = map.containerPointToLatLng([
                parseFloat(selectionBoxDiv.style.left) + parseFloat(selectionBoxDiv.style.width), 
                parseFloat(selectionBoxDiv.style.top) + parseFloat(selectionBoxDiv.style.height)
            ]);

            const selectionBounds = L.latLngBounds(nw, se);

            // ë²”ìœ„ ë‚´ ë§ˆì»¤ ì°¾ê¸°
            let newSelected = 0;
            currentMarkers.forEach(marker => {
                if (selectionBounds.contains(marker.getLatLng())) {
                    selectedMarkers.add(marker.featureData.id);
                    newSelected++;
                }
            });

            updateSelectionUI();
        }

        function clearSelection() {
            selectedMarkers.clear();
            updateSelectionUI();
        }

        function updateSelectionUI() {
            const count = selectedMarkers.size;
            const toolbar = document.getElementById('selectionToolbar');
            
            if (count > 0) {
                toolbar.classList.remove('hidden');
                document.getElementById('selectedCount').textContent = count;
            } else {
                toolbar.classList.add('hidden');
            }

            // ë§ˆì»¤ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ (ì„ íƒëœ ê²ƒ í•˜ì´ë¼ì´íŠ¸)
            // ì„±ëŠ¥ì„ ìœ„í•´ ì „ì²´ ë‹¤ì‹œ ë¡œë“œ ëŒ€ì‹  DOM ì¡°ì‘ ê¶Œì¥í•˜ë‚˜, ì—¬ê¸°ì„  ê°„ë‹¨íˆ loadEventMarkers ì¬í˜¸ì¶œ ë°©ì‹ ì‚¬ìš© ê°€ëŠ¥
            // í•˜ì§€ë§Œ ê¹œë¹¡ì„ ë°©ì§€ë¥¼ ìœ„í•´ ì§ì ‘ DOM í´ë˜ìŠ¤ ì¡°ì‘
            currentMarkers.forEach(marker => {
                const el = marker.getElement(); // DivIcon ìš”ì†Œ
                if (el) {
                    const imgDiv = el.querySelector('.custom-marker-img');
                    if (selectedMarkers.has(marker.featureData.id)) {
                        imgDiv.classList.add('ring-4', 'ring-blue-500');
                    } else {
                        imgDiv.classList.remove('ring-4', 'ring-blue-500');
                    }
                }
            });
        }

    </script>
</body>
</html>




<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EventMap2 - Global Festival Map</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background-color: #000; }
        
        /* #upgrade ë‹¤í¬ ëª¨ë“œ: íƒ€ì¼ë§Œ ë°˜ì „ì‹œí‚¤ê³  ë§ˆì»¤/UIëŠ” ë³´ì¡´ */
        #map { 
            width: 100%; 
            height: 100%; 
            background: #000000; 
            z-index: 1;
        }
        
        /* ì§€ë„ íƒ€ì¼ë§Œ ë°˜ì „ (ë‹¤í¬ëª¨ë“œ íš¨ê³¼) */
        .leaflet-tile-pane {
            filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }

        /* íŒì—… ë° ë§ˆì»¤ëŠ” ë°˜ì „ë˜ì§€ ì•Šë„ë¡ ì œì™¸ (í•„ìš”ì‹œ ì—­ë°˜ì „) 
           Leaflet ê¸°ë³¸ êµ¬ì¡°ìƒ paneì´ ë¶„ë¦¬ë˜ì–´ ìˆì–´ tile-paneë§Œ í•„í„° ê±¸ë©´ ë§ˆì»¤ëŠ” ì˜í–¥ ì•ˆ ë°›ìŒ */

        /* #upgrade ë“œë˜ê·¸ ì„ íƒ ë°•ìŠ¤ */
        .selection-box {
            position: absolute;
            border: 2px solid #2196F3;
            background-color: rgba(33, 150, 243, 0.2);
            z-index: 1000;
            pointer-events: none;
            display: none;
        }

        /* #upgrade ì§€ì—­ ë°œê´‘ íš¨ê³¼ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes pulse-glow {
            0% { stroke-opacity: 0.4; stroke-width: 2; fill-opacity: 0.1; }
            50% { stroke-opacity: 1.0; stroke-width: 5; fill-opacity: 0.3; }
            100% { stroke-opacity: 0.4; stroke-width: 2; fill-opacity: 0.1; }
        }
        
        .region-glow-path {
            stroke: #ffeb3b;
            fill: #ffeb3b;
            animation: pulse-glow 2s infinite;
            filter: drop-shadow(0 0 10px #ffeb3b);
        }

        /* í•˜ë‹¨ ì‹œíŠ¸ ì• ë‹ˆë©”ì´ì…˜ */
        #detailSheet {
            transition: transform 0.3s ease-in-out;
            transform: translateY(100%);
        }
        #detailSheet.active {
            transform: translateY(0);
        }

        /* í´ëŸ¬ìŠ¤í„° ì»¤ìŠ¤í…€ ìƒ‰ìƒ */
        .marker-cluster-small { background-color: rgba(110, 204, 57, 0.6); }
        .marker-cluster-small div { background-color: rgba(110, 204, 57, 0.6); }

        .marker-cluster-medium { background-color: rgba(240, 194, 12, 0.6); }
        .marker-cluster-medium div { background-color: rgba(240, 194, 12, 0.6); }

        /* #upgrade 10ê°œ ì´ìƒ ë¹¨ê°• (ê³ ë°€ë„) */
        .cluster-high-density {
            background-color: rgba(255, 59, 48, 0.6) !important;
        }
        .cluster-high-density div {
            background-color: rgba(255, 59, 48, 0.6) !important;
            color: white;
            font-weight: bold;
        }
        
        /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* ì„ íƒëœ ë§ˆì»¤ í•˜ì´ë¼ì´íŠ¸ */
        .marker-selected {
            filter: drop-shadow(0 0 8px #2196F3) brightness(1.2);
            border: 3px solid #2196F3;
            border-radius: 50%;
        }
    </style>
</head>
<body class="font-sans text-gray-100">

    <!-- #upgrade UI 1: ë„¤ì´ë²„ ê²€ìƒ‰ì°½ & êµ­ê°€ íƒ­ & íƒœê·¸ -->
    <div class="absolute top-4 left-1/2 transform -translate-x-1/2 w-[90%] max-w-md z-50 flex flex-col gap-2 pointer-events-none">
        
        <!-- 1. ë„¤ì´ë²„ ì‹¤ì œ ê²€ìƒ‰ ì—°ë™ -->
        <div class="pointer-events-auto bg-gray-900/90 backdrop-blur-md rounded-xl shadow-2xl border border-gray-700 p-2">
            <form action="https://search.naver.com/search.naver" method="GET" target="_blank" class="flex gap-2">
                <input type="text" name="query" placeholder="ë„¤ì´ë²„ ê²€ìƒ‰..." 
                       class="w-full bg-gray-800 text-white px-4 py-2 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-green-500 transition-all">
                <button type="submit" class="bg-green-600 hover:bg-green-500 text-white px-3 py-2 rounded-lg text-sm font-bold">
                    ê²€ìƒ‰
                </button>
            </form>
        </div>

        <!-- 2. êµ­ê°€ íƒ­ (KR/JP/Memo) -->
        <div class="pointer-events-auto flex justify-center gap-2">
            <button onclick="setCountry('Korea')" id="btn-kr" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-1.5 rounded-full text-xs font-bold shadow-lg transition-all ring-2 ring-white/20">ğŸ‡°ğŸ‡· í•œêµ­</button>
            <button onclick="setCountry('Japan')" id="btn-jp" class="bg-gray-700 hover:bg-red-500 text-white px-4 py-1.5 rounded-full text-xs font-bold shadow-lg transition-all">ğŸ‡¯ğŸ‡µ ì¼ë³¸</button>
            <button onclick="toggleMemoMode()" class="bg-gray-700 hover:bg-yellow-500 text-white px-4 py-1.5 rounded-full text-xs font-bold shadow-lg transition-all">ğŸ“ ë©”ëª¨</button>
        </div>

        <!-- 3. ì§€ì—­/íƒœê·¸ í•„í„° (ê°€ë¡œ ìŠ¤í¬ë¡¤) -->
        <div class="pointer-events-auto overflow-x-auto no-scrollbar whitespace-nowrap py-2 px-1 mask-linear">
            <div id="tagContainer" class="flex gap-2 justify-center min-w-max px-4">
                <!-- JSë¡œ ë™ì  ìƒì„±ë¨ -->
            </div>
        </div>
        
        <!-- ìµœê·¼ ê²€ìƒ‰ì–´ (ë¡œì»¬ìŠ¤í† ë¦¬ì§€) -->
        <div id="recentSearch" class="pointer-events-auto hidden bg-gray-900/90 backdrop-blur rounded-lg p-2 mt-1 text-xs text-gray-300">
            <span class="font-bold text-gray-500 block mb-1">ìµœê·¼ ê²€ìƒ‰</span>
            <div id="recentList" class="flex gap-2 flex-wrap"></div>
        </div>
    </div>

    <!-- ë§µ ì»¨í…Œì´ë„ˆ -->
    <div id="map"></div>
    <div id="selectionBox" class="selection-box"></div>

    <!-- í•˜ë‹¨ ìƒì„¸ ì‹œíŠ¸ (í¬ê¸° ì¶•ì†Œ ë° ë””ìì¸ ê°œì„ ) -->
    <div id="detailSheet" class="fixed bottom-0 left-0 w-full bg-gray-900 rounded-t-2xl shadow-[0_-5px_20px_rgba(0,0,0,0.5)] z-50 p-5 h-[35vh] flex flex-col gap-4 border-t border-gray-700 text-white">
        <button id="closeButton" class="absolute top-3 right-4 text-gray-400 hover:text-white text-xl">âœ•</button>
        
        <div class="flex gap-4 h-full">
            <!-- ì´ë¯¸ì§€ ë¹„ìœ¨ ìœ ì§€ object-cover -->
            <img id="sheetImage" src="" alt="Event" class="w-1/3 h-full rounded-xl object-cover border border-gray-600 bg-gray-800">
            
            <div class="flex-1 overflow-y-auto pr-2">
                <div class="flex justify-between items-start mb-2">
                    <h2 id="sheetTitle" class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400">ì´ë²¤íŠ¸ ì œëª©</h2>
                    <span id="sheetRegion" class="text-xs bg-gray-700 px-2 py-1 rounded text-gray-300">ì§€ì—­</span>
                </div>
                <p id="sheetSummary" class="text-sm text-gray-300 mb-3 leading-relaxed">ì´ë²¤íŠ¸ ìš”ì•½ ë‚´ìš©ì´ ì—¬ê¸°ì— ë“¤ì–´ê°‘ë‹ˆë‹¤.</p>
                
                <div class="text-xs space-y-1 text-gray-400">
                    <p>ğŸ¤ <span class="text-gray-200" id="sheetCeleb">ì´ˆì²­ ê²ŒìŠ¤íŠ¸</span></p>
                    <p>ğŸ“… <span class="text-gray-200" id="sheetDate">ë‚ ì§œ ì •ë³´</span></p>
                    <div id="sheetTags" class="flex gap-1 mt-2 flex-wrap"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script>
        // --- ì „ì—­ ë³€ìˆ˜ ---
        let map;
        let markersCluster;
        let currentCountry = 'Korea'; // 'Korea' | 'Japan'
        let currentGlowLayer = null;
        let isSelecting = false;
        let selectionStart = null;
        let selectedMarkers = new Set();
        
        const selectionBox = document.getElementById('selectionBox');
        
        // #upgrade ì§€ì—­ ê²½ê³„ íŒŒë¼ë¯¸í„° (ë‹¨ìˆœ ì‚¬ê°í˜• Bounds ì˜ˆì‹œ)
        // ì‹¤ì œë¡œëŠ” ë” ì •êµí•œ í´ë¦¬ê³¤ì´ ì¢‹ìœ¼ë‚˜, ìš”ì²­ëŒ€ë¡œ íŒŒë¼ë¯¸í„°í™”ëœ Bounds ì‚¬ìš©
        const regionBoundaryParams = {
            'ì„œìš¸': [[37.413294, 126.734086], [37.715133, 127.269311]],
            'ê²½ê¸°': [[36.893960, 126.376282], [38.284422, 127.854233]],
            'ë¶€ì‚°': [[34.879908, 128.738436], [35.395936, 129.372819]],
            'ì œì£¼': [[33.112293, 126.162788], [34.004925, 126.980667]],
            'ë„ì¿„': [[35.501167, 138.942468], [35.898643, 139.919011]],
            'ì˜¤ì‚¬ì¹´': [[34.283177, 135.074447], [34.977464, 135.734685]],
            'í™‹ì¹´ì´ë„': [[41.210909, 139.333332], [45.557201, 148.887208]]
        };

        // #upgrade ë°ì´í„°: í•œêµ­(24) + ì¼ë³¸(13) ê°€ìƒ ë°ì´í„° (ì¼ë¶€ ì˜ˆì‹œ)
        const mockEvents = [
            // --- í•œêµ­ (KR) ---
            { id: 1, title: 'ì„œìš¸ ë¶ˆê½ƒì¶•ì œ', region: 'ì„œìš¸', lat: 37.527, lng: 126.933, country: 'Korea', type: 'ë¬¸í™”', celeb: 'ë¶ˆê½ƒë””ìì´ë„ˆ 10ì¸', img: 'https://images.unsplash.com/photo-1514525253440-b393452e2729', desc: 'ì—¬ì˜ë„ í•œê°•ê³µì›ì—ì„œ í¼ì³ì§€ëŠ” ì„¸ê³„ì ì¸ ë¶ˆê½ƒì¶•ì œ.' },
            { id: 2, title: 'ë¶€ì‚° êµ­ì œì˜í™”ì œ', region: 'ë¶€ì‚°', lat: 35.171, lng: 129.127, country: 'Korea', type: 'ë¬¸í™”', celeb: 'ìœ ëª… ë°°ìš° ë‹¤ìˆ˜', img: 'https://images.unsplash.com/photo-1489599849927-2ee91cede3ba', desc: 'ì•„ì‹œì•„ ìµœëŒ€ì˜ ì˜í™” ì¶•ì œ.' },
            { id: 3, title: 'ë³´ë ¹ ë¨¸ë“œì¶•ì œ', region: 'ì¶©ë‚¨', lat: 36.312, lng: 126.514, country: 'Korea', type: 'ìŒì•…', celeb: 'K-POP ì•„ì´ëŒ', img: 'https://images.unsplash.com/photo-1533174072545-e8d4aa97edf9', desc: 'ì„¸ê³„ì¸ì´ ì¦ê¸°ëŠ” ëŒ€í•œë¯¼êµ­ ëŒ€í‘œ ì—¬ë¦„ ì¶•ì œ.' },
            { id: 4, title: 'ì „ì£¼ ë¹„ë¹”ë°¥ì¶•ì œ', region: 'ì „ë¶', lat: 35.815, lng: 127.153, country: 'Korea', type: 'ìŒì‹', celeb: 'ìœ ëª… ì…°í”„', img: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd', desc: 'ë§›ê³¼ ë©‹ì´ ìˆëŠ” ì „ì£¼ ëŒ€í‘œ ë¯¸ì‹ ì¶•ì œ.' },
            { id: 5, title: 'ì§„í•´ êµ°í•­ì œ', region: 'ê²½ë‚¨', lat: 35.148, lng: 128.663, country: 'Korea', type: 'ë¬¸í™”', celeb: 'êµ°ì•…ëŒ€', img: 'https://images.unsplash.com/photo-1490750967868-58cb75069ed6', desc: 'ì „êµ­ ìµœëŒ€ ê·œëª¨ì˜ ë²šê½ƒ ì¶•ì œ.' },
            
            // --- ì¼ë³¸ (JP) ---
            { id: 101, title: 'ê¸°ì˜¨ ë§ˆì¸ ë¦¬', region: 'êµí† ', lat: 35.003, lng: 135.768, country: 'Japan', type: 'ë¬¸í™”', celeb: 'ì „í†µ ê³„ìŠ¹ì', img: 'https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e', desc: 'êµí† ì˜ ì—¬ë¦„ì„ ì•Œë¦¬ëŠ” ì¼ë³¸ 3ëŒ€ ë§ˆì¸ ë¦¬.' },
            { id: 102, title: 'ìŠ¤ë¯¸ë‹¤ê°€ì™€ ë¶ˆê½ƒë†€ì´', region: 'ë„ì¿„', lat: 35.710, lng: 139.800, country: 'Japan', type: 'ë¬¸í™”', celeb: 'ë¶ˆê½ƒ ì¥ì¸', img: 'https://images.unsplash.com/photo-1506869640319-fe1a24fd76dc', desc: 'ë„ì¿„ì—ì„œ ê°€ì¥ ì˜¤ë˜ë˜ê³  ìœ ëª…í•œ ë¶ˆê½ƒë†€ì´ ëŒ€íšŒ.' },
            { id: 103, title: 'ì‚¿í¬ë¡œ ëˆˆì¶•ì œ', region: 'í™‹ì¹´ì´ë„', lat: 43.061, lng: 141.354, country: 'Japan', type: 'ë¬¸í™”', celeb: 'ì¡°ê°ê°€', img: 'https://images.unsplash.com/photo-1483921020237-2ff51e8e4b22', desc: 'ì„¸ê³„ 3ëŒ€ ì¶•ì œ ì¤‘ í•˜ë‚˜, ê±°ëŒ€í•œ ëˆˆ ì¡°ê° ì „ì‹œ.' },
            { id: 104, title: 'í…ì§„ ë§ˆì¸ ë¦¬', region: 'ì˜¤ì‚¬ì¹´', lat: 34.696, lng: 135.519, country: 'Japan', type: 'ë¬¸í™”', celeb: 'ì˜¤ì‚¬ì¹´ ì‹œë¯¼', img: 'https://images.unsplash.com/photo-1542051841857-5f90071e7989', desc: 'ì²œë…„ ì´ìƒì˜ ì—­ì‚¬ë¥¼ ê°€ì§„ ì˜¤ì‚¬ì¹´ì˜ ëŒ€í‘œ ì¶•ì œ.' }
        ];

        // 1. window.onload ì´ˆê¸°í™”
        window.onload = function() {
            initializeMap();
            loadTags();
            setupEventListeners();
        };

        function initializeMap() {
            // ì§€ë„ ì´ˆê¸° ì¢Œí‘œ (í•œêµ­)
            map = L.map('map', {
                zoomControl: false // ì¤Œ ì»¨íŠ¸ë¡¤ ìœ„ì¹˜ ë³€ê²½ ë“±ì„ ìœ„í•´ ì¼ë‹¨ ë”
            }).setView([35.9, 127.5], 7);

            // OpenStreetMap íƒ€ì¼ (ë‹¤í¬ëª¨ë“œ í•„í„° ì ìš©ë¨)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            // í´ëŸ¬ìŠ¤í„° ê·¸ë£¹ ì´ˆê¸°í™” (#upgrade ì»¤ìŠ¤í…€ ì•„ì´ì½˜ ë¡œì§)
            markersCluster = L.markerClusterGroup({
                iconCreateFunction: function(cluster) {
                    var childCount = cluster.getChildCount();
                    var c = ' marker-cluster-';
                    var densityClass = '';
                    
                    if (childCount < 5) {
                        c += 'small';
                    } else if (childCount < 10) {
                        c += 'medium';
                    } else {
                        c += 'large';
                        densityClass = 'cluster-high-density'; // 10ê°œ ì´ìƒ ë¹¨ê°•
                    }

                    return new L.DivIcon({ 
                        html: '<div class="' + densityClass + '"><span>' + childCount + '</span></div>', 
                        className: 'marker-cluster' + c, 
                        iconSize: new L.Point(40, 40) 
                    });
                }
            });
            
            map.addLayer(markersCluster);
            loadEventMarkers();
        }

        // #upgrade ë°ì´í„° ë¡œë“œ ë° ë§ˆì»¤ ìƒì„±
        function loadEventMarkers() {
            markersCluster.clearLayers();
            
            const filteredEvents = mockEvents.filter(e => e.country === currentCountry);

            filteredEvents.forEach(event => {
                const markerIcon = L.divIcon({
                    className: 'custom-pin',
                    html: `<div class="w-10 h-10 rounded-full border-2 border-white overflow-hidden shadow-lg bg-gray-800 transition-transform hover:scale-110" data-id="${event.id}">
                             <img src="${event.img}" class="w-full h-full object-cover">
                           </div>`,
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });

                const marker = L.marker([event.lat, event.lng], { icon: markerIcon });
                
                // ë§ˆì»¤ ê°ì²´ì— ë°ì´í„° ë°”ì¸ë”©
                marker.eventData = event;

                marker.on('click', () => {
                    showDetailSheet(event);
                });

                markersCluster.addLayer(marker);
            });
            
            // êµ­ê°€ ë³€ê²½ ì‹œ ì§€ë„ ì¤‘ì‹¬ ì´ë™
            if(currentCountry === 'Korea') map.panTo([35.9, 127.5]);
            else map.panTo([36.2048, 138.2529]); // ì¼ë³¸ ì¤‘ì‹¬
        }

        function setCountry(country) {
            currentCountry = country;
            document.getElementById('btn-kr').className = country === 'Korea' ? 
                "bg-blue-600 hover:bg-blue-500 text-white px-4 py-1.5 rounded-full text-xs font-bold shadow-lg ring-2 ring-white/20" : 
                "bg-gray-700 hover:bg-blue-500 text-white px-4 py-1.5 rounded-full text-xs font-bold shadow-lg";
                
            document.getElementById('btn-jp').className = country === 'Japan' ? 
                "bg-red-600 hover:bg-red-500 text-white px-4 py-1.5 rounded-full text-xs font-bold shadow-lg ring-2 ring-white/20" : 
                "bg-gray-700 hover:bg-red-500 text-white px-4 py-1.5 rounded-full text-xs font-bold shadow-lg";
            
            loadEventMarkers();
            loadTags(); // êµ­ê°€ë³„ íƒœê·¸ ê°±ì‹ 
        }

        // #upgrade ë™ì  íƒœê·¸ ìƒì„±
        function loadTags() {
            const container = document.getElementById('tagContainer');
            container.innerHTML = '';
            
            const regions = currentCountry === 'Korea' 
                ? ['ì „ì²´', 'ì„œìš¸', 'ê²½ê¸°', 'ê°•ì›', 'ì¶©ë‚¨', 'ì¶©ë¶', 'ì „ë¶', 'ì „ë‚¨', 'ê²½ë¶', 'ê²½ë‚¨', 'ë¶€ì‚°', 'ì œì£¼']
                : ['ì „ì²´', 'ë„ì¿„', 'ì˜¤ì‚¬ì¹´', 'êµí† ', 'í›„ì¿ ì˜¤ì¹´', 'í™‹ì¹´ì´ë„', 'ì˜¤í‚¤ë‚˜ì™€', 'ë‚˜ê³ ì•¼'];

            regions.forEach(region => {
                const btn = document.createElement('button');
                btn.className = "bg-gray-800/80 hover:bg-gray-700 border border-gray-600 text-gray-300 px-3 py-1 rounded-full text-xs transition-all hover:text-white hover:border-white";
                btn.innerText = region;
                btn.onclick = () => filterByRegion(region);
                container.appendChild(btn);
            });
        }

        // #upgrade ì§€ì—­ í•„í„° ë° ë°œê´‘ íš¨ê³¼
        function filterByRegion(region) {
            // ë°œê´‘ íš¨ê³¼ ì´ˆê¸°í™”
            if (currentGlowLayer) {
                map.removeLayer(currentGlowLayer);
                currentGlowLayer = null;
            }

            if (region === 'ì „ì²´') {
                loadEventMarkers(); // í•„í„° í•´ì œ
                return;
            }

            // ë§ˆì»¤ í•„í„°ë§ (ê°„ë‹¨ êµ¬í˜„)
            markersCluster.clearLayers();
            const filtered = mockEvents.filter(e => e.country === currentCountry && e.region === region);
            filtered.forEach(event => {
                // ...ë§ˆì»¤ ìƒì„± ë¡œì§ ì¤‘ë³µ ìƒëµ (ì‹¤ì œë¡  ì¬ì‚¬ìš© í•¨ìˆ˜ í˜¸ì¶œ ê¶Œì¥)...
                 const markerIcon = L.divIcon({
                    className: 'custom-pin',
                    html: `<div class="w-10 h-10 rounded-full border-2 border-white overflow-hidden shadow-lg bg-gray-800" data-id="${event.id}">
                             <img src="${event.img}" class="w-full h-full object-cover">
                           </div>`,
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });
                const marker = L.marker([event.lat, event.lng], { icon: markerIcon });
                marker.eventData = event;
                marker.on('click', () => showDetailSheet(event));
                markersCluster.addLayer(marker);
            });

            // #upgrade ì§€ì—­ ë°œê´‘ íš¨ê³¼ ì ìš©
            if (regionBoundaryParams[region]) {
                const bounds = regionBoundaryParams[region];
                
                // í™”ë©´ ì´ë™
                map.fitBounds(bounds, { padding: [50, 50], duration: 1.5 });

                // ë°œê´‘ ì‚¬ê°í˜• ê·¸ë¦¬ê¸°
                currentGlowLayer = L.rectangle(bounds, {
                    className: 'region-glow-path', // CSS Animation ì ìš©
                    weight: 3,
                    color: '#ffeb3b',
                    fillOpacity: 0.1
                }).addTo(map);
            }
        }

        function showDetailSheet(event) {
            const sheet = document.getElementById('detailSheet');
            document.getElementById('sheetTitle').innerText = event.title;
            document.getElementById('sheetRegion').innerText = event.region;
            document.getElementById('sheetSummary').innerText = event.desc;
            document.getElementById('sheetCeleb').innerText = event.celeb;
            document.getElementById('sheetDate').innerText = '2026.02.11 ~ 2026.02.14'; // Mock
            document.getElementById('sheetImage').src = event.img;
            
            sheet.classList.add('active');
        }

        document.getElementById('closeButton').addEventListener('click', () => {
            document.getElementById('detailSheet').classList.remove('active');
        });

        // #upgrade Alt + ë“œë˜ê·¸ ì„ íƒ ë¡œì§
        function setupEventListeners() {
            // ESC í‚¤ë¡œ ì„ íƒ í•´ì œ
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') deselectAll();
            });

            // ì§€ë„ ë“œë˜ê·¸/ì„ íƒ ì´ë²¤íŠ¸
            const mapContainer = document.getElementById('map');

            mapContainer.addEventListener('mousedown', (e) => {
                if (e.altKey) {
                    isSelecting = true;
                    map.dragging.disable(); // ì§€ë„ ë“œë˜ê·¸ ë§‰ìŒ
                    selectionStart = { x: e.clientX, y: e.clientY };
                    
                    selectionBox.style.left = e.clientX + 'px';
                    selectionBox.style.top = e.clientY + 'px';
                    selectionBox.style.width = '0px';
                    selectionBox.style.height = '0px';
                    selectionBox.style.display = 'block';
                }
            });

            window.addEventListener('mousemove', (e) => {
                if (!isSelecting) return;

                const currentX = e.clientX;
                const currentY = e.clientY;

                const width = Math.abs(currentX - selectionStart.x);
                const height = Math.abs(currentY - selectionStart.y);
                const left = Math.min(currentX, selectionStart.x);
                const top = Math.min(currentY, selectionStart.y);

                selectionBox.style.width = width + 'px';
                selectionBox.style.height = height + 'px';
                selectionBox.style.left = left + 'px';
                selectionBox.style.top = top + 'px';
            });

            window.addEventListener('mouseup', (e) => {
                if (!isSelecting) return;
                
                isSelecting = false;
                selectionBox.style.display = 'none';
                map.dragging.enable(); // ì§€ë„ ë“œë˜ê·¸ ë³µêµ¬

                // ì„ íƒ ì˜ì—­ì˜ LatLng Bounds ê³„ì‚°
                const bounds = L.latLngBounds(
                    map.containerPointToLatLng([parseInt(selectionBox.style.top), parseInt(selectionBox.style.left)]),
                    map.containerPointToLatLng([
                        parseInt(selectionBox.style.top) + parseInt(selectionBox.style.height),
                        parseInt(selectionBox.style.left) + parseInt(selectionBox.style.width)
                    ])
                );

                // ë§ˆì»¤ ì„ íƒ ì²˜ë¦¬
                markersCluster.eachLayer((layer) => {
                    if (bounds.contains(layer.getLatLng())) {
                        selectMarker(layer);
                    }
                });
            });
        }

        function selectMarker(marker) {
            const iconDiv = marker.getElement().querySelector('div');
            if (iconDiv) {
                iconDiv.classList.add('marker-selected');
                selectedMarkers.add(marker);
            }
        }

        function deselectAll() {
            selectedMarkers.forEach(marker => {
                const iconDiv = marker.getElement().querySelector('div');
                if (iconDiv) iconDiv.classList.remove('marker-selected');
            });
            selectedMarkers.clear();
        }
        
        function toggleMemoMode() {
            alert('ë©”ëª¨ ëª¨ë“œ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤ (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì—°ë™ ì˜ˆì •)');
        }
    </script>
</body>
</html>

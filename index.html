<!DOCTYPE html>
<html lang="ko" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Event Map (KR/JP)</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'deep-gray': '#1F1F1F',
                        'material-dark': '#121212',
                        'google-dark': '#202124',
                        'google-gray': '#3c4043',
                        'primary-500': '#10b981',
                        'primary-600': '#059669',
                    },
                    fontFamily: {
                        sans: ['Inter', 'Malgun Gothic', 'Dotum', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- Leaflet CSS + MarkerCluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

    <style>
        /* ê¸°ë³¸ ë‹¤í¬ëª¨ë“œ ê³ ì • */
        body {
            background-color: #121212 !important;
            color: #e0e0e0 !important;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #map {
            height: 100vh;
            width: 100vw;
            z-index: 10;
            filter: brightness(0.92) saturate(0.85);
        }

        /* Leaflet ì»¨í…Œì´ë„ˆ ìì²´ ë°°ê²½ë„ ì–´ë‘¡ê²Œ (íƒ€ì¼ ë¡œë”© ì „/ì‹¤íŒ¨ ëŒ€ë¹„) */
        .leaflet-container {
            background: #121212 !important;
        }

        /* ì»¤ìŠ¤í…€ ë§ˆì»¤ - 10% ì¶•ì†Œ */
        .event-marker {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid #10b981;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.55);
            cursor: pointer;
            transition: transform 0.2s;
            background: white;
        }
        .event-marker:hover {
            transform: scale(1.15);
            z-index: 1000 !important;
        }
        .event-marker img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ì„ íƒëœ ë§ˆì»¤ ê°•ì¡° */
        .event-marker.selected {
            border-color: #fbbf24 !important;
            border-width: 4px;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.8);
        }

        /* ì§€ì—­ ê²½ê³„ì„  ë°œê´‘ íš¨ê³¼ */
        @keyframes pulse-ring {
            0%, 100% { stroke-opacity: 1; fill-opacity: 0.18; }
            50% { stroke-opacity: 0.45; fill-opacity: 0.08; }
        }

        /* Leaflet SVG Path(í´ë¦¬ê³¤/ì‚¬ê°í˜•) glow: drop-shadowëŠ” SVGì—ë„ ì ìš©ë¨ */
        .glow-region {
            animation: pulse-ring 2.5s ease-in-out infinite;
            filter: drop-shadow(0 0 10px rgba(255, 235, 59, 0.85));
        }

        /* ë“œë˜ê·¸ ì„ íƒ ë°•ìŠ¤ */
        .selection-box {
            position: absolute;
            border: 2px dashed #fbbf24;
            background-color: rgba(251, 191, 36, 0.15);
            z-index: 2000;
            pointer-events: none;
        }

        /* ë°”í…€ ì‹œíŠ¸ */
        #detail-sheet {
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            transform: translateY(100%);
            z-index: 50;
            max-height: 50vh !important;
            background-color: #1a1a1a !important;
        }
        #detail-sheet.active { transform: translateY(0); }

        /* ê²€ìƒ‰ ë° UI ë‹¤í¬ëª¨ë“œ ê³ ì • */
        .search-container {
            background-color: #121212 !important;
            color: #e0e0e0 !important;
        }
        .search-input {
            background-color: #1F1F1F !important;
            color: #e0e0e0 !important;
        }

        /* ê²€ìƒ‰ì–´ íˆìŠ¤í† ë¦¬ ì¹© */
        .history-chip {
            transition: all 0.2s;
            background: #2d2f31 !important;
            color: #b0b0b0 !important;
            cursor: pointer;
        }
        .history-chip:hover {
            background: #3c4043 !important;
            color: #ffffff !important;
        }

        /* Leaflet íˆ´íŒ: ê¸°ë³¸ì€ ìˆ¨ê¹€(í˜¸ë²„ ì‹œë§Œ) */
        .leaflet-tooltip {
            opacity: 0 !important;
            transition: opacity 0.2s;
            pointer-events: none;
        }

        /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* ë‹¤ì¤‘ ì„ íƒ ì¸í„°í˜ì´ìŠ¤ íŒ¨ë„ */
        #selection-panel {
            transition: transform 0.3s ease-in-out;
            transform: translateY(-120%);
        }
        #selection-panel.active { transform: translateY(0); }
    </style>
</head>

<body>
    <!-- ìƒë‹¨ UI: ê²€ìƒ‰ ë° í•„í„° -->
    <div class="fixed top-4 left-4 right-4 z-[40] flex flex-col gap-2 max-w-2xl mx-auto pointer-events-none">
        <!-- ê²€ìƒ‰ì°½ -->
        <div class="pointer-events-auto search-container rounded-xl shadow-2xl p-2.5 flex flex-col gap-2">
            <input type="text" id="search-input" placeholder="ì¶•ì œëª…, ì§€ì—­, íƒœê·¸ ê²€ìƒ‰ (Alt+ë“œë˜ê·¸ë¡œ ë‹¤ì¤‘ì„ íƒ)"
                   class="search-input w-full px-3 py-1.5 text-sm rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 transition-colors">
            <div id="search-history" class="flex gap-1.5 overflow-x-auto text-xs pb-1 scrollbar-hide"></div>
        </div>

        <!-- 2ë‹¨ í•„í„°: êµ­ê°€ > ì§€ì—­ -->
        <div class="pointer-events-auto flex flex-col gap-1.5">
            <div class="flex gap-2 overflow-x-auto pb-1 scrollbar-hide">
                <button onclick="switchCountry('í•œêµ­')" id="btn-korea" class="country-btn px-3 py-1 bg-primary-600 text-white rounded-full shadow-md text-xs font-bold whitespace-nowrap transition">ğŸ‡°ğŸ‡· í•œêµ­</button>
                <button onclick="switchCountry('ì¼ë³¸')" id="btn-japan" class="country-btn px-3 py-1 bg-google-gray text-gray-300 rounded-full shadow-md text-xs font-bold whitespace-nowrap transition">ğŸ‡¯ğŸ‡µ ì¼ë³¸</button>
            </div>

            <div id="region-filters" class="flex gap-2 overflow-x-auto pb-1 scrollbar-hide"></div>

            <div class="flex gap-2 overflow-x-auto pb-1 scrollbar-hide">
                <button onclick="filterByTag('ì „ì²´')" class="px-3 py-1 bg-google-gray text-gray-200 rounded-full shadow-md text-xs font-semibold whitespace-nowrap hover:bg-gray-600 transition">ì „ì²´</button>
                <button onclick="filterByTag('ìŒì‹')" class="px-3 py-1 bg-google-gray text-gray-200 rounded-full shadow-md text-xs font-semibold whitespace-nowrap hover:bg-gray-600 transition">ìŒì‹</button>
                <button onclick="filterByTag('ë¬¸í™”')" class="px-3 py-1 bg-google-gray text-gray-200 rounded-full shadow-md text-xs font-semibold whitespace-nowrap hover:bg-gray-600 transition">ë¬¸í™”</button>
                <button onclick="filterByTag('ìŒì•…')" class="px-3 py-1 bg-google-gray text-gray-200 rounded-full shadow-md text-xs font-semibold whitespace-nowrap hover:bg-gray-600 transition">ìŒì•…</button>
                <button onclick="toggleHeatmap()" class="px-3 py-1 bg-red-900 text-red-200 rounded-full shadow-md text-xs font-semibold whitespace-nowrap transition">ğŸ”¥ ì‚°ì ë„</button>
            </div>
        </div>
    </div>

    <!-- ë‹¤ì¤‘ ì„ íƒ ì œì–´ íŒ¨ë„ -->
    <div id="selection-panel" class="fixed top-20 right-4 z-[45] bg-[#1a1a1a] rounded-lg shadow-2xl p-3 pointer-events-auto" style="min-width: 200px;">
        <div class="flex justify-between items-center mb-2">
            <span class="text-white text-sm font-bold">ì„ íƒëœ ì¶•ì œ: <span id="selected-count">0</span>ê°œ</span>
            <button onclick="closeSelectionPanel()" class="text-gray-400 hover:text-white">âœ•</button>
        </div>
        <div class="flex flex-col gap-1.5">
            <button onclick="addTagToSelected()" class="px-3 py-1.5 bg-primary-600 hover:bg-primary-700 text-white rounded-md text-xs font-semibold transition">ğŸ·ï¸ íƒœê·¸ ì¶”ê°€</button>
            <button onclick="exportSelected()" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-xs font-semibold transition">ğŸ“¤ ë‚´ë³´ë‚´ê¸°</button>
            <button onclick="clearSelection()" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 text-white rounded-md text-xs font-semibold transition">ğŸ—‘ï¸ ì„ íƒ í•´ì œ</button>
        </div>
    </div>

    <!-- ì§€ë„ -->
    <div id="map" class="relative"></div>

    <!-- í•˜ë‹¨ ìƒì„¸ ì‹œíŠ¸ -->
    <div id="detail-sheet" class="fixed bottom-0 left-0 right-0 rounded-t-3xl shadow-2xl p-4 flex flex-col">
        <div class="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
            <h2 id="sheet-title" class="text-base font-bold text-white"></h2>
            <button onclick="hideDetailSheet()" class="px-3 py-1 bg-gray-700 text-gray-200 rounded-full text-xs font-bold hover:bg-gray-600 transition">ë‹«ê¸°</button>
        </div>
        <div class="overflow-y-auto flex-grow">
            <div class="w-full mb-3 rounded-lg overflow-hidden shadow-md" style="aspect-ratio: 16/9;">
                <img id="sheet-image" class="w-full h-full object-cover" src="" alt="">
            </div>
            <div class="mb-3">
                <h3 class="text-xs font-bold text-primary-500 mb-1">ìš”ì•½</h3>
                <p id="sheet-summary" class="text-gray-300 text-xs whitespace-pre-line leading-relaxed"></p>
            </div>
            <div class="mb-3">
                <h3 class="text-xs font-bold text-primary-500 mb-1">ê²ŒìŠ¤íŠ¸</h3>
                <p id="sheet-celeb" class="text-gray-300 text-xs"></p>
            </div>
            <div>
                <h3 class="text-xs font-bold text-primary-500 mb-1">íƒœê·¸</h3>
                <div id="sheet-tags" class="flex gap-1 flex-wrap"></div>
            </div>
        </div>
    </div>

    <!-- Libraries -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <script>
        // ===== 1. ë°ì´í„° (ê¸°ì¡´ ìœ ì§€) =====
        const mockEvents = [
            // === í•œêµ­ ì¶•ì œ ë°ì´í„° ===
            { id: 1, name: "ì—¬ì˜ë„ ë²šê½ƒì¶•ì œ", lat: 37.528, lng: 126.933, country: "í•œêµ­", region: "ì„œìš¸", tags: ["ë¬¸í™”", "ë´„"], summary: "í•œê°•ë³€ ë²šê½ƒê¸¸ê³¼ ì•¼ê²½ì´ ì•„ë¦„ë‹¤ìš´ ë´„ ì¶•ì œ", celeb: "ì§€ì—­ ì˜ˆìˆ ë‹¨", img: "https://placehold.co/400x225/pink/white?text=Cherry" },
            { id: 2, name: "ì„œìš¸ ì„¸ê³„ë¶ˆê½ƒì¶•ì œ", lat: 37.528, lng: 126.933, country: "í•œêµ­", region: "ì„œìš¸", tags: ["ì•¼ê²½", "ì—¬ë¦„"], summary: "ì—¬ì˜ë„ì—ì„œ í¼ì³ì§€ëŠ” ëŒ€ê·œëª¨ ë¶ˆê½ƒì‡¼", celeb: "ì—†ìŒ", img: "https://placehold.co/400x225/purple/white?text=Firework" },

            { id: 3, name: "ìˆ˜ì› í™”ì„±ë¬¸í™”ì œ", lat: 37.279, lng: 127.009, country: "í•œêµ­", region: "ê²½ê¸°", tags: ["ë¬¸í™”", "ì—­ì‚¬"], summary: "ìœ ë„¤ìŠ¤ì½” ì„¸ê³„ë¬¸í™”ìœ ì‚° í™”ì„±ì—ì„œ ì—´ë¦¬ëŠ” ì „í†µ ì¶•ì œ", celeb: "êµ­ì•…ì¸", img: "https://placehold.co/400x225/green/white?text=Suwon" },
            { id: 4, name: "í‡´ì´Œ í† ë§ˆí† ì¶•ì œ", lat: 37.391, lng: 127.318, country: "í•œêµ­", region: "ê²½ê¸°", tags: ["ìŒì‹", "ì²´í—˜"], summary: "ì‹ ì„ í•œ í† ë§ˆí†  ìˆ˜í™• ì²´í—˜ê³¼ ì‹œì‹", celeb: "ë°±ì¢…ì›", img: "https://placehold.co/400x225/red/white?text=Tomato" },

            { id: 5, name: "ê°•ë¦‰ ì»¤í”¼ì¶•ì œ", lat: 37.751, lng: 128.876, country: "í•œêµ­", region: "ê°•ì›", tags: ["ìŒì‹", "ì»¤í”¼"], summary: "ë°”ë‹¤ì™€ ì»¤í”¼ì˜ ë§Œë‚¨, ë°”ë¦¬ìŠ¤íƒ€ ê²½ì—°", celeb: "ì„¸ê³„ ë°”ë¦¬ìŠ¤íƒ€ ì±”í”¼ì–¸", img: "https://placehold.co/400x225/brown/white?text=Coffee" },
            { id: 6, name: "í™”ì²œ íŒŒë¡œí˜¸ ë‹¨í’ì¶•ì œ", lat: 38.106, lng: 127.708, country: "í•œêµ­", region: "ê°•ì›", tags: ["ë¬¸í™”", "ê°€ì„"], summary: "ë‹¨í’ê³¼ ìº í•‘ì„ ë™ì‹œì— ì¦ê¸°ëŠ” íë§ ì¶•ì œ", celeb: "ì—†ìŒ", img: "https://placehold.co/400x225/orange/black?text=Autumn" },
            { id: 7, name: "ì¸ì œ ìì‘ë‚˜ë¬´ìˆ² ì¶•ì œ", lat: 38.069, lng: 128.170, country: "í•œêµ­", region: "ê°•ì›", tags: ["ìì—°", "ì—¬ë¦„"], summary: "ìˆ²ì† ê±·ê¸°ì™€ íë§ ì²´í—˜", celeb: "ì—†ìŒ", img: "https://placehold.co/400x225/white/green?text=Forest" },

            { id: 8, name: "ì²œì•ˆ ë¹µ í˜ìŠ¤í‹°ë²Œ", lat: 36.814, lng: 127.113, country: "í•œêµ­", region: "ì¶©ë‚¨", tags: ["ìŒì‹", "ë¹µ"], summary: "ì „êµ­ ìœ ëª… ë² ì´ì»¤ë¦¬ ì´ì§‘í•©", celeb: "ì´ì—°ë³µ ì…°í”„", img: "https://placehold.co/400x225/orange/white?text=Bread" },
            { id: 9, name: "ë³´ë ¹ ë¨¸ë“œ ì¶•ì œ", lat: 36.315, lng: 126.541, country: "í•œêµ­", region: "ì¶©ë‚¨", tags: ["ì²´í—˜", "ì—¬ë¦„"], summary: "ì„¸ê³„ì ì¸ ë¨¸ë“œ ì²´í—˜ê³¼ K-POP ê³µì—°", celeb: "ì‹¸ì´, ì•„ì´ë¸Œ", img: "https://placehold.co/400x225/brown/white?text=Mud" },
            { id: 10, name: "ê³µì£¼ ë°±ì œë¬¸í™”ì œ", lat: 36.452, lng: 127.113, country: "í•œêµ­", region: "ì¶©ë‚¨", tags: ["ë¬¸í™”", "ì—­ì‚¬"], summary: "ë°±ì œ ì™•ì¡°ì˜ ì—­ì‚¬ë¥¼ ì¬í˜„í•˜ëŠ” ëŒ€ê·œëª¨ í¼ë ˆì´ë“œ", celeb: "êµ­ì•…ì¸ ì•ˆì†Œë¦¬", img: "https://placehold.co/400x225/red/white?text=Baekje" },

            { id: 11, name: "ì²­ì£¼ ì§ì§€ ì½”ë¦¬ì•„", lat: 36.635, lng: 127.491, country: "í•œêµ­", region: "ì¶©ë¶", tags: ["ë¬¸í™”", "ì „ì‹œ"], summary: "ì„¸ê³„ ìµœê³ (æœ€å¤) ê¸ˆì†í™œìë³¸ ì§ì§€ ê¸°ë… ì¶•ì œ", celeb: "ì—­ì‚¬í•™ì", img: "https://placehold.co/400x225/blue/white?text=Jikji" },
            { id: 12, name: "ë‹¨ì–‘ ë§ˆëŠ˜ ì¶•ì œ", lat: 36.980, lng: 128.360, country: "í•œêµ­", region: "ì¶©ë¶", tags: ["ìŒì‹", "ê±´ê°•"], summary: "ë‹¨ì–‘ ë§ˆëŠ˜ ìš”ë¦¬ ê²½ì—°ê³¼ ì²´í—˜", celeb: "í‘¸ë“œ ìŠ¤íƒ€ì¼ë¦¬ìŠ¤íŠ¸", img: "https://placehold.co/400x225/white/black?text=Garlic" },

            { id: 13, name: "ì „ì£¼ ë¹„ë¹”ë°¥ ì¶•ì œ", lat: 35.814, lng: 127.152, country: "í•œêµ­", region: "ì „ë¶", tags: ["ìŒì‹", "ì „í†µ"], summary: "ë§›ì˜ ê³ ì¥ ì „ì£¼ì—ì„œ ì¦ê¸°ëŠ” ë¹„ë¹”ë°¥", celeb: "ë°±ì¢…ì›", img: "https://placehold.co/400x225/green/white?text=Bibim" },
            { id: 14, name: "ì§„ì•ˆ í™ì‚¼ì¶•ì œ", lat: 35.792, lng: 127.424, country: "í•œêµ­", region: "ì „ë¶", tags: ["ê±´ê°•", "ìŒì‹"], summary: "ê±´ê°• í…Œë§ˆì˜ ì§€ì—­ íŠ¹ì‚°ë¬¼ ì¶•ì œ", celeb: "í•œì˜ì‚¬", img: "https://placehold.co/400x225/red/white?text=Ginseng" },

            { id: 15, name: "ë³´ì„± ë‹¤í–¥ëŒ€ì¶•ì œ", lat: 34.771, lng: 127.080, country: "í•œêµ­", region: "ì „ë‚¨", tags: ["ìŒì‹", "ë…¹ì°¨"], summary: "ë…¹ì°¨ë°­ì—ì„œ ì¦ê¸°ëŠ” ì°¨(èŒ¶) ë¬¸í™”", celeb: "ì°¨ ë§ˆìŠ¤í„°", img: "https://placehold.co/400x225/green/white?text=GreenTea" },
            { id: 16, name: "ì—¬ìˆ˜ ë¶ˆê½ƒì¶•ì œ", lat: 34.760, lng: 127.662, country: "í•œêµ­", region: "ì „ë‚¨", tags: ["ì•¼ê²½", "ì—¬ë¦„"], summary: "ì—¬ìˆ˜ ë°¤ë°”ë‹¤ì™€ ë¶ˆê½ƒì˜ í™˜ìƒ ì¡°í•©", celeb: "ì—†ìŒ", img: "https://placehold.co/400x225/blue/white?text=Yeosu" },

            { id: 17, name: "ê²½ì£¼ ë²šê½ƒì¶•ì œ", lat: 35.856, lng: 129.225, country: "í•œêµ­", region: "ê²½ë¶", tags: ["ë¬¸í™”", "ë´„"], summary: "ìœ ì ì§€ì™€ ë²šê½ƒì˜ ì¡°í™”", celeb: "ì—†ìŒ", img: "https://placehold.co/400x225/pink/black?text=Gyeongju" },
            { id: 18, name: "í¬í•­ êµ­ì œë¶ˆë¹›ì¶•ì œ", lat: 36.019, lng: 129.343, country: "í•œêµ­", region: "ê²½ë¶", tags: ["ì•¼ê²½", "êµ­ì œ"], summary: "í˜•ì‚°ê°•ë³€ì—ì„œ í¼ì³ì§€ëŠ” ë¹›ì˜ í–¥ì—°", celeb: "í•´ì™¸ ì•„í‹°ìŠ¤íŠ¸", img: "https://placehold.co/400x225/yellow/black?text=Light" },

            { id: 19, name: "ì§„í•´ êµ°í•­ì œ", lat: 35.133, lng: 128.681, country: "í•œêµ­", region: "ê²½ë‚¨", tags: ["ë¬¸í™”", "ë´„"], summary: "ì „êµ­ ìµœëŒ€ ë²šê½ƒì¶•ì œì™€ êµ°ì•…ëŒ€ í¼ë ˆì´ë“œ", celeb: "êµ°ì•…ëŒ€", img: "https://placehold.co/400x225/pink/white?text=Jinhae" },
            { id: 20, name: "í•˜ë™ ì„¬ì§„ê°• ì¬ì²©ì¶•ì œ", lat: 35.067, lng: 127.751, country: "í•œêµ­", region: "ê²½ë‚¨", tags: ["ìŒì‹", "ìì—°"], summary: "ì„¬ì§„ê°• ì¬ì²© ìš”ë¦¬ì™€ ë¬¸í™” ì²´í—˜", celeb: "ì—†ìŒ", img: "https://placehold.co/400x225/blue/white?text=Clam" },

            { id: 21, name: "ë¶€ì‚° êµ­ì œë¶ˆê½ƒì¶•ì œ", lat: 35.153, lng: 129.118, country: "í•œêµ­", region: "ë¶€ì‚°", tags: ["ì•¼ê²½", "êµ­ì œ"], summary: "ê´‘ì•ˆë¦¬ í•´ë³€ì˜ ëŒ€ê·œëª¨ ë¶ˆê½ƒì‡¼", celeb: "ì—†ìŒ", img: "https://placehold.co/400x225/purple/white?text=Busan" },
            { id: 22, name: "ë¶€ì‚° êµ­ì œë¡í˜ìŠ¤í‹°ë²Œ", lat: 35.179, lng: 129.075, country: "í•œêµ­", region: "ë¶€ì‚°", tags: ["ìŒì•…", "ì²­ë…„"], summary: "ì•„ì‹œì•„ ìµœëŒ€ ë¡ í˜ìŠ¤í‹°ë²Œ", celeb: "í•´ì™¸ ë¡ë°´ë“œ", img: "https://placehold.co/400x225/black/white?text=Rock" },

            { id: 23, name: "ì„±ì‚°ì¼ì¶œì¶•ì œ", lat: 33.458, lng: 126.940, country: "í•œêµ­", region: "ì œì£¼", tags: ["ìì—°", "ì‹ ë…„"], summary: "ì„±ì‚°ì¼ì¶œë´‰ì—ì„œ ë§ì´í•˜ëŠ” ìƒˆí•´ ì²« ì¼ì¶œ", celeb: "ì—†ìŒ", img: "https://placehold.co/400x225/orange/white?text=Sunrise" },
            { id: 24, name: "ì œì£¼ ìœ ì±„ê½ƒì¶•ì œ", lat: 33.390, lng: 126.250, country: "í•œêµ­", region: "ì œì£¼", tags: ["ìì—°", "ë´„"], summary: "ë…¸ë€ ìœ ì±„ê½ƒ ë¬¼ê²°ì´ í¼ì³ì§€ëŠ” ë´„", celeb: "ì—†ìŒ", img: "https://placehold.co/400x225/yellow/black?text=Flower" },

            // === ì¼ë³¸ ì¶•ì œ ë°ì´í„° ===
            { id: 101, name: "ê°„ë‹¤ ë§ˆì¸ ë¦¬", lat: 35.698, lng: 139.771, country: "ì¼ë³¸", region: "ë„ì¿„", tags: ["ë¬¸í™”", "ì „í†µ"], summary: "ì—ë„ 3ëŒ€ ë§ˆì¸ ë¦¬, í™”ë ¤í•œ ìˆ˜ë ˆ í–‰ì§„", celeb: "ì§€ì—­ ì¥ì¸", img: "https://placehold.co/400x225/red/white?text=Kanda" },
            { id: 102, name: "ìŠ¤ë¯¸ë‹¤ê°• ë¶ˆê½ƒë†€ì´", lat: 35.710, lng: 139.805, country: "ì¼ë³¸", region: "ë„ì¿„", tags: ["ì•¼ê²½", "ì—¬ë¦„"], summary: "ë„ì¿„ ìµœê³ ì˜ í•˜ë‚˜ë¹„(èŠ±ç«) ì¶•ì œ, 2ë§Œë°œ ì´ìƒ", celeb: "ì—†ìŒ", img: "https://placehold.co/400x225/blue/white?text=Hanabi" },
            { id: 103, name: "ì•¼ìŠ¤ì¿ ë‹ˆ ë¯¸íƒ€ë§ˆ ë§ˆì¸ ë¦¬", lat: 35.694, lng: 139.745, country: "ì¼ë³¸", region: "ë„ì¿„", tags: ["ë¬¸í™”", "ì—¬ë¦„"], summary: "3ë§Œê°œ ë“±ë¡±ì´ ë°íˆëŠ” ì˜ë¡±í•œ ì—¬ë¦„ë°¤", celeb: "ì—†ìŒ", img: "https://placehold.co/400x225/yellow/black?text=Lantern" },

            { id: 104, name: "í…ì§„ ë§ˆì¸ ë¦¬", lat: 34.696, lng: 135.519, country: "ì¼ë³¸", region: "ì˜¤ì‚¬ì¹´", tags: ["ë¬¸í™”", "ë°°"], summary: "ì¼ë³¸ 3ëŒ€ ì¶•ì œ, 100ì²™ì˜ ë°°ì™€ 5,000ë°œ ë¶ˆê½ƒ", celeb: "ì—†ìŒ", img: "https://placehold.co/400x225/orange/black?text=Tenjin" },
            { id: 105, name: "ê¸°ì‹œì™€ë‹¤ ë‹¨ì§€ë¦¬ ë§ˆì¸ ë¦¬", lat: 34.464, lng: 135.370, country: "ì¼ë³¸", region: "ì˜¤ì‚¬ì¹´", tags: ["ë¬¸í™”", "ì „í†µ"], summary: "ì´ˆëŒ€í˜• ìˆ˜ë ˆë¥¼ ëŒê³  ë‹¬ë¦¬ëŠ” ë°•ì§„ê° ë„˜ì¹˜ëŠ” ì¶•ì œ", celeb: "ì—†ìŒ", img: "https://placehold.co/400x225/brown/white?text=Danjiri" },

            { id: 106, name: "ê¸°ì˜¨ ë§ˆì¸ ë¦¬", lat: 35.003, lng: 135.778, country: "ì¼ë³¸", region: "êµí† ", tags: ["ë¬¸í™”", "ì „í†µ"], summary: "ì¼ë³¸ 3ëŒ€ ë§ˆì¸ ë¦¬, 1150ë…„ ì—­ì‚¬ì˜ ì•¼ë§ˆë³´ì½” ìˆœí–‰", celeb: "ì „í†µ ì¥ì¸", img: "https://placehold.co/400x225/purple/white?text=Gion" },
            { id: 107, name: "ì•„ì˜¤ì´ ë§ˆì¸ ë¦¬", lat: 35.039, lng: 135.752, country: "ì¼ë³¸", region: "êµí† ", tags: ["ë¬¸í™”", "ì—­ì‚¬"], summary: "í—¤ì´ì•ˆ ì‹œëŒ€ ì˜ìƒì„ ì…ì€ í–‰ë ¬ ì¶•ì œ", celeb: "ì—†ìŒ", img: "https://placehold.co/400x225/green/white?text=Aoi" },

            { id: 108, name: "í•˜ì¹´íƒ€ ê¸°ì˜¨ ì•¼ë§ˆì¹´ì‚¬", lat: 33.590, lng: 130.401, country: "ì¼ë³¸", region: "í›„ì¿ ì˜¤ì¹´", tags: ["ë¬¸í™”", "ì—¬ë¦„"], summary: "ë‚¨ìë“¤ì´ ìˆ˜ë ˆë¥¼ ë©”ê³  ë‹¬ë¦¬ëŠ” ì—´ì •ì˜ ì¶•ì œ", celeb: "ì—†ìŒ", img: "https://placehold.co/400x225/red/white?text=Yamakasa" },
            { id: 109, name: "í›„ì¿ ì˜¤ì¹´ ì•„ì‹œì•„ ì˜í™”ì œ", lat: 33.590, lng: 130.401, country: "ì¼ë³¸", region: "í›„ì¿ ì˜¤ì¹´", tags: ["ë¬¸í™”", "ì˜í™”"], summary: "ì•„ì‹œì•„ ì˜í™”ì˜ ì¤‘ì‹¬ì§€", celeb: "ì•„ì‹œì•„ ì˜í™”ì¸", img: "https://placehold.co/400x225/black/white?text=Film" },

            { id: 110, name: "ì‚¿í¬ë¡œ ëˆˆ ì¶•ì œ", lat: 43.061, lng: 141.354, country: "ì¼ë³¸", region: "í™‹ì¹´ì´ë„", tags: ["ê²¨ìš¸", "ì „ì‹œ"], summary: "ì´ˆëŒ€í˜• ëˆˆÂ·ì–¼ìŒ ì¡°ê° ì „ì‹œì™€ ì¼ë£¨ë¯¸ë„¤ì´ì…˜", celeb: "í•´ì™¸ ì¡°ê°ê°€", img: "https://placehold.co/400x225/white/blue?text=Snow" },
            { id: 111, name: "ìš”ì‚¬ì½”ì´ ì†Œë€ ë§ˆì¸ ë¦¬", lat: 43.064, lng: 141.347, country: "ì¼ë³¸", region: "í™‹ì¹´ì´ë„", tags: ["ìŒì•…", "ì¶¤"], summary: "ì—­ë™ì ì¸ ì¶¤ í¼í¬ë¨¼ìŠ¤ ì¶•ì œ", celeb: "ëŒ„ìŠ¤íŒ€", img: "https://placehold.co/400x225/red/white?text=Dance" },

            { id: 112, name: "ë‚˜í•˜ ëŒ€ì¤„ë‹¤ë¦¬ê¸°", lat: 26.212, lng: 127.679, country: "ì¼ë³¸", region: "ì˜¤í‚¤ë‚˜ì™€", tags: ["ë¬¸í™”", "ì „í†µ"], summary: "ê¸°ë„¤ìŠ¤ë¶ ë“±ì¬ ì„¸ê³„ ìµœëŒ€ ì¤„ë‹¤ë¦¬ê¸°", celeb: "ì—†ìŒ", img: "https://placehold.co/400x225/blue/white?text=Tug" },
            { id: 113, name: "ì˜¤í‚¤ë‚˜ì™€ ì „ë„ ì—ì´ì‚¬ ë§ˆì¸ ë¦¬", lat: 26.334, lng: 127.805, country: "ì¼ë³¸", region: "ì˜¤í‚¤ë‚˜ì™€", tags: ["ìŒì•…", "ì¶¤"], summary: "ì „í†µ ë¶ì¶¤ ì—ì´ì‚¬ì˜ ì—­ë™ì  ë¬´ëŒ€", celeb: "ì—ì´ì‚¬ ë‹¨ì²´", img: "https://placehold.co/400x225/orange/black?text=Eisa" },
        ];

        // ===== 2. ì „ì—­ ë³€ìˆ˜ =====
        let map, markerClusterGroup, heatLayer;
        let activeGlowLayer = null;
        let isHeatmapMode = false;
        let currentCountry = "í•œêµ­";
        let currentFilteredEvents = mockEvents.filter(e => e.country === "í•œêµ­");

        let searchBuffer = [];
        const MAX_HISTORY = 5;

        let selectedMarkers = new Set();
        let markerMap = new Map(); // id -> {marker, event}

        const regions = {
            "í•œêµ­": ["ì„œìš¸", "ê²½ê¸°", "ê°•ì›", "ì¶©ë‚¨", "ì¶©ë¶", "ì „ë¶", "ì „ë‚¨", "ê²½ë¶", "ê²½ë‚¨", "ë¶€ì‚°", "ì œì£¼"],
            "ì¼ë³¸": ["ë„ì¿„", "ì˜¤ì‚¬ì¹´", "êµí† ", "í›„ì¿ ì˜¤ì¹´", "í™‹ì¹´ì´ë„", "ì˜¤í‚¤ë‚˜ì™€"]
        };

        // ===== 3ë²ˆ(ì§€ì—­ ê²½ê³„ì„  íŒŒë¼ë¯¸í„°) í•µì‹¬: bounds ê¸°ë°˜(ëŒ€ëµ) =====
        // ì‹¤ì œ í–‰ì • ê²½ê³„ GeoJSONì´ ì—†ìœ¼ë¯€ë¡œ, "íŒŒë¼ë¯¸í„°ì‹(ì¡°ì ˆ ê°€ëŠ¥í•œ)" ê²½ê³„ì„  ì‹œê°í™”ë¡œ êµ¬í˜„.
        const regionBoundaryParams = {
            // í•œêµ­ (rough bounds)
            "ì„œìš¸":   { type: "bounds", bounds: [[37.43, 126.76], [37.70, 127.18]] },
            "ê²½ê¸°":   { type: "bounds", bounds: [[36.90, 126.35], [38.30, 127.95]] },
            "ê°•ì›":   { type: "bounds", bounds: [[37.00, 127.05], [38.62, 129.35]] },
            "ì¶©ë‚¨":   { type: "bounds", bounds: [[36.05, 125.90], [36.98, 127.70]] },
            "ì¶©ë¶":   { type: "bounds", bounds: [[36.20, 127.05], [37.25, 128.65]] },
            "ì „ë¶":   { type: "bounds", bounds: [[35.30, 126.45], [36.15, 127.95]] },
            "ì „ë‚¨":   { type: "bounds", bounds: [[34.10, 125.95], [35.35, 127.95]] },
            "ê²½ë¶":   { type: "bounds", bounds: [[35.55, 127.75], [37.25, 130.10]] },
            "ê²½ë‚¨":   { type: "bounds", bounds: [[34.60, 127.20], [35.80, 129.35]] },
            "ë¶€ì‚°":   { type: "bounds", bounds: [[35.03, 128.82], [35.35, 129.32]] },
            "ì œì£¼":   { type: "bounds", bounds: [[33.08, 126.10], [33.60, 126.95]] },

            // ì¼ë³¸ (rough bounds)
            "ë„ì¿„":     { type: "bounds", bounds: [[35.52, 139.55], [35.86, 139.95]] },
            "ì˜¤ì‚¬ì¹´":   { type: "bounds", bounds: [[34.45, 135.25], [34.82, 135.70]] },
            "êµí† ":     { type: "bounds", bounds: [[34.85, 135.55], [35.20, 135.90]] },
            "í›„ì¿ ì˜¤ì¹´": { type: "bounds", bounds: [[33.45, 130.20], [33.75, 130.60]] },
            "í™‹ì¹´ì´ë„": { type: "bounds", bounds: [[41.30, 139.30], [45.80, 145.90]] },
            "ì˜¤í‚¤ë‚˜ì™€": { type: "bounds", bounds: [[24.00, 122.90], [27.40, 131.50]] },
        };

        // ===== 3. ì´ˆê¸°í™” =====
        window.onload = function() {
            initializeMap();
            setupSearch();
            setupDragSelection();
            renderHistory();
            renderRegionFilters("í•œêµ­");
        };

        function initializeMap() {
            // í…œí”Œë¦¿ ìš”êµ¬: ëŒ€í•œë¯¼êµ­ ì¤‘ì‹¬ [35.9,127.5], zoom 7
            map = L.map('map', { zoomControl: false }).setView([35.9, 127.5], 7);

            // 3ë²ˆ ìš”êµ¬: "ë§µ ìì²´ë„ ê¸°ë³¸ ë‹¤í¬"
            // 1) ë‹¤í¬ íƒ€ì¼(CartoDB Dark) ìš°ì„ 
            // 2) ì‹¤íŒ¨ ì‹œ OSMë¡œ fallback
            const darkTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 19,
                attribution: 'Â© OpenStreetMap Â© CARTO'
            });

            const osmTiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: 'OpenStreetMap'
            });

            darkTiles.addTo(map);
            darkTiles.on('tileerror', () => {
                if (map.hasLayer(darkTiles)) map.removeLayer(darkTiles);
                if (!map.hasLayer(osmTiles)) osmTiles.addTo(map);
            });

            L.control.zoom({ position: 'bottomright' }).addTo(map);

            markerClusterGroup = L.markerClusterGroup({
                maxClusterRadius: 60,
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: false,
                zoomToBoundsOnClick: true
            });

            loadEventMarkers(currentFilteredEvents);

            map.on('zoomend', function() {
                updateVisualization();
            });
        }

        // ===== 4. êµ­ê°€ ì „í™˜ =====
        function switchCountry(country) {
            currentCountry = country;
            currentFilteredEvents = mockEvents.filter(e => e.country === country);

            document.querySelectorAll('.country-btn').forEach(btn => {
                btn.classList.remove('bg-primary-600', 'text-white');
                btn.classList.add('bg-google-gray', 'text-gray-300');
            });

            if (country === "í•œêµ­") {
                document.getElementById('btn-korea').classList.add('bg-primary-600', 'text-white');
                document.getElementById('btn-korea').classList.remove('bg-google-gray', 'text-gray-300');
                map.setView([35.9, 127.5], 7);
            } else {
                document.getElementById('btn-japan').classList.add('bg-primary-600', 'text-white');
                document.getElementById('btn-japan').classList.remove('bg-google-gray', 'text-gray-300');
                map.setView([36.5, 138], 6);
            }

            renderRegionFilters(country);
            clearSelection();
            loadEventMarkers(currentFilteredEvents);
        }

        // ===== 5. ì§€ì—­ í•„í„° ë Œë”ë§ =====
        function renderRegionFilters(country) {
            const container = document.getElementById('region-filters');
            const regionList = regions[country];

            container.innerHTML = regionList.map(r =>
                `<button onclick="highlightRegion('${r}')" class="px-3 py-1 bg-google-gray text-gray-200 rounded-full shadow-md text-xs font-semibold whitespace-nowrap hover:bg-gray-600 transition">${r}</button>`
            ).join('');
        }

        // ===== 6. ë§ˆì»¤ ë¡œë”© (í´ëŸ¬ìŠ¤í„° + íˆíŠ¸ë§µ) =====
        function loadEventMarkers(events) {
            if (markerClusterGroup && map.hasLayer(markerClusterGroup)) map.removeLayer(markerClusterGroup);
            if (heatLayer && map.hasLayer(heatLayer)) map.removeLayer(heatLayer);

            markerClusterGroup = L.markerClusterGroup({
                maxClusterRadius: 60,
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: false
            });

            markerMap.clear();

            const heatData = events.map(e => {
                // (ì‚°ì ë„/íˆíŠ¸ë§µ) ë°ì´í„°ê°€ ë§ì€ ê³³ì„ ë” ë¹¨ê°›ê²Œ í•˜ê³  ì‹¶ìœ¼ë©´ weightë¥¼ tags/img/memo ê¸°ë°˜ìœ¼ë¡œ ì˜¬ë¦¬ë©´ ë¨.
                // ì—¬ê¸°ì„  "tags ê°œìˆ˜"ë¥¼ weightë¡œ ì¡ì•„ì„œ, ë§ì€ ê³³ì¼ìˆ˜ë¡ ë¹¨ê°•ì— ê°€ê¹Œì›Œì§.
                const weight = Math.min(1.0, 0.35 + (e.tags?.length || 0) * 0.12);
                return [e.lat, e.lng, weight];
            });

            events.forEach(event => {
                const selectedClass = selectedMarkers.has(event.id) ? "selected" : "";

                const icon = L.divIcon({
                    className: 'custom-icon',
                    html: `<div class="event-marker ${selectedClass}" data-id="${event.id}">
                             <img src="${event.img}" onerror="this.src='https://via.placeholder.com/45'">
                           </div>`,
                    iconSize: [45, 45],
                    iconAnchor: [22.5, 22.5]
                });

                const marker = L.marker([event.lat, event.lng], { icon });

                marker.bindTooltip(event.name, {
                    permanent: false,
                    direction: 'top',
                    offset: [0, -20],
                    className: 'bg-gray-800 text-white px-2 py-1 rounded-md shadow-lg text-xs font-semibold'
                });

                marker.on('click', () => showDetailSheet(event));
                markerClusterGroup.addLayer(marker);

                markerMap.set(event.id, { marker, event });
            });

            heatLayer = L.heatLayer(heatData, {
                radius: 35,
                blur: 20,
                maxZoom: 8,
                gradient: {0.4: 'blue', 0.65: 'yellow', 0.85: 'orange', 1: 'red'}
            });

            updateVisualization();
        }

        // ===== 7. ì‚°ì ë„/ë§ˆì»¤ ì „í™˜ =====
        function updateVisualization() {
            const zoom = map.getZoom();

            if (isHeatmapMode || zoom <= 5) {
                if (map.hasLayer(markerClusterGroup)) map.removeLayer(markerClusterGroup);
                if (!map.hasLayer(heatLayer)) map.addLayer(heatLayer);
            } else {
                if (map.hasLayer(heatLayer)) map.removeLayer(heatLayer);
                if (!map.hasLayer(markerClusterGroup)) map.addLayer(markerClusterGroup);
            }
        }

        function toggleHeatmap() {
            isHeatmapMode = !isHeatmapMode;
            updateVisualization();
        }

        // ===== 8. ì§€ì—­ ê²½ê³„ì„  ë°œê´‘ íš¨ê³¼ (íŒŒë¼ë¯¸í„°ì‹) =====
        function highlightRegion(regionName) {
            if (activeGlowLayer) {
                map.removeLayer(activeGlowLayer);
                activeGlowLayer = null;
            }

            const p = regionBoundaryParams[regionName];

            // ì„ì‹œ ë°œê´‘ìƒ‰(ìš”êµ¬ì‚¬í•­): #ffeb3b
            const glowStyle = {
                color: '#ffeb3b',
                fillColor: '#ffeb3b',
                fillOpacity: 0.12,
                weight: 3,
                className: 'glow-region'
            };

            if (p?.type === "bounds") {
                const b = L.latLngBounds(p.bounds);
                activeGlowLayer = L.rectangle(b, glowStyle).addTo(map);
                map.fitBounds(b.pad(0.15), { animate: true });
            } else {
                // fallback: í•´ë‹¹ ì§€ì—­ ì´ë²¤íŠ¸ì˜ í‰ê·  ì¢Œí‘œë¡œ ì›í˜• í‘œì‹œ(ìµœí›„ ìˆ˜ë‹¨)
                const events = currentFilteredEvents.filter(e => e.region === regionName);
                if (events.length > 0) {
                    const avg = events.reduce((acc, e) => ({ lat: acc.lat + e.lat, lng: acc.lng + e.lng }), { lat: 0, lng: 0 });
                    const center = [avg.lat / events.length, avg.lng / events.length];
                    activeGlowLayer = L.circle(center, { ...glowStyle, radius: 45000 }).addTo(map);
                    map.setView(center, Math.max(map.getZoom(), 9), { animate: true });
                }
            }

            // ì¼ì • ì‹œê°„ í›„ ìë™ ì œê±°(ì„ì‹œ íš¨ê³¼)
            setTimeout(() => {
                if (activeGlowLayer) {
                    map.removeLayer(activeGlowLayer);
                    activeGlowLayer = null;
                }
            }, 3500);
        }

        // ===== 9. íƒœê·¸ í•„í„°ë§ =====
        function filterByTag(tag) {
            let filtered;
            if (tag === 'ì „ì²´') {
                filtered = mockEvents.filter(e => e.country === currentCountry);
            } else {
                filtered = mockEvents.filter(e =>
                    e.country === currentCountry && e.tags.includes(tag)
                );
            }
            currentFilteredEvents = filtered;
            loadEventMarkers(filtered);
        }

        // ===== 10. Alt+ë“œë˜ê·¸ ì„ íƒ (ì„ íƒ ì‹¤ì œ ë™ì‘ ë³´ê°•) =====
        function setupDragSelection() {
            const box = document.createElement('div');
            box.className = 'selection-box';
            box.style.display = 'none';
            document.body.appendChild(box);

            let startPoint = null;
            let isDragging = false;

            const mapEl = map.getContainer();

            mapEl.addEventListener('mousedown', (e) => {
                if (!e.altKey) return;

                e.preventDefault();
                map.dragging.disable();

                startPoint = { x: e.clientX, y: e.clientY };
                isDragging = true;

                box.style.left = startPoint.x + 'px';
                box.style.top = startPoint.y + 'px';
                box.style.width = '0px';
                box.style.height = '0px';
                box.style.display = 'block';
            });

            window.addEventListener('mousemove', (e) => {
                if (!isDragging) return;

                const width = Math.abs(e.clientX - startPoint.x);
                const height = Math.abs(e.clientY - startPoint.y);
                const left = Math.min(e.clientX, startPoint.x);
                const top = Math.min(e.clientY, startPoint.y);

                box.style.width = width + 'px';
                box.style.height = height + 'px';
                box.style.left = left + 'px';
                box.style.top = top + 'px';
            });

            window.addEventListener('mouseup', (e) => {
                if (!isDragging) return;

                // 1) rectë¥¼ ë¨¼ì € ê³„ì‚°(ì¤‘ìš”): display:none í•˜ê¸° ì „ì— ì¢Œí‘œ í™•ë³´
                const rect = box.getBoundingClientRect();

                // 2) ì´ì œ ë“œë˜ê·¸ ì¢…ë£Œ ì²˜ë¦¬
                isDragging = false;
                box.style.display = 'none';
                map.dragging.enable();

                // 3) screen ì¢Œí‘œ -> map container ì¢Œí‘œë¡œ ë³€í™˜(ì¤‘ìš”)
                const mapRect = mapEl.getBoundingClientRect();

                // map container ë‚´ë¶€ë¡œ clamp
                const left = Math.max(0, rect.left - mapRect.left);
                const top = Math.max(0, rect.top - mapRect.top);
                const right = Math.min(mapRect.width, rect.right - mapRect.left);
                const bottom = Math.min(mapRect.height, rect.bottom - mapRect.top);

                // ë„ˆë¬´ ì‘ì€ ë“œë˜ê·¸ëŠ” ë¬´ì‹œ(í´ë¦­ ì˜¤ì¸ ë°©ì§€)
                if (Math.abs(right - left) < 6 || Math.abs(bottom - top) < 6) return;

                const p1 = L.point(left, top);
                const p2 = L.point(right, bottom);

                const ll1 = map.containerPointToLatLng(p1);
                const ll2 = map.containerPointToLatLng(p2);
                const bounds = L.latLngBounds(ll1, ll2);

                let newSelectedCount = 0;

                for (const [id, { marker, event }] of markerMap) {
                    if (bounds.contains([event.lat, event.lng])) {
                        if (!selectedMarkers.has(id)) newSelectedCount++;
                        selectedMarkers.add(id);
                        syncMarkerSelectedState(id, true);
                    }
                }

                if (newSelectedCount > 0 || selectedMarkers.size > 0) {
                    updateSelectionPanel();
                }
            });
        }

        function syncMarkerSelectedState(id, isSelected) {
            const item = markerMap.get(id);
            if (!item) return;

            const markerEl = item.marker.getElement();
            if (!markerEl) return; // í´ëŸ¬ìŠ¤í„°ë¡œ DOMì´ ì—†ì„ ìˆ˜ ìˆìŒ

            const markerDiv = markerEl.querySelector('.event-marker');
            if (!markerDiv) return;

            if (isSelected) markerDiv.classList.add('selected');
            else markerDiv.classList.remove('selected');
        }

        // ===== 11. ì„ íƒ íŒ¨ë„ ê´€ë¦¬ =====
        function updateSelectionPanel() {
            const panel = document.getElementById('selection-panel');
            const count = document.getElementById('selected-count');

            count.textContent = selectedMarkers.size;

            if (selectedMarkers.size > 0) panel.classList.add('active');
            else panel.classList.remove('active');
        }

        function closeSelectionPanel() {
            clearSelection();
        }

        function clearSelection() {
            for (const id of selectedMarkers) {
                syncMarkerSelectedState(id, false);
            }

            selectedMarkers.clear();
            updateSelectionPanel();
        }

        function addTagToSelected() {
            if (selectedMarkers.size === 0) return;

            const tagName = prompt('ì¶”ê°€í•  íƒœê·¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:');
            if (!tagName) return;

            for (const id of selectedMarkers) {
                const item = markerMap.get(id);
                if (!item?.event) continue;

                if (!item.event.tags.includes(tagName)) {
                    item.event.tags.push(tagName);
                }
            }

            alert(`${selectedMarkers.size}ê°œ ì¶•ì œì— "${tagName}" íƒœê·¸ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }

        function exportSelected() {
            if (selectedMarkers.size === 0) return;

            const exportData = [];
            for (const id of selectedMarkers) {
                const item = markerMap.get(id);
                if (item) exportData.push(item.event);
            }

            const json = JSON.stringify(exportData, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'selected_events.json';
            a.click();

            URL.revokeObjectURL(url);
        }

        // ===== 12. ê²€ìƒ‰ =====
        function setupSearch() {
            const input = document.getElementById('search-input');
            let debounceTimer;

            input.addEventListener('input', (e) => {
                const keyword = e.target.value.trim().toLowerCase();

                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    if (!keyword) {
                        currentFilteredEvents = mockEvents.filter(ev => ev.country === currentCountry);
                        loadEventMarkers(currentFilteredEvents);
                        return;
                    }

                    const filtered = mockEvents.filter(ev =>
                        ev.country === currentCountry && (
                            ev.name.toLowerCase().includes(keyword) ||
                            ev.region.toLowerCase().includes(keyword) ||
                            ev.tags.some(t => t.toLowerCase().includes(keyword))
                        )
                    );

                    currentFilteredEvents = filtered;
                    loadEventMarkers(filtered);
                }, 250);
            });

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    addToHistory(input.value.trim());
                }
            });
        }

        // ===== 13. íˆìŠ¤í† ë¦¬ =====
        function addToHistory(keyword) {
            if (!keyword) return;

            const index = searchBuffer.indexOf(keyword);
            if (index > -1) searchBuffer.splice(index, 1);

            searchBuffer.unshift(keyword);

            if (searchBuffer.length > MAX_HISTORY) searchBuffer.pop();

            renderHistory();
        }

        function renderHistory() {
            const container = document.getElementById('search-history');
            container.innerHTML = searchBuffer.map(k =>
                `<span onclick="searchByHistory('${k}')" class="history-chip px-2 py-0.5 rounded-md whitespace-nowrap">${k}</span>`
            ).join('');
        }

        function searchByHistory(keyword) {
            document.getElementById('search-input').value = keyword;
            document.getElementById('search-input').dispatchEvent(new Event('input'));
        }

        // ===== 14. ìƒì„¸ ì‹œíŠ¸ =====
        function showDetailSheet(event) {
            const sheet = document.getElementById('detail-sheet');

            document.getElementById('sheet-title').innerText = `${event.name} (${event.region})`;
            document.getElementById('sheet-summary').innerText = event.summary;
            document.getElementById('sheet-celeb').innerText = event.celeb;
            document.getElementById('sheet-image').src = event.img;

            const tagsContainer = document.getElementById('sheet-tags');
            tagsContainer.innerHTML = event.tags.map(t =>
                `<span class="bg-primary-600 text-white px-2 py-0.5 rounded-md text-xs">${t}</span>`
            ).join('');

            sheet.classList.add('active');
            map.panTo([event.lat, event.lng]);
        }

        function hideDetailSheet() {
            document.getElementById('detail-sheet').classList.remove('active');
        }
    </script>
</body>
</html>

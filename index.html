<!DOCTYPE html>
<html lang="ko" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EventMap Pro: Korea & Japan</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'dark-bg': '#121212', // Material Dark
                        'dark-surface': '#1E1E1E',
                        'primary-500': '#10b981',
                        'primary-glow': '#ffeb3b', // ì§€ì—­ ê°•ì¡°ìš© ë…¸ë€ìƒ‰
                    },
                    fontFamily: {
                        sans: ['Inter', 'Malgun Gothic', 'Dotum', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <!-- Leaflet MarkerCluster CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <style>
        /* ë§µ ê°•ì œ ë‹¤í¬ëª¨ë“œ (Invert Filter) */
        .leaflet-tile-pane {
            filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }

        /* ë§µ ì „ì²´ ìŠ¤íƒ€ì¼ */
        #map {
            height: 100vh;
            width: 100vw;
            z-index: 10;
            background-color: #121212;
        }

        /* ì»¤ìŠ¤í…€ ë§ˆì»¤ ìŠ¤íƒ€ì¼ */
        .event-marker {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid #10b981;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
            background: #1e1e1e;
        }
        .event-marker:hover {
            transform: scale(1.1);
            z-index: 1000 !important;
        }
        .event-marker img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        /* ì„ íƒëœ ë§ˆì»¤ ìŠ¤íƒ€ì¼ (Alt+Drag) */
        .event-marker.selected-marker {
            border-color: #ff4444 !important;
            box-shadow: 0 0 15px #ff4444;
            transform: scale(1.15);
        }

        /* í´ëŸ¬ìŠ¤í„°ë§: ë°ì´í„° ë§ì„ ë•Œ ë¹¨ê°„ìƒ‰ í‘œì‹œ (Red Heatmap ëŠë‚Œ) */
        .marker-cluster-small { background-color: rgba(181, 226, 140, 0.6); }
        .marker-cluster-small div { background-color: rgba(110, 204, 57, 0.6); }
        .marker-cluster-medium { background-color: rgba(241, 211, 87, 0.6); }
        .marker-cluster-medium div { background-color: rgba(240, 194, 12, 0.6); }
        
        /* Large í´ëŸ¬ìŠ¤í„° -> ë¹¨ê°„ìƒ‰ ê°•ì¡° */
        .marker-cluster-large { 
            background-color: rgba(253, 156, 115, 0.6); 
        }
        .marker-cluster-large div { 
            background-color: rgba(241, 128, 23, 0.6); 
        }
        /* Custom Very High Density (Overridden in JS) */
        .cluster-high-density {
            background-color: rgba(255, 0, 0, 0.4) !important;
        }
        .cluster-high-density div {
            background-color: rgba(255, 0, 0, 0.7) !important;
            color: white;
            font-weight: bold;
        }

        /* í•˜ë‹¨ íƒ­ (Bottom Sheet) */
        #detail-sheet {
            transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            transform: translateY(100%);
            z-index: 50;
        }
        #detail-sheet.active {
            transform: translateY(0);
        }

        /* ì§€ì—­ ê²½ê³„ ë°œê´‘ íš¨ê³¼ (Glow) */
        @keyframes pulse-glow {
            0% { box-shadow: 0 0 10px #ffeb3b inset, 0 0 20px #ffeb3b; stroke-opacity: 0.8; }
            50% { box-shadow: 0 0 20px #ffeb3b inset, 0 0 40px #ffeb3b; stroke-opacity: 0.4; }
            100% { box-shadow: 0 0 10px #ffeb3b inset, 0 0 20px #ffeb3b; stroke-opacity: 0.8; }
        }
        .region-glow-path {
            stroke: #ffeb3b;
            stroke-width: 3;
            fill: #ffeb3b;
            fill-opacity: 0.1;
            animation: pulse-glow 2s infinite;
            filter: drop-shadow(0 0 10px #ffeb3b);
        }

        /* ë“œë˜ê·¸ ì„ íƒ ë°•ìŠ¤ */
        .selection-box {
            border: 2px dashed #ff4444;
            background-color: rgba(255, 68, 68, 0.2);
            position: absolute;
            z-index: 2000; /* ì§€ë„ë³´ë‹¤ ìœ„ */
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-[#121212] text-gray-200 overflow-hidden font-sans">

    <!-- ìƒë‹¨ UI ì»¨í…Œì´ë„ˆ (ê²€ìƒ‰, í•„í„°) -->
    <div class="fixed top-4 left-0 right-0 z-[60] px-4 flex flex-col items-center gap-3 pointer-events-none">
        
        <!-- 1. ê²€ìƒ‰ì°½ (ìµœê·¼ ê²€ìƒ‰ì–´ í¬í•¨) -->
        <div class="relative group w-full max-w-md pointer-events-auto">
            <input type="text" id="search-input" 
                placeholder="ì¶•ì œëª…, ì§€ì—­, íƒœê·¸ ê²€ìƒ‰ (Alt+ë“œë˜ê·¸ë¡œ ë‹¤ì¤‘ì„ íƒ)" 
                class="w-full pl-10 pr-4 py-2 rounded-full bg-dark-surface border border-gray-700 focus:border-primary-500 focus:ring-2 focus:ring-primary-500 text-white shadow-lg transition-all duration-300 group-hover:w-[105%]"
                autocomplete="off">
            <svg class="w-5 h-5 text-gray-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            
            <!-- ìµœê·¼ ê²€ìƒ‰ì–´ (Focus ì‹œ ë…¸ì¶œ) -->
            <div id="search-history" class="hidden absolute top-full left-0 right-0 mt-2 bg-dark-surface rounded-xl shadow-2xl border border-gray-700 overflow-hidden">
                <div class="px-4 py-2 text-xs text-gray-500 font-bold bg-[#1a1a1a]">ìµœê·¼ ê²€ìƒ‰</div>
                <ul id="history-list" class="text-sm">
                    <!-- JSë¡œ ì£¼ì… -->
                </ul>
            </div>
        </div>

        <!-- 2. êµ­ê°€/ì§€ì—­ í•„í„° (2ë‹¨ êµ¬ì¡°) -->
        <div class="pointer-events-auto flex flex-col items-center gap-2 bg-dark-surface/80 backdrop-blur-md p-3 rounded-2xl border border-gray-700 shadow-xl max-w-3xl">
            <!-- êµ­ê°€ íƒ­ -->
            <div class="flex space-x-2">
                <button onclick="setCountry('Korea')" id="btn-korea" class="px-4 py-1.5 rounded-full text-sm font-bold bg-primary-500 text-white transition">ğŸ‡°ğŸ‡· í•œêµ­</button>
                <button onclick="setCountry('Japan')" id="btn-japan" class="px-4 py-1.5 rounded-full text-sm font-bold bg-gray-700 text-gray-300 hover:bg-gray-600 transition">ğŸ‡¯ğŸ‡µ ì¼ë³¸</button>
            </div>
            <!-- ì§€ì—­ ëª©ë¡ (ë™ì  ë³€ê²½) -->
            <div id="region-list" class="flex flex-wrap justify-center gap-2 max-h-24 overflow-y-auto custom-scrollbar">
                <!-- JSë¡œ ì£¼ì… -->
            </div>
        </div>

        <!-- 3. í…Œë§ˆ í•„í„° -->
        <div class="pointer-events-auto flex space-x-2">
            <button onclick="filterByTag('ì „ì²´')" class="px-3 py-1 rounded-lg bg-gray-700 text-xs hover:bg-gray-600 transition">ì „ì²´</button>
            <button onclick="filterByTag('ìŒì‹')" class="px-3 py-1 rounded-lg bg-orange-900 text-orange-200 text-xs hover:bg-orange-800 transition">ğŸ” ìŒì‹</button>
            <button onclick="filterByTag('ë¬¸í™”')" class="px-3 py-1 rounded-lg bg-purple-900 text-purple-200 text-xs hover:bg-purple-800 transition">ğŸ­ ë¬¸í™”</button>
            <button onclick="filterByTag('ìŒì•…')" class="px-3 py-1 rounded-lg bg-red-900 text-red-200 text-xs hover:bg-red-800 transition">ğŸµ ìŒì•…</button>
            <button onclick="filterByTag('ìì—°')" class="px-3 py-1 rounded-lg bg-green-900 text-green-200 text-xs hover:bg-green-800 transition">ğŸŒ¿ ìì—°</button>
        </div>
    </div>

    <!-- ì§€ë„ ì»¨í…Œì´ë„ˆ -->
    <div id="map" class="relative outline-none"></div>

    <!-- ë“œë˜ê·¸ ì„ íƒ ë°•ìŠ¤ (ë™ì  ìƒì„±ìš©) -->
    <div id="selection-box" class="selection-box hidden"></div>

    <!-- í•˜ë‹¨ ì´ë²¤íŠ¸ ìƒì„¸ ì •ë³´ íƒ­ (Bottom Sheet) -->
    <div id="detail-sheet" class="fixed bottom-0 left-0 right-0 max-h-[50vh] bg-dark-surface rounded-t-3xl shadow-2xl p-5 md:p-6 flex flex-col border-t border-gray-700">
        
        <!-- ìƒë‹¨ ì»¨íŠ¸ë¡¤ (ë‹«ê¸°) -->
        <div class="flex justify-between items-start mb-3 border-b border-gray-700 pb-3">
            <div class="flex-1 pr-4">
                <h2 id="sheet-title" class="text-xl font-extrabold text-white"></h2>
                <div id="sheet-tags" class="flex gap-1 mt-1 flex-wrap"></div>
            </div>
            <button id="close-button" class="flex-shrink-0 bg-gray-700 hover:bg-gray-600 text-white p-2 rounded-full transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>

        <!-- ìƒì„¸ ë‚´ìš© (ìŠ¤í¬ë¡¤ ê°€ëŠ¥) -->
        <div class="overflow-y-auto flex-grow custom-scrollbar flex gap-4">
            <!-- ì´ë¯¸ì§€ -->
            <div class="w-1/3 flex-shrink-0">
                <img id="sheet-image" src="" class="w-full h-32 object-cover rounded-lg border border-gray-600" alt="í–‰ì‚¬ ì´ë¯¸ì§€">
            </div>
            <!-- í…ìŠ¤íŠ¸ -->
            <div class="w-2/3">
                <div class="mb-4">
                    <h3 class="text-sm font-bold text-primary-500 mb-1">í–‰ì‚¬ ìš”ì•½</h3>
                    <p id="sheet-summary" class="text-gray-300 text-sm leading-relaxed whitespace-pre-line"></p>
                </div>
                <div>
                    <h3 class="text-sm font-bold text-primary-500 mb-1">ì´ˆì²­ ê²ŒìŠ¤íŠ¸</h3>
                    <p id="sheet-celeb" class="text-gray-300 text-sm"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. ë°ì´í„° ì •ì˜ (í•œêµ­ 24ê°œ + ì¼ë³¸ 13ê°œ) ---
        const mockEvents = [
            // í•œêµ­ ë°ì´í„° (ê¸°ì¡´ ì¶©ë‚¨/ì¶©ë¶ + í™•ì¥)
            { id: 1, name: "ì²œì•ˆ ë¹µ í˜ìŠ¤í‹°ë²Œ", lat: 36.814, lng: 127.113, location: "ì¶©ë‚¨ ì²œì•ˆ", country: "Korea", region: "ì¶©ë‚¨", tags: ["ìŒì‹"], color: "#50bdae", summary: "ì „êµ­ ìœ ëª… ë¹µì§‘ ì§‘ê²°", celeb: "ê¹€ì œë¹µ", imageUrl: "https://placehold.co/300x200/50bdae/fff?text=Bread" },
            { id: 2, name: "ë³´ë ¹ ë¨¸ë“œ ì¶•ì œ", lat: 36.315, lng: 126.541, location: "ì¶©ë‚¨ ë³´ë ¹", country: "Korea", region: "ì¶©ë‚¨", tags: ["ë¬¸í™”", "ì•¡í‹°ë¹„í‹°"], color: "#A0522D", summary: "ê¸€ë¡œë²Œ ë¨¸ë“œ ì²´í—˜", celeb: "K-POP ì•„ì´ëŒ", imageUrl: "https://placehold.co/300x200/A0522D/fff?text=Mud" },
            { id: 3, name: "ì„œìš¸ ë¶ˆê½ƒ ì¶•ì œ", lat: 37.528, lng: 126.936, location: "ì„œìš¸ ì—¬ì˜ë„", country: "Korea", region: "ì„œìš¸", tags: ["ë¬¸í™”", "ì•¼ê²½"], color: "#FF4500", summary: "í•œê°•ì˜ ê°€ì„ë°¤ì„ ìˆ˜ë†“ëŠ” ë¶ˆê½ƒ", celeb: "ë¶ˆê½ƒ ë””ìì´ë„ˆ", imageUrl: "https://placehold.co/300x200/FF4500/fff?text=Firework" },
            { id: 4, name: "ë¶€ì‚° êµ­ì œ ì˜í™”ì œ", lat: 35.171, lng: 129.127, location: "ë¶€ì‚° í•´ìš´ëŒ€", country: "Korea", region: "ë¶€ì‚°", tags: ["ë¬¸í™”", "ì˜í™”"], color: "#E50914", summary: "ì•„ì‹œì•„ ìµœëŒ€ ì˜í™”ì œ", celeb: "ìœ ëª… ë°°ìš° ë‹¤ìˆ˜", imageUrl: "https://placehold.co/300x200/E50914/fff?text=BIFF" },
            { id: 5, name: "ì „ì£¼ ë¹„ë¹”ë°¥ ì¶•ì œ", lat: 35.815, lng: 127.153, location: "ì „ë¶ ì „ì£¼", country: "Korea", region: "ì „ë¶", tags: ["ìŒì‹"], color: "#FFA500", summary: "ë§›ì˜ ê³ ì¥ ì „ì£¼ ë¹„ë¹”ë°¥", celeb: "í•œì‹ ëª…ì¸", imageUrl: "https://placehold.co/300x200/FFA500/fff?text=Bibim" },
            { id: 6, name: "ê°•ë¦‰ ì»¤í”¼ ì¶•ì œ", lat: 37.773, lng: 128.948, location: "ê°•ì› ê°•ë¦‰", country: "Korea", region: "ê°•ì›", tags: ["ìŒì‹", "ì»¤í”¼"], color: "#6F4E37", summary: "ë°”ë‹¤ì™€ í•¨ê»˜í•˜ëŠ” ì»¤í”¼", celeb: "ë°”ë¦¬ìŠ¤íƒ€", imageUrl: "https://placehold.co/300x200/6F4E37/fff?text=Coffee" },
            { id: 7, name: "ì œì£¼ ìœ ì±„ê½ƒ ì¶•ì œ", lat: 33.394, lng: 126.758, location: "ì œì£¼ ì„œê·€í¬", country: "Korea", region: "ì œì£¼", tags: ["ìì—°"], color: "#FFFF00", summary: "ë´„ì„ ì•Œë¦¬ëŠ” ë…¸ë€ ë¬¼ê²°", celeb: "ì—†ìŒ", imageUrl: "https://placehold.co/300x200/FFFF00/000?text=Flower" },
            { id: 8, name: "ì§„í•´ êµ°í•­ì œ", lat: 35.148, lng: 128.663, location: "ê²½ë‚¨ ì°½ì›", country: "Korea", region: "ê²½ë‚¨", tags: ["ìì—°", "ë²šê½ƒ"], color: "#FFB7C5", summary: "êµ­ë‚´ ìµœëŒ€ ë²šê½ƒ ì¶•ì œ", celeb: "êµ°ì•…ëŒ€", imageUrl: "https://placehold.co/300x200/FFB7C5/000?text=Cherry" },
            // ... (ë°ì´í„° ê¸¸ì´ìƒ ì¼ë¶€ ìƒëµ, ì‹¤ì œ êµ¬í˜„ì‹œ 24ê°œ ì±„ì›€)
            
            // ì¼ë³¸ ë°ì´í„° (13ê°œ)
            { id: 20, name: "ë„ì¿„ ê°„ë‹¤ ë§ˆì¸ ë¦¬", lat: 35.700, lng: 139.771, location: "ì¼ë³¸ ë„ì¿„", country: "Japan", region: "ë„ì¿„", tags: ["ë¬¸í™”"], color: "#FF0000", summary: "ì—ë„ 3ëŒ€ ë§ˆì¸ ë¦¬", celeb: "ì—†ìŒ", imageUrl: "https://placehold.co/300x200/FF0000/fff?text=Kanda" },
            { id: 21, name: "ì˜¤ì‚¬ì¹´ í…ì§„ ë§ˆì¸ ë¦¬", lat: 34.696, lng: 135.519, location: "ì¼ë³¸ ì˜¤ì‚¬ì¹´", country: "Japan", region: "ì˜¤ì‚¬ì¹´", tags: ["ë¬¸í™”", "ë¶ˆê½ƒ"], color: "#0000FF", summary: "ì²œë…„ì˜ ì—­ì‚¬, ë±ƒë†€ì´ì™€ ë¶ˆê½ƒ", celeb: "ì—†ìŒ", imageUrl: "https://placehold.co/300x200/0000FF/fff?text=Tenjin" },
            { id: 22, name: "êµí†  ê¸°ì˜¨ ë§ˆì¸ ë¦¬", lat: 35.003, lng: 135.777, location: "ì¼ë³¸ êµí† ", country: "Japan", region: "êµí† ", tags: ["ë¬¸í™”"], color: "#800080", summary: "êµí† ì˜ ì—¬ë¦„ì„ ì•Œë¦¬ëŠ” ì¶•ì œ", celeb: "ì—†ìŒ", imageUrl: "https://placehold.co/300x200/800080/fff?text=Gion" },
            { id: 23, name: "ì‚¿í¬ë¡œ ëˆˆ ì¶•ì œ", lat: 43.060, lng: 141.353, location: "ì¼ë³¸ í™‹ì¹´ì´ë„", country: "Japan", region: "í™‹ì¹´ì´ë„", tags: ["ìì—°", "ê²¨ìš¸"], color: "#E0FFFF", summary: "ì„¸ê³„ì ì¸ ëˆˆê³¼ ì–¼ìŒì˜ ì¶•ì œ", celeb: "ì—†ìŒ", imageUrl: "https://placehold.co/300x200/E0FFFF/000?text=Snow" },
            { id: 24, name: "í›„ì¿ ì˜¤ì¹´ ëˆíƒ€ì¿ ", lat: 33.593, lng: 130.404, location: "ì¼ë³¸ í›„ì¿ ì˜¤ì¹´", country: "Japan", region: "í›„ì¿ ì˜¤ì¹´", tags: ["ë¬¸í™”", "í¼ë ˆì´ë“œ"], color: "#FFA07A", summary: "ì‹œë¯¼ë“¤ì´ ì°¸ì—¬í•˜ëŠ” ëŒ€ê·œëª¨ í¼ë ˆì´ë“œ", celeb: "ì§€ì—­ ì•„ì´ëŒ", imageUrl: "https://placehold.co/300x200/FFA07A/fff?text=Dontaku" },
            { id: 25, name: "ì˜¤í‚¤ë‚˜ì™€ ì—ì´ì‚¬", lat: 26.334, lng: 127.801, location: "ì¼ë³¸ ì˜¤í‚¤ë‚˜ì™€", country: "Japan", region: "ì˜¤í‚¤ë‚˜ì™€", tags: ["ë¬¸í™”", "ìŒì•…"], color: "#FF4500", summary: "ì˜¤í‚¤ë‚˜ì™€ ì „í†µ ë¶ì¶¤ ì¶•ì œ", celeb: "ì²­ë…„íšŒ", imageUrl: "https://placehold.co/300x200/FF4500/fff?text=Eisa" }
        ];

        // ì§€ì—­ë³„ ê²½ê³„ íŒŒë¼ë¯¸í„° (ê°„ì´ Bounds) - Glow Effect ìš©
        const regionBoundaryParams = {
            'ì¶©ë‚¨': [[35.9, 125.5], [37.1, 127.6]],
            'ì„œìš¸': [[37.4, 126.7], [37.7, 127.2]],
            'ë¶€ì‚°': [[34.8, 128.7], [35.4, 129.3]],
            'ë„ì¿„': [[35.5, 138.9], [35.9, 139.9]],
            'ì˜¤ì‚¬ì¹´': [[34.2, 135.0], [35.0, 135.8]],
            // í•„ìš” ì‹œ ì¶”ê°€...
        };

        // --- 2. ì „ì—­ ë³€ìˆ˜ ---
        let map;
        let markersPlugin; // MarkerClusterGroup
        let currentCountry = 'Korea';
        let currentRegionFilter = 'ì „ì²´';
        let currentTagFilter = 'ì „ì²´';
        let detailSheet;
        let activeGlowLayer = null; // í˜„ì¬ ì¼œì§„ ê²½ê³„ Glow
        let isAltPressed = false;
        let dragStart = null;
        let selectionBoxDiv = document.getElementById('selection-box');
        let selectedMarkers = []; // ë“œë˜ê·¸ë¡œ ì„ íƒëœ ë§ˆì»¤ ID ëª©ë¡
        let searchHistory = JSON.parse(localStorage.getItem('eventMapHistory')) || [];

        // --- 3. ì´ˆê¸°í™” (window.onload) ---
        window.onload = function() {
            detailSheet = document.getElementById('detail-sheet');
            
            // 3.1 ë§µ ì´ˆê¸°í™”
            map = L.map('map', {
                zoomControl: false, // ì¤Œ ì»¨íŠ¸ë¡¤ ìœ„ì¹˜ ì´ë™ ë“±ì„ ìœ„í•´ ì¼ë‹¨ ë”
                preferCanvas: true
            }).setView([35.9, 127.5], 7);

            L.control.zoom({ position: 'topright' }).addTo(map);

            // 3.2 íƒ€ì¼ ë ˆì´ì–´ (OSM) - CSSë¡œ ë‹¤í¬ëª¨ë“œ ë°˜ì „ë¨
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);

            // 3.3 í´ëŸ¬ìŠ¤í„° ê·¸ë£¹ ì´ˆê¸°í™” (ë¹¨ê°„ìƒ‰ ê°•ì¡° ë¡œì§ í¬í•¨)
            markersPlugin = L.markerClusterGroup({
                iconCreateFunction: function(cluster) {
                    const count = cluster.getChildCount();
                    let c = ' marker-cluster-';
                    if (count < 5) { c += 'small'; }
                    else if (count < 10) { c += 'medium'; }
                    else { c += 'large cluster-high-density'; } // 10ê°œ ì´ìƒì´ë©´ ë¹¨ê°„ìƒ‰(Dense)

                    return new L.DivIcon({ 
                        html: '<div><span>' + count + '</span></div>', 
                        className: 'marker-cluster' + c, 
                        iconSize: new L.Point(40, 40) 
                    });
                },
                disableClusteringAtZoom: 16
            });
            map.addLayer(markersPlugin);

            // 3.4 ì´ë²¤íŠ¸ ì—°ê²°
            document.getElementById('close-button').addEventListener('click', hideDetailSheet);
            
            // ê²€ìƒ‰ì°½ ì´ë²¤íŠ¸
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('focus', showSearchHistory);
            searchInput.addEventListener('blur', () => setTimeout(hideSearchHistory, 200));
            searchInput.addEventListener('input', handleSearch);
            searchInput.addEventListener('keyup', (e) => {
                if(e.key === 'Enter') saveSearchHistory(e.target.value);
            });

            // Alt í‚¤ ì´ë²¤íŠ¸ (ë“œë˜ê·¸ ì„ íƒ)
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Alt') {
                    isAltPressed = true;
                    map.dragging.disable(); // ë§µ ë“œë˜ê·¸ ë°©ì§€
                    document.getElementById('map').style.cursor = 'crosshair';
                }
            });
            window.addEventListener('keyup', (e) => {
                if (e.key === 'Alt') {
                    isAltPressed = false;
                    map.dragging.enable();
                    document.getElementById('map').style.cursor = '';
                    // Alt ë–¼ë©´ ë“œë˜ê·¸ ë°•ìŠ¤ ìˆ¨ê¹€
                    selectionBoxDiv.classList.add('hidden');
                }
            });

            // ë§µ ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ (ë“œë˜ê·¸ ë°•ìŠ¤)
            map.getContainer().addEventListener('mousedown', onMapMouseDown);
            map.getContainer().addEventListener('mousemove', onMapMouseMove);
            map.getContainer().addEventListener('mouseup', onMapMouseUp);
            // ë§µ í´ë¦­ ì‹œ ì„ íƒ í•´ì œ
            map.on('click', deselectAll);

            // ì´ˆê¸° ë Œë”ë§
            setCountry('Korea'); // í•œêµ­ ê¸°ë³¸
            renderSearchHistory();
        };

        // --- 4. ë¡œì§ êµ¬í˜„ ---

        // 4.1 ë°ì´í„° ë¡œë“œ ë° ë§ˆì»¤ í‘œì‹œ
        function loadEventMarkers() {
            markersPlugin.clearLayers(); // ê¸°ì¡´ ë§ˆì»¤ ì œê±°

            const filtered = mockEvents.filter(e => {
                const countryMatch = e.country === currentCountry;
                const regionMatch = currentRegionFilter === 'ì „ì²´' || e.region === currentRegionFilter;
                const tagMatch = currentTagFilter === 'ì „ì²´' || e.tags.includes(currentTagFilter);
                return countryMatch && regionMatch && tagMatch;
            });

            filtered.forEach(event => {
                // HTML ë§ˆì»¤ ìƒì„±
                const customIcon = L.divIcon({
                    className: 'custom-event-marker',
                    html: `
                        <div class="event-marker" id="marker-${event.id}" style="border-color: ${event.color};">
                            <img src="${event.imageUrl}" alt="${event.name}" onerror="this.src='https://placehold.co/64x64/333/fff?text=E'"/>
                        </div>
                    `,
                    iconSize: [64, 64],
                    iconAnchor: [32, 64]
                });

                const marker = L.marker([event.lat, event.lng], { icon: customIcon, eventId: event.id });
                
                // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
                marker.on('click', (e) => {
                    L.DomEvent.stopPropagation(e); // ë§µ í´ë¦­ ì „íŒŒ ë°©ì§€
                    showDetailSheet(event);
                });

                markersPlugin.addLayer(marker);
            });
        }

        // 4.2 êµ­ê°€/ì§€ì—­ íƒ­ ë¡œì§
        function setCountry(country) {
            currentCountry = country;
            currentRegionFilter = 'ì „ì²´';
            
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            document.getElementById('btn-korea').className = country === 'Korea' 
                ? "px-4 py-1.5 rounded-full text-sm font-bold bg-primary-500 text-white transition shadow-lg" 
                : "px-4 py-1.5 rounded-full text-sm font-bold bg-gray-700 text-gray-300 hover:bg-gray-600 transition";
            document.getElementById('btn-japan').className = country === 'Japan' 
                ? "px-4 py-1.5 rounded-full text-sm font-bold bg-primary-500 text-white transition shadow-lg" 
                : "px-4 py-1.5 rounded-full text-sm font-bold bg-gray-700 text-gray-300 hover:bg-gray-600 transition";

            // ì§€ì—­ ëª©ë¡ ì—…ë°ì´íŠ¸
            const regionListDiv = document.getElementById('region-list');
            const regions = country === 'Korea' 
                ? ['ì „ì²´', 'ì„œìš¸', 'ê²½ê¸°', 'ê°•ì›', 'ì¶©ë‚¨', 'ì¶©ë¶', 'ì „ë¶', 'ì „ë‚¨', 'ê²½ë¶', 'ê²½ë‚¨', 'ë¶€ì‚°', 'ì œì£¼']
                : ['ì „ì²´', 'ë„ì¿„', 'ì˜¤ì‚¬ì¹´', 'êµí† ', 'í›„ì¿ ì˜¤ì¹´', 'í™‹ì¹´ì´ë„', 'ì˜¤í‚¤ë‚˜ì™€'];
            
            regionListDiv.innerHTML = regions.map(r => 
                `<button onclick="setRegion('${r}')" class="px-3 py-1 rounded border border-gray-600 text-xs text-gray-300 hover:bg-gray-700 hover:text-white transition ${r === 'ì „ì²´' ? 'bg-gray-700 text-white' : ''}">${r}</button>`
            ).join('');

            // ë·°í¬íŠ¸ ì´ë™
            if (country === 'Korea') map.setView([35.9, 127.5], 7);
            else map.setView([36.2, 138.2], 5); // ì¼ë³¸ ì „ì²´ ë·°

            loadEventMarkers();
        }

        function setRegion(region) {
            currentRegionFilter = region;
            
            // ë²„íŠ¼ í™œì„±í™” ìŠ¤íƒ€ì¼ ì²˜ë¦¬ (ê°„ë‹¨íˆ ë‹¤ì‹œ ê·¸ë¦¬ê¸°)
            const buttons = document.getElementById('region-list').querySelectorAll('button');
            buttons.forEach(btn => {
                if (btn.textContent === region) {
                    btn.classList.add('bg-primary-500', 'text-white', 'border-transparent');
                    btn.classList.remove('bg-gray-700', 'text-gray-300');
                } else {
                    btn.classList.remove('bg-primary-500', 'text-white', 'border-transparent');
                }
            });

            // ì§€ì—­ ë°œê´‘ íš¨ê³¼ (Glow)
            showRegionGlow(region);

            loadEventMarkers();
        }

        // 4.3 íƒœê·¸ í•„í„°ë§
        function filterByTag(tag) {
            currentTagFilter = tag;
            loadEventMarkers();
        }

        // 4.4 ì§€ì—­ ê²½ê³„ ë°œê´‘ (Parametric Glow)
        function showRegionGlow(region) {
            if (activeGlowLayer) {
                map.removeLayer(activeGlowLayer);
                activeGlowLayer = null;
            }

            if (region === 'ì „ì²´' || !regionBoundaryParams[region]) return;

            const bounds = regionBoundaryParams[region]; // [[lat1, lng1], [lat2, lng2]]
            
            // L.rectangleë¡œ ê²½ê³„ ìƒì„± í›„ CSS í´ë˜ìŠ¤ ë¶€ì—¬
            activeGlowLayer = L.rectangle(bounds, {
                className: 'region-glow-path', // CSS Animation Class
                color: '#ffeb3b',
                weight: 2,
                fillOpacity: 0
            }).addTo(map);

            map.fitBounds(bounds, { padding: [50, 50], animate: true, duration: 1.5 });
        }

        // 4.5 ë“œë˜ê·¸ ì„ íƒ (Alt + Drag)
        function onMapMouseDown(e) {
            if (!isAltPressed) return;
            dragStart = e;
            selectionBoxDiv.classList.remove('hidden');
            selectionBoxDiv.style.left = e.clientX + 'px';
            selectionBoxDiv.style.top = e.clientY + 'px';
            selectionBoxDiv.style.width = '0px';
            selectionBoxDiv.style.height = '0px';
        }

        function onMapMouseMove(e) {
            if (!isAltPressed || !dragStart) return;
            
            const x = Math.min(e.clientX, dragStart.clientX);
            const y = Math.min(e.clientY, dragStart.clientY);
            const w = Math.abs(e.clientX - dragStart.clientX);
            const h = Math.abs(e.clientY - dragStart.clientY);

            selectionBoxDiv.style.left = x + 'px';
            selectionBoxDiv.style.top = y + 'px';
            selectionBoxDiv.style.width = w + 'px';
            selectionBoxDiv.style.height = h + 'px';
        }

        function onMapMouseUp(e) {
            if (!isAltPressed || !dragStart) return;

            // ë“œë˜ê·¸ ë°•ìŠ¤ ì¢Œí‘œë¥¼ LatLngBoundsë¡œ ë³€í™˜
            const bounds = L.latLngBounds(
                map.containerPointToLatLng([parseInt(selectionBoxDiv.style.top), parseInt(selectionBoxDiv.style.left)]),
                map.containerPointToLatLng([
                    parseInt(selectionBoxDiv.style.top) + parseInt(selectionBoxDiv.style.height), 
                    parseInt(selectionBoxDiv.style.left) + parseInt(selectionBoxDiv.style.width)
                ])
            );

            // ë§ˆì»¤ ì„ íƒ ë¡œì§
            markersPlugin.eachLayer(layer => {
                if (bounds.contains(layer.getLatLng())) {
                    const iconDiv = layer.getElement()?.querySelector('.event-marker');
                    if (iconDiv) {
                        iconDiv.classList.add('selected-marker');
                        if (!selectedMarkers.includes(layer.options.eventId)) {
                            selectedMarkers.push(layer.options.eventId);
                        }
                    }
                }
            });

            console.log("Selected IDs:", selectedMarkers);
            dragStart = null;
            // selectionBoxDiv.classList.add('hidden'); // ë°•ìŠ¤ëŠ” ë‚¨ê²¨ë‘˜ ìˆ˜ë„ ìˆê³  ìˆ¨ê¸¸ ìˆ˜ë„ ìˆìŒ. ì—¬ê¸°ì„  ìˆ¨ê¹€.
        }

        function deselectAll() {
            if (isAltPressed) return; // Alt ëˆ„ë¥¸ ìƒíƒœë©´ í•´ì œ ì•ˆ í•¨
            selectedMarkers = [];
            document.querySelectorAll('.selected-marker').forEach(el => el.classList.remove('selected-marker'));
            if (activeGlowLayer) { // ë°°ê²½ í´ë¦­ ì‹œ ê¸€ë¡œìš°ë„ ëŒì§€ ì—¬ë¶€
                // map.removeLayer(activeGlowLayer); 
                // activeGlowLayer = null;
            }
        }

        // 4.6 ê²€ìƒ‰ ë° ê¸°ë¡
        function handleSearch(e) {
            const query = e.target.value.toLowerCase();
            if (!query) {
                loadEventMarkers(); // ì´ˆê¸°í™”
                return;
            }
            // ê²€ìƒ‰ í•„í„°ë§ (ì´ë¦„, ì§€ì—­, íƒœê·¸)
            markersPlugin.clearLayers();
            const results = mockEvents.filter(ev => 
                ev.name.toLowerCase().includes(query) || 
                ev.region.includes(query) || 
                ev.tags.some(t => t.includes(query))
            );
            
            results.forEach(ev => { /* ë§ˆì»¤ ì¬ìƒì„± ë¡œì§ (ìƒëµ - loadEventMarkers ì¬í™œìš© ê¶Œì¥) */ });
            // ê°„ë‹¨íˆ loadEventMarkersë¥¼ ìˆ˜ì •í•˜ì—¬ ê²€ìƒ‰ì–´ë¥¼ ë°›ê²Œ í•˜ëŠ” ê²ƒì´ ì¢‹ìœ¼ë‚˜, ì—¬ê¸°ì„  ìƒëµ
        }

        function saveSearchHistory(keyword) {
            if (!keyword) return;
            searchHistory = [keyword, ...searchHistory.filter(k => k !== keyword)].slice(0, 5);
            localStorage.setItem('eventMapHistory', JSON.stringify(searchHistory));
            renderSearchHistory();
        }

        function renderSearchHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = searchHistory.map(k => 
                `<li class="px-4 py-2 hover:bg-gray-700 cursor-pointer border-b border-gray-800 last:border-0" onclick="applySearch('${k}')">${k}</li>`
            ).join('');
        }

        function showSearchHistory() { document.getElementById('search-history').classList.remove('hidden'); }
        function hideSearchHistory() { document.getElementById('search-history').classList.add('hidden'); }
        function applySearch(k) {
            document.getElementById('search-input').value = k;
            // ê²€ìƒ‰ ë¡œì§ íŠ¸ë¦¬ê±°
        }

        // 4.7 ìƒì„¸ ì‹œíŠ¸ (UI ì—…ë°ì´íŠ¸)
        function showDetailSheet(eventData) {
            document.getElementById('sheet-title').innerText = eventData.name;
            document.getElementById('sheet-summary').innerText = eventData.summary;
            document.getElementById('sheet-celeb').innerText = eventData.celeb || "ì •ë³´ ì—†ìŒ";
            document.getElementById('sheet-image').src = eventData.imageUrl;
            
            // íƒœê·¸ í‘œì‹œ
            const tagsContainer = document.getElementById('sheet-tags');
            tagsContainer.innerHTML = eventData.tags.map(t => `<span class="px-2 py-0.5 rounded bg-gray-700 text-xs text-gray-300">#${t}</span>`).join('');

            detailSheet.classList.add('active');
            map.panTo([eventData.lat, eventData.lng], { animate: true, duration: 1 });
        }

        function hideDetailSheet() {
            detailSheet.classList.remove('active');
        }

    </script>
</body>
</html>

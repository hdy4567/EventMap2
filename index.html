<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EventMap2 - Global Festival Map</title>
    
    <!-- 1. ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ (Tailwind, Leaflet, MarkerCluster) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- MarkerCluster CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <style>
        /* ë‹¤í¬ëª¨ë“œ ë§µ ìŠ¤íƒ€ì¼ (êµ¬ê¸€ ë§µ ë‹¤í¬ í…Œë§ˆ ìœ ì‚¬) */
        #map {
            background-color: #000000;
        }
        /* ì§€ë„ íƒ€ì¼ í•„í„° ì ìš©: ë°˜ì „ ë° ìƒ‰ì¡° ì¡°ì •ìœ¼ë¡œ ë‹¤í¬ ëª¨ë“œ êµ¬í˜„ */
        .leaflet-layer,
        .leaflet-control-zoom-in,
        .leaflet-control-zoom-out,
        .leaflet-control-attribution {
            filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }
        
        /* íŒì—… ì°½ ë“±ì€ ë°˜ì „ë˜ì§€ ì•Šë„ë¡ ì¬ë°˜ì „ */
        .leaflet-popup-content-wrapper, .leaflet-marker-icon, .cluster {
            filter: invert(100%) hue-rotate(180deg) brightness(105%) contrast(110%);
        }

        /* ì»¤ìŠ¤í…€ ë§ˆì»¤ ìŠ¤íƒ€ì¼ */
        .custom-marker {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            object-fit: cover;
            transition: transform 0.2s;
        }
        .custom-marker:hover {
            transform: scale(1.1);
            border-color: #fbbf24; /* amber-400 */
        }
        .marker-selected {
            border-color: #2196F3 !important;
            box-shadow: 0 0 15px #2196F3;
            transform: scale(1.1);
        }

        /* í´ëŸ¬ìŠ¤í„° ì•„ì´ì½˜ ì»¤ìŠ¤í…€ (ë°ì´í„° ë°€ë„ ì‹œê°í™”) */
        .cluster-custom {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            border: 2px solid white;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        /* ì‚°ì ë„ í‘œì‹œ: ê°œìˆ˜ì— ë”°ë¥¸ ìƒ‰ìƒ ë¶„ê¸° */
        .cluster-low { background-color: rgba(76, 175, 80, 0.8); } /* ì´ˆë¡ < 5 */
        .cluster-medium { background-color: rgba(255, 193, 7, 0.8); color: black; } /* ë…¸ë‘ < 10 */
        .cluster-high { background-color: rgba(244, 67, 54, 0.9); animation: pulse-red 2s infinite; } /* ë¹¨ê°• >= 10 */

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(244, 67, 54, 0); }
            100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
        }

        /* ì§€ì—­ ê²½ê³„ì„  ë°œê´‘ íš¨ê³¼ (CSS SVG Animation) */
        .region-glow-path {
            stroke: #ffeb3b;
            stroke-width: 3;
            stroke-opacity: 0.8;
            fill-opacity: 0.1;
            filter: drop-shadow(0 0 10px #ffeb3b);
            animation: glow-pulse 2s infinite alternate;
        }

        @keyframes glow-pulse {
            from { stroke-opacity: 0.6; stroke-width: 3; }
            to { stroke-opacity: 1.0; stroke-width: 5; }
        }

        /* ë“œë˜ê·¸ ì…€ë ‰ì…˜ ë°•ìŠ¤ */
        .selection-box {
            position: absolute;
            border: 2px solid #2196F3;
            background-color: rgba(33, 150, 243, 0.2);
            z-index: 10000;
            pointer-events: none; /* ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ í†µê³¼ */
            display: none;
        }

        /* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }

        /* í•˜ë‹¨ ì‹œíŠ¸ ì• ë‹ˆë©”ì´ì…˜ */
        #detailSheet {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>
<body class="bg-black h-screen w-screen overflow-hidden text-white font-sans">

    <!-- ì§€ë„ ì»¨í…Œì´ë„ˆ -->
    <div id="map" class="h-full w-full z-0"></div>

    <!-- UI ì˜¤ë²„ë ˆì´ ì»¨í…Œì´ë„ˆ (ìƒë‹¨) -->
    <div class="absolute top-0 left-0 w-full z-[1000] p-4 pointer-events-none flex flex-col items-center gap-3 transition-all duration-300 group hover:pt-4">
        
        <!-- 1. ê²€ìƒ‰ì°½ (ë„¤ì´ë²„/êµ¬ê¸€ ìŠ¤íƒ€ì¼) -->
        <div class="pointer-events-auto w-full max-w-md bg-gray-900/90 backdrop-blur-md rounded-full border border-gray-700 shadow-xl flex items-center px-4 py-2 transition-all duration-300 group-hover:scale-100 scale-90 origin-top">
            <span class="text-green-500 font-bold mr-3">NAVER</span>
            <input type="text" id="searchInput" placeholder="ì¶•ì œ, ì§€ì—­, íƒœê·¸ ê²€ìƒ‰..." 
                class="bg-transparent border-none outline-none text-white flex-1 placeholder-gray-500 text-sm"
                onkeypress="handleSearch(event)">
            <button onclick="executeSearch()" class="text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </button>
        </div>

        <!-- ìµœê·¼ ê²€ìƒ‰ì–´ (LocalStorage) -->
        <div id="recentSearches" class="pointer-events-auto w-full max-w-md flex gap-2 overflow-x-auto text-xs px-2 scrollbar-hide opacity-0 group-hover:opacity-100 transition-opacity duration-300 h-0 group-hover:h-auto">
            <!-- JSë¡œ ì£¼ì…ë¨ -->
        </div>

        <!-- 2. êµ­ê°€/ë©”ëª¨ íƒ­ (KR / JP / MEMO) -->
        <div class="pointer-events-auto flex bg-gray-800/80 backdrop-blur rounded-lg p-1 border border-gray-700 shadow-lg">
            <button onclick="setCountry('KR')" id="tab-KR" class="px-4 py-1 rounded-md text-sm font-bold bg-blue-600 text-white transition-colors">KOREA</button>
            <button onclick="setCountry('JP')" id="tab-JP" class="px-4 py-1 rounded-md text-sm font-bold text-gray-400 hover:text-white transition-colors">JAPAN</button>
            <button onclick="setCountry('MEMO')" id="tab-MEMO" class="px-4 py-1 rounded-md text-sm font-bold text-gray-400 hover:text-white transition-colors">MEMO</button>
        </div>

        <!-- 3. ì§€ì—­/ì¹´í…Œê³ ë¦¬ íƒœê·¸ í•„í„° -->
        <div id="tagFilterContainer" class="pointer-events-auto w-full max-w-3xl flex flex-wrap justify-center gap-2 overflow-y-auto max-h-24 opacity-80 hover:opacity-100 transition-opacity">
            <!-- JSë¡œ ì§€ì—­ íƒœê·¸ ì£¼ì…ë¨ -->
        </div>
        
        <div class="pointer-events-auto flex gap-2">
            <input type="text" id="newLabelInput" placeholder="ìƒˆ ë¼ë²¨..." class="bg-gray-800 text-xs text-white px-2 py-1 rounded border border-gray-600">
            <button onclick="addUserLabel()" class="bg-gray-700 text-xs px-2 py-1 rounded hover:bg-gray-600">+ ë¼ë²¨ ì¶”ê°€</button>
        </div>
    </div>

    <!-- í•˜ë‹¨ ë””í…Œì¼ ì‹œíŠ¸ (Bottom Sheet) -->
    <div id="detailSheet" class="absolute bottom-0 left-0 w-full bg-gray-900/95 backdrop-blur-xl border-t border-gray-700 rounded-t-3xl p-6 transform translate-y-[110%] z-[1001] shadow-2xl transition-transform duration-300">
        <!-- ë‹«ê¸° ë²„íŠ¼ -->
        <button id="closeSheetBtn" class="absolute top-4 right-6 text-gray-400 hover:text-white">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
        
        <div class="flex flex-col md:flex-row gap-6 max-w-5xl mx-auto h-[60vh] md:h-[300px]">
            <!-- ì´ë¯¸ì§€ ì˜ì—­ (ë¹„ìœ¨ ìœ ì§€) -->
            <div class="w-full md:w-1/3 h-48 md:h-full rounded-xl overflow-hidden bg-gray-800 shadow-lg relative shrink-0">
                <img id="sheetImage" src="" alt="Festival" class="w-full h-full object-cover hover:scale-105 transition-transform duration-500">
                <div class="absolute top-2 left-2 bg-black/60 px-2 py-1 rounded text-xs text-yellow-400 font-bold" id="sheetRegion">SEOUL</div>
            </div>
            
            <!-- í…ìŠ¤íŠ¸ ì •ë³´ ì˜ì—­ -->
            <div class="flex-1 overflow-y-auto pr-2">
                <h2 id="sheetTitle" class="text-2xl md:text-3xl font-bold text-white mb-2">Event Title</h2>
                <div class="flex gap-2 mb-4" id="sheetTags">
                    <!-- íƒœê·¸ ë“¤ì–´ê° -->
                </div>
                <p id="sheetDesc" class="text-gray-300 text-sm leading-relaxed mb-4">Description goes here...</p>
                
                <div class="bg-gray-800 p-3 rounded-lg border border-gray-700">
                    <h3 class="text-sm font-bold text-purple-400 mb-1">ğŸ¤ ê²ŒìŠ¤íŠ¸ / ë¼ì¸ì—…</h3>
                    <p id="sheetCeleb" class="text-xs text-gray-400">ì´ˆì²­ ê²ŒìŠ¤íŠ¸ ì •ë³´</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ë“œë˜ê·¸ ì…€ë ‰ì…˜ ë°•ìŠ¤ -->
    <div id="selectionBox" class="selection-box"></div>

    <script>
        // --- 1. ì „ì—­ ë³€ìˆ˜ ë° ì„¤ì • ---
        let map;
        let markers = L.markerClusterGroup({
            iconCreateFunction: function(cluster) {
                const count = cluster.getChildCount();
                let c = 'cluster-low'; // < 5: ì´ˆë¡
                if (count >= 10) c = 'cluster-high'; // >= 10: ë¹¨ê°•
                else if (count >= 5) c = 'cluster-medium'; // < 10: ë…¸ë‘
                
                return L.divIcon({ 
                    html: `<div>${count}</div>`, 
                    className: `cluster-custom ${c}`, 
                    iconSize: L.point(40, 40) 
                });
            },
            showCoverageOnHover: false
        });
        
        let allMarkerInstances = []; // ë“œë˜ê·¸ ì„ íƒì„ ìœ„í•œ ë§ˆì»¤ ì°¸ì¡° ë°°ì—´
        let selectedMarkers = new Set(); // ì„ íƒëœ ë§ˆì»¤ ID ì§‘í•©
        let currentCountry = 'KR'; // KR, JP, MEMO
        let currentGlowLayer = null; // ì§€ì—­ ë°œê´‘ ë ˆì´ì–´

        // ì§€ì—­ ê²½ê³„ íŒŒë¼ë¯¸í„° (GeoJSON ëŒ€ì‹  ê²½ê³„ ë°•ìŠ¤ë¡œ ì‹œê°í™”)
        // [SouthWest, NorthEast]
        const regionBoundaryParams = {
            'ì„œìš¸': [[37.413294, 126.734086], [37.715133, 127.269311]],
            'ê²½ê¸°': [[36.893960, 126.376282], [38.284437, 127.852924]],
            'ê°•ì›': [[37.030588, 127.067347], [38.614682, 129.359223]],
            'ë¶€ì‚°': [[34.879908, 128.738436], [35.395936, 129.310925]],
            'ì œì£¼': [[33.111116, 126.160176], [33.606703, 126.980326]],
            'ë„ì¿„': [[35.501101, 138.942621], [35.898424, 139.919013]],
            'ì˜¤ì‚¬ì¹´': [[34.283116, 135.068305], [34.997637, 135.731776]],
            'í™‹ì¹´ì´ë„': [[41.348421, 139.340061], [45.522985, 145.817454]]
            // í•„ìš” ì‹œ ì¶”ê°€
        };

        // --- 2. ë°ì´í„° (Mock Data - ì „êµ­/ì¼ë³¸) ---
        const mockEvents = [
            // [í•œêµ­]
            { id: 1, title: 'ì„œìš¸ ì„¸ê³„ë¶ˆê½ƒì¶•ì œ', lat: 37.528, lng: 126.934, region: 'ì„œìš¸', country: 'KR', tags: ['ë¶ˆê½ƒ', 'ì•¼ê²½', 'í•œê°•'], imageUrl: 'https://cdn.pixabay.com/photo/2016/11/23/15/34/fireworks-1853655_1280.jpg', desc: 'ì—¬ì˜ë„ í•œê°•ê³µì›ì—ì„œ í¼ì³ì§€ëŠ” ê°€ì„ ë°¤ì˜ ë¶ˆê½ƒ ì‡¼.', celeb: 'í•œêµ­, ë¯¸êµ­, ì¼ë³¸ ë¶ˆê½ƒíŒ€' },
            { id: 2, title: 'ë¶€ì‚° êµ­ì œì˜í™”ì œ', lat: 35.171, lng: 129.127, region: 'ë¶€ì‚°', country: 'KR', tags: ['ì˜í™”', 'ë¬¸í™”', 'ë ˆë“œì¹´í«'], imageUrl: 'https://cdn.pixabay.com/photo/2014/04/05/11/40/film-315806_1280.jpg', desc: 'ì•„ì‹œì•„ ìµœëŒ€ì˜ ì˜í™” ì¶•ì œ, í•´ìš´ëŒ€ì™€ ì˜í™”ì˜ ì „ë‹¹.', celeb: 'ìœ ëª… ë°°ìš° ë° ê°ë… ë‹¤ìˆ˜' },
            { id: 3, title: 'ë³´ë ¹ ë¨¸ë“œì¶•ì œ', lat: 36.313, lng: 126.516, region: 'ì¶©ë‚¨', country: 'KR', tags: ['ì²´í—˜', 'ì—¬ë¦„', 'ë°”ë‹¤'], imageUrl: 'https://cdn.pixabay.com/photo/2017/08/02/00/49/people-2568943_1280.jpg', desc: 'ëŒ€ì²œí•´ìˆ˜ìš•ì¥ì—ì„œ ì¦ê¸°ëŠ” ì§„í™ ì²´í—˜.', celeb: 'K-POP ì•„ì´ëŒ' },
            { id: 4, title: 'ì „ì£¼ ë¹„ë¹”ë°¥ì¶•ì œ', lat: 35.814, lng: 127.151, region: 'ì „ë¶', country: 'KR', tags: ['ìŒì‹', 'ì „í†µ', 'í•œì˜¥'], imageUrl: 'https://cdn.pixabay.com/photo/2016/09/16/00/17/bibimbap-1673397_1280.jpg', desc: 'ì „ì£¼ í•œì˜¥ë§ˆì„ì—ì„œ ì¦ê¸°ëŠ” ë¯¸ì‹ ì¶•ì œ.', celeb: 'ìœ ëª… ì…°í”„' },
            { id: 5, title: 'ì§„í•´ êµ°í•­ì œ', lat: 35.148, lng: 128.663, region: 'ê²½ë‚¨', country: 'KR', tags: ['ë²šê½ƒ', 'ë´„', 'ì‚¬ì§„'], imageUrl: 'https://cdn.pixabay.com/photo/2017/04/17/09/27/cherry-blossoms-2236830_1280.jpg', desc: 'ëŒ€í•œë¯¼êµ­ ëŒ€í‘œ ë²šê½ƒ ì¶•ì œ.', celeb: 'êµ°ì•…ëŒ€' },
            { id: 6, title: 'ì œì£¼ ë“¤ë¶ˆì¶•ì œ', lat: 33.364, lng: 126.366, region: 'ì œì£¼', country: 'KR', tags: ['ë¶ˆ', 'ì˜¤ë¦„', 'ì „í†µ'], imageUrl: 'https://cdn.pixabay.com/photo/2016/10/25/12/28/fire-1768913_1280.jpg', desc: 'ìƒˆë³„ì˜¤ë¦„ì„ í†µì§¸ë¡œ íƒœìš°ëŠ” ì¥ê´€.', celeb: 'ë¯¼ì† ê³µì—°ë‹¨' },
            { id: 7, title: 'ê°•ë¦‰ ì»¤í”¼ì¶•ì œ', lat: 37.772, lng: 128.914, region: 'ê°•ì›', country: 'KR', tags: ['ì»¤í”¼', 'ë°”ë‹¤', 'ê°€ì„'], imageUrl: 'https://cdn.pixabay.com/photo/2017/05/12/08/29/coffee-2306471_1280.jpg', desc: 'ì•ˆëª©í•´ë³€ ì¹´í˜ê±°ë¦¬ì™€ í•¨ê»˜í•˜ëŠ” ì»¤í”¼ í–¥.', celeb: 'ìœ ëª… ë°”ë¦¬ìŠ¤íƒ€' },
            { id: 8, title: 'ê°€í‰ ìë¼ì„¬ ì¬ì¦ˆí˜ìŠ¤í‹°ë²Œ', lat: 37.818, lng: 127.525, region: 'ê²½ê¸°', country: 'KR', tags: ['ìŒì•…', 'ì¬ì¦ˆ', 'ê°€ì„'], imageUrl: 'https://cdn.pixabay.com/photo/2016/11/19/14/00/code-1839406_1280.jpg', desc: 'ìì—° ì†ì—ì„œ ì¦ê¸°ëŠ” ì„¸ê³„ì ì¸ ì¬ì¦ˆ í˜ìŠ¤í‹°ë²Œ.', celeb: 'í•´ì™¸ ì¬ì¦ˆ ë®¤ì§€ì…˜' },
            
            // [ì¼ë³¸]
            { id: 101, title: 'ê¸°ì˜¨ ë§ˆì¸ ë¦¬', lat: 35.003, lng: 135.768, region: 'êµí† ', country: 'JP', tags: ['ì „í†µ', 'ì—¬ë¦„', 'í¼ë ˆì´ë“œ'], imageUrl: 'https://cdn.pixabay.com/photo/2017/06/15/09/15/japan-2404987_1280.jpg', desc: 'êµí† ì˜ 3ëŒ€ ë§ˆì¸ ë¦¬ ì¤‘ í•˜ë‚˜. ì•¼ì‚¬ì¹´ ì‹ ì‚¬ì˜ ì œë¡€.', celeb: '-' },
            { id: 102, title: 'ì‚¿í¬ë¡œ ëˆˆì¶•ì œ', lat: 43.061, lng: 141.354, region: 'í™‹ì¹´ì´ë„', country: 'JP', tags: ['ê²¨ìš¸', 'ëˆˆ', 'ì¡°ê°'], imageUrl: 'https://cdn.pixabay.com/photo/2014/12/04/18/14/hokkaido-556810_1280.jpg', desc: 'ì˜¤ë„ë¦¬ ê³µì›ì— ì „ì‹œë˜ëŠ” ê±°ëŒ€í•œ ëˆˆ ì¡°ê°ë“¤.', celeb: '-' },
            { id: 103, title: 'ë„ì¿„ ìŠ¤ë¯¸ë‹¤ê°• ë¶ˆê½ƒì¶•ì œ', lat: 35.710, lng: 139.813, region: 'ë„ì¿„', country: 'JP', tags: ['ë¶ˆê½ƒ', 'ì—¬ë¦„', 'ìœ ì¹´íƒ€'], imageUrl: 'https://cdn.pixabay.com/photo/2016/01/18/22/04/fireworks-1147754_1280.jpg', desc: 'ë„ì¿„ì˜ ì—¬ë¦„ ë°¤ì„ ìˆ˜ë†“ëŠ” ëŒ€ê·œëª¨ ë¶ˆê½ƒë†€ì´.', celeb: '-' },
            { id: 104, title: 'ì˜¤ì‚¬ì¹´ í…ì§„ ë§ˆì¸ ë¦¬', lat: 34.696, lng: 135.519, region: 'ì˜¤ì‚¬ì¹´', country: 'JP', tags: ['ë°°', 'ë¶ˆê½ƒ', 'ì—­ì‚¬'], imageUrl: 'https://cdn.pixabay.com/photo/2017/06/15/09/15/japan-2404987_1280.jpg', desc: 'ì˜¤ì‚¬ì¹´ í…ë§Œêµ¬ ì‹ ì‚¬ì—ì„œ ì—´ë¦¬ëŠ” ìˆ˜ìƒ ì¶•ì œ.', celeb: '-' },
            // í…ŒìŠ¤íŠ¸ìš© í´ëŸ¬ìŠ¤í„° ë°ì´í„° (ì„œìš¸ ë°€ì§‘)
            { id: 201, title: 'ì„œìš¸ ëª¨ì˜ í–‰ì‚¬ 1', lat: 37.530, lng: 126.940, region: 'ì„œìš¸', country: 'KR', tags: ['í…ŒìŠ¤íŠ¸'], imageUrl: '', desc: 'í´ëŸ¬ìŠ¤í„° í…ŒìŠ¤íŠ¸', celeb: '-' },
            { id: 202, title: 'ì„œìš¸ ëª¨ì˜ í–‰ì‚¬ 2', lat: 37.532, lng: 126.942, region: 'ì„œìš¸', country: 'KR', tags: ['í…ŒìŠ¤íŠ¸'], imageUrl: '', desc: 'í´ëŸ¬ìŠ¤í„° í…ŒìŠ¤íŠ¸', celeb: '-' },
            { id: 203, title: 'ì„œìš¸ ëª¨ì˜ í–‰ì‚¬ 3', lat: 37.525, lng: 126.938, region: 'ì„œìš¸', country: 'KR', tags: ['í…ŒìŠ¤íŠ¸'], imageUrl: '', desc: 'í´ëŸ¬ìŠ¤í„° í…ŒìŠ¤íŠ¸', celeb: '-' },
            { id: 204, title: 'ì„œìš¸ ëª¨ì˜ í–‰ì‚¬ 4', lat: 37.520, lng: 126.930, region: 'ì„œìš¸', country: 'KR', tags: ['í…ŒìŠ¤íŠ¸'], imageUrl: '', desc: 'í´ëŸ¬ìŠ¤í„° í…ŒìŠ¤íŠ¸', celeb: '-' },
            { id: 205, title: 'ì„œìš¸ ëª¨ì˜ í–‰ì‚¬ 5', lat: 37.518, lng: 126.925, region: 'ì„œìš¸', country: 'KR', tags: ['í…ŒìŠ¤íŠ¸'], imageUrl: '', desc: 'í´ëŸ¬ìŠ¤í„° í…ŒìŠ¤íŠ¸', celeb: '-' },
        ];

        // --- 3. ì´ˆê¸°í™” ë¡œì§ ---
        window.onload = initializeMap;

        function initializeMap() {
            // 3-1. ë§µ ìƒì„± (ë‹¤í¬ëª¨ë“œ CSS ì ìš©ë¨)
            map = L.map('map', {
                zoomControl: false, // ì¤Œ ì»¨íŠ¸ë¡¤ ì»¤ìŠ¤í…€ ìœ„ì¹˜ë¥¼ ìœ„í•´ ì¼ë‹¨ false
                attributionControl: false
            }).setView([35.9, 127.5], 7);

            // 3-2. íƒ€ì¼ ë ˆì´ì–´ (OpenStreetMap)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
            }).addTo(map);

            // ì¤Œ ì»¨íŠ¸ë¡¤ ìš°í•˜ë‹¨ ë°°ì¹˜
            L.control.zoom({ position: 'bottomright' }).addTo(map);

            // 3-3. UI ì´ˆê¸°í™”
            loadRecentSearches();
            updateRegionTags();
            loadEventMarkers();

            // 3-4. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            setupDragSelection();
            setupSheetClose();
        }

        // --- 4. ë§ˆì»¤ ë¡œë”© & í•„í„°ë§ ì‹œìŠ¤í…œ ---
        function loadEventMarkers() {
            markers.clearLayers();
            allMarkerInstances = [];

            const filteredEvents = mockEvents.filter(e => {
                if(currentCountry === 'MEMO') return false; // ë©”ëª¨ íƒ­ì€ ì¶”í›„ êµ¬í˜„
                return e.country === currentCountry;
            });

            filteredEvents.forEach(data => {
                // ì»¤ìŠ¤í…€ ë§ˆì»¤ ì•„ì´ì½˜ (ì´ë¯¸ì§€)
                const icon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<img src="${data.imageUrl || 'https://via.placeholder.com/64'}" class="custom-marker" data-id="${data.id}">`,
                    iconSize: [64, 64],
                    iconAnchor: [32, 32]
                });

                const marker = L.marker([data.lat, data.lng], { icon: icon });
                marker.feature = { properties: data }; // ë°ì´í„° ë°”ì¸ë”©

                // í´ë¦­ ì‹œ ë°”í…€ ì‹œíŠ¸ ì˜¤í”ˆ
                marker.on('click', () => {
                    showDetailSheet(data);
                    map.panTo([data.lat, data.lng], { animate: true, duration: 1 });
                });

                markers.addLayer(marker);
                allMarkerInstances.push(marker);
            });

            map.addLayer(markers);
        }

        function setCountry(code) {
            currentCountry = code;
            
            // íƒ­ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            ['KR', 'JP', 'MEMO'].forEach(c => {
                const btn = document.getElementById(`tab-${c}`);
                if(c === code) {
                    btn.classList.remove('text-gray-400', 'bg-transparent');
                    btn.classList.add('bg-blue-600', 'text-white');
                } else {
                    btn.classList.add('text-gray-400', 'bg-transparent');
                    btn.classList.remove('bg-blue-600', 'text-white');
                }
            });

            // ë§µ ë·° ì´ë™
            if(code === 'KR') map.flyTo([35.9, 127.5], 7);
            else if(code === 'JP') map.flyTo([36.2048, 138.2529], 6);

            updateRegionTags();
            loadEventMarkers();
        }

        // --- 5. ì§€ì—­ íƒœê·¸ & ë°œê´‘ íš¨ê³¼ ---
        function updateRegionTags() {
            const container = document.getElementById('tagFilterContainer');
            container.innerHTML = '';

            let regions = [];
            if(currentCountry === 'KR') regions = ['ì„œìš¸', 'ê²½ê¸°', 'ê°•ì›', 'ë¶€ì‚°', 'ì œì£¼', 'ì¶©ë‚¨', 'ì „ë¶', 'ê²½ë‚¨'];
            else if(currentCountry === 'JP') regions = ['ë„ì¿„', 'ì˜¤ì‚¬ì¹´', 'êµí† ', 'í™‹ì¹´ì´ë„', 'í›„ì¿ ì˜¤ì¹´'];

            regions.forEach(r => {
                const btn = document.createElement('button');
                btn.className = "px-3 py-1 bg-gray-800 text-xs border border-gray-600 rounded-full hover:bg-yellow-500 hover:text-black transition-colors";
                btn.innerText = `#${r}`;
                btn.onclick = () => filterByRegion(r);
                container.appendChild(btn);
            });
        }

        function filterByRegion(regionName) {
            // 1. ë°œê´‘ íš¨ê³¼ (Glow)
            showRegionGlow(regionName);

            // 2. ê²€ìƒ‰ì°½ì— ìë™ ì…ë ¥
            const searchInput = document.getElementById('searchInput');
            searchInput.value = regionName;
            
            // 3. ì‹¤ì œ í•„í„°ë§ ë¡œì§ì€ ì—¬ê¸°ì„œ í™•ì¥ ê°€ëŠ¥ (í˜„ì¬ëŠ” ì‹œê°ì  íš¨ê³¼ ì¤‘ì‹¬)
        }

        function showRegionGlow(regionName) {
            if (currentGlowLayer) map.removeLayer(currentGlowLayer);

            const boundsData = regionBoundaryParams[regionName];
            if (boundsData) {
                // íŒŒë¼ë¯¸í„° ê¸°ë°˜ Rectangle ìƒì„± + CSS Animation í´ë˜ìŠ¤
                const bounds = L.latLngBounds(boundsData[0], boundsData[1]);
                
                currentGlowLayer = L.rectangle(bounds, {
                    className: 'region-glow-path', // CSS í´ë˜ìŠ¤ë¡œ glow ì²˜ë¦¬
                    fill: false,
                    weight: 3
                }).addTo(map);

                map.fitBounds(bounds, { padding: [50, 50], animate: true });
            }
        }

        // --- 6. ë“œë˜ê·¸ ì…€ë ‰ì…˜ (Alt + Drag) ---
        function setupDragSelection() {
            const box = document.getElementById('selectionBox');
            let startPoint = null;
            let isDragging = false;

            // Alt í‚¤ ëˆŒë €ì„ ë•Œ ë§µ ë“œë˜ê·¸ ë¹„í™œì„±í™”
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Alt') {
                    map.dragging.disable();
                    map.getContainer().style.cursor = 'crosshair';
                }
                if (e.key === 'Escape') {
                    deselectAll();
                }
            });

            document.addEventListener('keyup', (e) => {
                if (e.key === 'Alt') {
                    map.dragging.enable();
                    map.getContainer().style.cursor = '';
                }
            });

            // ë§µ ì»¨í…Œì´ë„ˆ ìœ„ì—ì„œ ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
            const mapContainer = map.getContainer();

            mapContainer.addEventListener('mousedown', (e) => {
                if (!e.altKey) return;
                isDragging = true;
                startPoint = map.mouseEventToContainerPoint(e);
                
                box.style.display = 'block';
                box.style.left = startPoint.x + 'px';
                box.style.top = startPoint.y + 'px';
                box.style.width = '0px';
                box.style.height = '0px';
            });

            mapContainer.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const currentPoint = map.mouseEventToContainerPoint(e);
                
                const minX = Math.min(startPoint.x, currentPoint.x);
                const maxX = Math.max(startPoint.x, currentPoint.x);
                const minY = Math.min(startPoint.y, currentPoint.y);
                const maxY = Math.max(startPoint.y, currentPoint.y);

                box.style.left = minX + 'px';
                box.style.top = minY + 'px';
                box.style.width = (maxX - minX) + 'px';
                box.style.height = (maxY - minY) + 'px';
            });

            mapContainer.addEventListener('mouseup', (e) => {
                if (!isDragging) return;
                isDragging = false;
                box.style.display = 'none';

                // ì„ íƒ ì˜ì—­ì˜ LatLngBounds ê³„ì‚°
                const bounds = map.containerPointToLatLng(L.point(
                    parseInt(box.style.left), parseInt(box.style.top)
                )).toBounds(map.containerPointToLatLng(L.point(
                    parseInt(box.style.left) + parseInt(box.style.width),
                    parseInt(box.style.top) + parseInt(box.style.height)
                )));

                selectMarkersInBounds(bounds);
            });
        }

        function selectMarkersInBounds(bounds) {
            // ê¸°ì¡´ ì„ íƒ ìœ ì§€í•˜ë ¤ë©´ Set í™œìš©, ì—¬ê¸°ì„  ìƒˆë¡œ ì„ íƒ
            // deselectAll(); 

            allMarkerInstances.forEach(marker => {
                if (bounds.contains(marker.getLatLng())) {
                    const id = marker.feature.properties.id;
                    selectedMarkers.add(id);
                    
                    // DOM ìš”ì†Œì— ìŠ¤íƒ€ì¼ ì ìš©
                    const iconImg = marker.getElement().querySelector('.custom-marker');
                    if(iconImg) iconImg.classList.add('marker-selected');
                }
            });
            console.log("Selected IDs:", Array.from(selectedMarkers));
        }

        function deselectAll() {
            selectedMarkers.clear();
            document.querySelectorAll('.marker-selected').forEach(el => el.classList.remove('marker-selected'));
            if(currentGlowLayer) map.removeLayer(currentGlowLayer); // ê²½ê³„ì„ ë„ ê°™ì´ ë”
        }

        // --- 7. ìƒì„¸ ì‹œíŠ¸ ë° ê²€ìƒ‰ ---
        function showDetailSheet(data) {
            const sheet = document.getElementById('detailSheet');
            document.getElementById('sheetTitle').innerText = data.title;
            document.getElementById('sheetDesc').innerText = data.desc;
            document.getElementById('sheetRegion').innerText = data.region;
            document.getElementById('sheetCeleb').innerText = data.celeb;
            document.getElementById('sheetImage').src = data.imageUrl;

            // íƒœê·¸ ìƒì„±
            const tagBox = document.getElementById('sheetTags');
            tagBox.innerHTML = '';
            data.tags.forEach(t => {
                const s = document.createElement('span');
                s.className = "text-xs bg-gray-700 px-2 py-1 rounded text-gray-300";
                s.innerText = `#${t}`;
                tagBox.appendChild(s);
            });

            sheet.classList.remove('translate-y-[110%]');
            sheet.classList.add('translate-y-0');
        }

        function setupSheetClose() {
            document.getElementById('closeSheetBtn').onclick = () => {
                document.getElementById('detailSheet').classList.add('translate-y-[110%]');
                document.getElementById('detailSheet').classList.remove('translate-y-0');
            };
        }

        // ê²€ìƒ‰ ë° LocalStorage
        function handleSearch(e) {
            if (e.key === 'Enter') executeSearch();
        }

        function executeSearch() {
            const input = document.getElementById('searchInput');
            const val = input.value.trim();
            if (!val) return;

            // 1. ìµœê·¼ ê²€ìƒ‰ì–´ ì €ì¥
            let recents = JSON.parse(localStorage.getItem('recentSearches') || '[]');
            recents = [val, ...recents.filter(v => v !== val)].slice(0, 5); // 5ê°œ ìœ ì§€
            localStorage.setItem('recentSearches', JSON.stringify(recents));
            loadRecentSearches();

            // 2. ê²€ìƒ‰ ë¡œì§ (Mock) - í•´ë‹¹ë˜ëŠ” ì²« ë²ˆì§¸ ë§ˆì»¤ë¡œ ì´ë™
            const target = mockEvents.find(e => e.title.includes(val) || e.region.includes(val));
            if (target) {
                if (target.country !== currentCountry) setCountry(target.country); // êµ­ê°€ ìë™ ì „í™˜
                map.flyTo([target.lat, target.lng], 10);
                setTimeout(() => showDetailSheet(target), 1000);
            } else {
                alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. (Mock ë°ì´í„° í•œì •)');
            }
        }

        function loadRecentSearches() {
            const container = document.getElementById('recentSearches');
            const recents = JSON.parse(localStorage.getItem('recentSearches') || '[]');
            container.innerHTML = '';
            recents.forEach(txt => {
                const sp = document.createElement('span');
                sp.className = "bg-gray-700 px-2 py-1 rounded cursor-pointer hover:bg-gray-600 whitespace-nowrap";
                sp.innerText = txt;
                sp.onclick = () => {
                    document.getElementById('searchInput').value = txt;
                    executeSearch();
                };
                container.appendChild(sp);
            });
        }
        
        function addUserLabel() {
            const val = document.getElementById('newLabelInput').value;
            if(val) {
                alert(`"${val}" ë¼ë²¨ì´ í˜„ì¬ ì„ íƒëœ ë§ˆì»¤ë“¤ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. (DB ì—°ë™ í•„ìš”)`);
                document.getElementById('newLabelInput').value = '';
            }
        }
    </script>
</body>
</html>

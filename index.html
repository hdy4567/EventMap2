<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EventMap2 - Global Festival Map</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background-color: #000; }
        
        /* #upgrade ë‹¤í¬ ëª¨ë“œ: íƒ€ì¼ë§Œ ë°˜ì „, UIëŠ” ë³´ì¡´ */
        #map { 
            width: 100%; 
            height: 100%; 
            background: #000000; 
            z-index: 1;
        }
        
        .leaflet-tile-pane {
            filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }
        
        /* #upgrade UI ë°˜ì „ ë°©ì§€ ê°•í™” */
        .leaflet-control-container, 
        .leaflet-popup-content-wrapper, 
        .leaflet-popup-tip {
            filter: none !important;
        }

        /* #upgrade ë“œë˜ê·¸ ì„ íƒ ë°•ìŠ¤ */
        .selection-box {
            position: absolute;
            border: 2px solid #2196F3;
            background-color: rgba(33, 150, 243, 0.2);
            z-index: 1000;
            pointer-events: none;
            display: none;
        }

        /* #upgrade ì§€ì—­ ë°œê´‘ íš¨ê³¼ */
        @keyframes pulse-glow {
            0% { stroke-opacity: 0.4; stroke-width: 2; fill-opacity: 0.1; }
            50% { stroke-opacity: 1.0; stroke-width: 5; fill-opacity: 0.3; }
            100% { stroke-opacity: 0.4; stroke-width: 2; fill-opacity: 0.1; }
        }
        
        .region-glow-path {
            stroke: #ffeb3b;
            fill: #ffeb3b;
            animation: pulse-glow 2s infinite;
            filter: drop-shadow(0 0 10px #ffeb3b);
        }

        /* í•˜ë‹¨ ì‹œíŠ¸ ì• ë‹ˆë©”ì´ì…˜ */
        #detailSheet {
            transition: transform 0.3s ease-in-out;
            transform: translateY(100%);
        }
        #detailSheet.active {
            transform: translateY(0);
        }

        /* #upgrade í´ëŸ¬ìŠ¤í„° ìƒ‰ìƒ (10ê°œ ì´ìƒ ë¹¨ê°•) */
        .marker-cluster-small { background-color: rgba(110, 204, 57, 0.6); }
        .marker-cluster-small div { background-color: rgba(110, 204, 57, 0.6); }

        .marker-cluster-medium { background-color: rgba(240, 194, 12, 0.6); }
        .marker-cluster-medium div { background-color: rgba(240, 194, 12, 0.6); }

        .cluster-high-density {
            background-color: rgba(255, 59, 48, 0.6) !important;
        }
        .cluster-high-density div {
            background-color: rgba(255, 59, 48, 0.6) !important;
            color: white;
            font-weight: bold;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* #upgrade ì„ íƒëœ ë§ˆì»¤ í•˜ì´ë¼ì´íŠ¸ */
        .marker-selected {
            filter: drop-shadow(0 0 8px #2196F3) brightness(1.2) !important;
            border: 3px solid #2196F3 !important;
            border-radius: 50%;
        }
    </style>
</head>
<body class="font-sans text-gray-100">

    <!-- #upgrade UI 3ë‹¨ êµ¬ì¡° -->
    <div class="absolute top-4 left-1/2 transform -translate-x-1/2 w-[90%] max-w-md z-50 flex flex-col gap-2 pointer-events-none">
        
        <!-- 1ë‹¨: ë„¤ì´ë²„ ê²€ìƒ‰ì°½ -->
        <div class="pointer-events-auto bg-gray-900/90 backdrop-blur-md rounded-xl shadow-2xl border border-gray-700 p-2">
            <form action="https://search.naver.com/search.naver" method="GET" target="_blank" class="flex gap-2" onsubmit="saveRecentSearch(this.query.value)">
                <input type="text" name="query" placeholder="ë„¤ì´ë²„ ê²€ìƒ‰..." 
                       class="w-full bg-gray-800 text-white px-4 py-2 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-green-500 transition-all">
                <button type="submit" class="bg-green-600 hover:bg-green-500 text-white px-3 py-2 rounded-lg text-sm font-bold">
                    ê²€ìƒ‰
                </button>
            </form>
        </div>

        <!-- 2ë‹¨: êµ­ê°€ íƒ­ (KR/JP/Memo) -->
        <div class="pointer-events-auto flex justify-center gap-2">
            <button onclick="setCountry('Korea')" id="btn-kr" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-1.5 rounded-full text-xs font-bold shadow-lg transition-all ring-2 ring-white/20">ğŸ‡°ğŸ‡· í•œêµ­</button>
            <button onclick="setCountry('Japan')" id="btn-jp" class="bg-gray-700 hover:bg-red-500 text-white px-4 py-1.5 rounded-full text-xs font-bold shadow-lg transition-all">ğŸ‡¯ğŸ‡µ ì¼ë³¸</button>
            <button onclick="toggleMemoMode()" class="bg-gray-700 hover:bg-yellow-500 text-white px-4 py-1.5 rounded-full text-xs font-bold shadow-lg transition-all">ğŸ“ ë©”ëª¨</button>
        </div>

        <!-- 3ë‹¨: ì§€ì—­ íƒœê·¸ + í…Œë§ˆ í•„í„° -->
        <div class="pointer-events-auto overflow-x-auto no-scrollbar whitespace-nowrap py-2 px-1">
            <div id="tagContainer" class="flex gap-2 justify-start min-w-max px-4"></div>
        </div>
        
        <!-- #upgrade ìµœê·¼ ê²€ìƒ‰ì–´ í‘œì‹œ -->
        <div id="recentSearch" class="pointer-events-auto hidden bg-gray-900/90 backdrop-blur rounded-lg p-2 mt-1 text-xs text-gray-300">
            <span class="font-bold text-gray-500 block mb-1">ìµœê·¼ ê²€ìƒ‰</span>
            <div id="recentList" class="flex gap-2 flex-wrap"></div>
        </div>
    </div>

    <div id="map"></div>
    <div id="selectionBox" class="selection-box"></div>

    <!-- #upgrade í•˜ë‹¨ ì‹œíŠ¸ 30% í¬ê¸° ê°ì†Œ (35vh â†’ 24.5vh) -->
    <div id="detailSheet" class="fixed bottom-0 left-0 w-full bg-gray-900 rounded-t-2xl shadow-[0_-5px_20px_rgba(0,0,0,0.5)] z-50 p-5 h-[24.5vh] flex flex-col gap-4 border-t border-gray-700 text-white">
        <button id="closeButton" class="absolute top-3 right-4 text-gray-400 hover:text-white text-xl">âœ•</button>
        
        <div class="flex gap-4 h-full">
            <!-- #upgrade ì´ë¯¸ì§€ ë¹„ìœ¨ 1/3 â†’ 1/4ë¡œ ê°ì†Œ -->
            <img id="sheetImage" src="" alt="Event" class="w-1/4 h-full rounded-xl object-cover border border-gray-600 bg-gray-800">
            
            <div class="flex-1 overflow-y-auto pr-2">
                <div class="flex justify-between items-start mb-2">
                    <h2 id="sheetTitle" class="text-lg font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400">ì´ë²¤íŠ¸ ì œëª©</h2>
                    <span id="sheetRegion" class="text-xs bg-gray-700 px-2 py-1 rounded text-gray-300">ì§€ì—­</span>
                </div>
                <p id="sheetSummary" class="text-sm text-gray-300 mb-3 leading-relaxed">ì´ë²¤íŠ¸ ìš”ì•½</p>
                
                <div class="text-xs space-y-1 text-gray-400">
                    <p>ğŸ¤ <span class="text-gray-200" id="sheetCeleb">ì´ˆì²­ ê²ŒìŠ¤íŠ¸</span></p>
                    <p>ğŸ“… <span class="text-gray-200" id="sheetDate">ë‚ ì§œ ì •ë³´</span></p>
                    <div id="sheetTags" class="flex gap-1 mt-2 flex-wrap"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script>
        let map, markersCluster;
        let currentCountry = 'Korea';
        let currentGlowLayer = null;
        let isSelecting = false;
        let selectionStart = null;
        let selectedMarkers = new Set();
        let markerBrightnessValue = 1.0;
        
        const selectionBox = document.getElementById('selectionBox');
        
        // #upgrade ì§€ì—­ ê²½ê³„ íŒŒë¼ë¯¸í„° í™•ì¥
        const regionBoundaryParams = {
            'ì„œìš¸': [[37.413294, 126.734086], [37.715133, 127.269311]],
            'ê²½ê¸°': [[36.893960, 126.376282], [38.284422, 127.854233]],
            'ê°•ì›': [[37.024128, 127.267563], [38.612895, 129.403067]],
            'ì¶©ë‚¨': [[35.968674, 126.003849], [36.897770, 127.477394]],
            'ì¶©ë¶': [[36.196688, 127.286377], [37.206036, 128.489090]],
            'ì „ë¶': [[35.227345, 126.244156], [36.176777, 127.635040]],
            'ì „ë‚¨': [[33.993872, 125.686073], [35.441993, 127.673340]],
            'ê²½ë¶': [[35.427315, 128.013367], [37.425194, 129.612488]],
            'ê²½ë‚¨': [[34.515808, 127.569763], [35.730469, 129.153900]],
            'ë¶€ì‚°': [[34.879908, 128.738436], [35.395936, 129.372819]],
            'ì œì£¼': [[33.112293, 126.162788], [34.004925, 126.980667]],
            'ë„ì¿„': [[35.501167, 138.942468], [35.898643, 139.919011]],
            'ì˜¤ì‚¬ì¹´': [[34.283177, 135.074447], [34.977464, 135.734685]],
            'êµí† ': [[34.808868, 135.353409], [35.367992, 135.947113]],
            'í›„ì¿ ì˜¤ì¹´': [[33.406362, 130.064697], [33.718277, 130.659790]],
            'í™‹ì¹´ì´ë„': [[41.210909, 139.333332], [45.557201, 148.887208]],
            'ì˜¤í‚¤ë‚˜ì™€': [[24.045416, 122.747192], [28.481293, 131.341553]],
            'ë‚˜ê³ ì•¼': [[34.839081, 136.543579], [35.332012, 137.139587]]
        };

        // #upgrade ì‹¤ì œ API ì—°ë™ ì¤€ë¹„ëœ ê°€ìƒ ë°ì´í„° (37ê°œ)
        const mockEvents = [
            // --- í•œêµ­ (24ê°œ) ---
            { id: 1, title: 'ì„œìš¸ ë¶ˆê½ƒì¶•ì œ', region: 'ì„œìš¸', lat: 37.527, lng: 126.933, country: 'Korea', type: 'ë¬¸í™”', celeb: 'ë¶ˆê½ƒë””ìì´ë„ˆ 10ì¸', img: 'https://images.unsplash.com/photo-1514525253440-b393452e2729', desc: 'ì—¬ì˜ë„ í•œê°•ê³µì›ì—ì„œ í¼ì³ì§€ëŠ” ì„¸ê³„ì ì¸ ë¶ˆê½ƒì¶•ì œ.' },
            { id: 2, title: 'ë¶€ì‚° êµ­ì œì˜í™”ì œ', region: 'ë¶€ì‚°', lat: 35.171, lng: 129.127, country: 'Korea', type: 'ë¬¸í™”', celeb: 'ìœ ëª… ë°°ìš° ë‹¤ìˆ˜', img: 'https://images.unsplash.com/photo-1489599849927-2ee91cede3ba', desc: 'ì•„ì‹œì•„ ìµœëŒ€ì˜ ì˜í™” ì¶•ì œ.' },
            { id: 3, title: 'ë³´ë ¹ ë¨¸ë“œì¶•ì œ', region: 'ì¶©ë‚¨', lat: 36.312, lng: 126.514, country: 'Korea', type: 'ìŒì•…', celeb: 'K-POP ì•„ì´ëŒ', img: 'https://images.unsplash.com/photo-1533174072545-e8d4aa97edf9', desc: 'ì„¸ê³„ì¸ì´ ì¦ê¸°ëŠ” ëŒ€í•œë¯¼êµ­ ëŒ€í‘œ ì—¬ë¦„ ì¶•ì œ.' },
            { id: 4, title: 'ì „ì£¼ ë¹„ë¹”ë°¥ì¶•ì œ', region: 'ì „ë¶', lat: 35.815, lng: 127.153, country: 'Korea', type: 'ìŒì‹', celeb: 'ìœ ëª… ì…°í”„', img: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd', desc: 'ë§›ê³¼ ë©‹ì´ ìˆëŠ” ì „ì£¼ ëŒ€í‘œ ë¯¸ì‹ ì¶•ì œ.' },
            { id: 5, title: 'ì§„í•´ êµ°í•­ì œ', region: 'ê²½ë‚¨', lat: 35.148, lng: 128.663, country: 'Korea', type: 'ë¬¸í™”', celeb: 'êµ°ì•…ëŒ€', img: 'https://images.unsplash.com/photo-1490750967868-58cb75069ed6', desc: 'ì „êµ­ ìµœëŒ€ ê·œëª¨ì˜ ë²šê½ƒ ì¶•ì œ.' },
            { id: 6, title: 'ê´‘ì£¼ ë¹„ì—”ë‚ ë ˆ', region: 'ì „ë‚¨', lat: 35.160, lng: 126.851, country: 'Korea', type: 'ë¬¸í™”', celeb: 'êµ­ì œ ì‘ê°€', img: 'https://images.unsplash.com/photo-1499781350541-7783f6c6a0c8', desc: 'ì•„ì‹œì•„ ìµœì´ˆ êµ­ì œ í˜„ëŒ€ë¯¸ìˆ  ì „ì‹œíšŒ.' },
            { id: 7, title: 'ì¶˜ì²œ êµ­ì œë§ˆì„ì¶•ì œ', region: 'ê°•ì›', lat: 37.881, lng: 127.730, country: 'Korea', type: 'ë¬¸í™”', celeb: 'ì„¸ê³„ ë§ˆì„ ê³µì—°íŒ€', img: 'https://images.unsplash.com/photo-1507676184212-d03ab07a01bf', desc: 'ë§ ì—†ì´ ì†Œí†µí•˜ëŠ” ê³µì—° ì˜ˆìˆ ì˜ í–¥ì—°.' },
            { id: 8, title: 'ì•ˆë™ êµ­ì œíƒˆì¶¤í˜ìŠ¤í‹°ë²Œ', region: 'ê²½ë¶', lat: 36.568, lng: 128.729, country: 'Korea', type: 'ë¬¸í™”', celeb: 'ì „í†µ íƒˆì¶¤ ê³µì—°ë‹¨', img: 'https://images.unsplash.com/photo-1533174072545-7a4b6ad7a6c3', desc: 'í•œêµ­ ì „í†µ ê°€ë©´ê·¹ì„ ì„¸ê³„ì— ì•Œë¦¬ëŠ” ì¶•ì œ.' },
            { id: 9, title: 'ëŒ€ì „ ì‚¬ì´ì–¸ìŠ¤ í˜ìŠ¤í‹°ë²Œ', region: 'ì¶©ë¶', lat: 36.351, lng: 127.385, country: 'Korea', type: 'ë¬¸í™”', celeb: 'ê³¼í•™ì ê°•ì—°', img: 'https://images.unsplash.com/photo-1451187580459-43490279c0fa', desc: 'ê³¼í•™ê³¼ ê¸°ìˆ ì˜ ë§Œë‚¨.' },
            { id: 10, title: 'ì œì£¼ ë“¤ë¶ˆì¶•ì œ', region: 'ì œì£¼', lat: 33.365, lng: 126.533, country: 'Korea', type: 'ë¬¸í™”', celeb: 'ì „í†µ ê³µì—°ë‹¨', img: 'https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05', desc: 'ì œì£¼ì˜ ë´„ì„ ì—¬ëŠ” ë¶ˆì˜ í–¥ì—°.' },
            
            // ì¶”ê°€ í•œêµ­ ë°ì´í„° (14ê°œ ë”)
            { id: 11, title: 'ìˆ˜ì› í™”ì„±ë¬¸í™”ì œ', region: 'ê²½ê¸°', lat: 37.286, lng: 127.007, country: 'Korea', type: 'ë¬¸í™”', celeb: 'ì „í†µ êµ­ì•…ë‹¨', img: 'https://images.unsplash.com/photo-1558618666-fcd25c85cd64', desc: 'ìœ ë„¤ìŠ¤ì½” ì„¸ê³„ë¬¸í™”ìœ ì‚° ìˆ˜ì›í™”ì„±ì˜ ì—­ì‚¬ë¥¼ ì¬í˜„.' },
            { id: 12, title: 'ì¸ì²œ íœíƒ€í¬íŠ¸ ë¡ í˜ìŠ¤í‹°ë²Œ', region: 'ê²½ê¸°', lat: 37.456, lng: 126.705, country: 'Korea', type: 'ìŒì•…', celeb: 'êµ­ë‚´ì™¸ ë¡ ë°´ë“œ', img: 'https://images.unsplash.com/photo-1506157786151-b8491531f063', desc: 'í•œêµ­ ìµœëŒ€ ë¡ ìŒì•… ì¶•ì œ.' },
            { id: 13, title: 'ê°•ë¦‰ ì»¤í”¼ í˜ìŠ¤í‹°ë²Œ', region: 'ê°•ì›', lat: 37.752, lng: 128.876, country: 'Korea', type: 'ìŒì‹', celeb: 'ë°”ë¦¬ìŠ¤íƒ€ ì±”í”¼ì–¸', img: 'https://images.unsplash.com/photo-1509042239860-f550ce710b93', desc: 'ì»¤í”¼ì˜ ë„ì‹œ ê°•ë¦‰ì—ì„œ ì—´ë¦¬ëŠ” ì»¤í”¼ ì¶•ì œ.' },
            { id: 14, title: 'í‰ì°½ ì†¡ì–´ ì¶•ì œ', region: 'ê°•ì›', lat: 37.370, lng: 128.390, country: 'Korea', type: 'ë¬¸í™”', celeb: 'ê²¨ìš¸ ë ˆì € ì „ë¬¸ê°€', img: 'https://images.unsplash.com/photo-1519904981063-b0cf448d479e', desc: 'ì–¼ìŒ ìœ„ì—ì„œ ì¦ê¸°ëŠ” ê²¨ìš¸ ì¶•ì œ.' },
            { id: 15, title: 'ì²­ì£¼ êµ­ì œê³µì˜ˆë¹„ì—”ë‚ ë ˆ', region: 'ì¶©ë¶', lat: 36.642, lng: 127.489, country: 'Korea', type: 'ë¬¸í™”', celeb: 'ê³µì˜ˆ ì‘ê°€', img: 'https://images.unsplash.com/photo-1452860606245-08befc0ff44b', desc: 'ì„¸ê³„ ê³µì˜ˆì˜ íë¦„ì„ í•œëˆˆì—.' },
            { id: 16, title: 'í¬í•­ êµ­ì œë¶ˆë¹›ì¶•ì œ', region: 'ê²½ë¶', lat: 36.019, lng: 129.343, country: 'Korea', type: 'ë¬¸í™”', celeb: 'ë¶ˆë¹› ì˜ˆìˆ ê°€', img: 'https://images.unsplash.com/photo-1496568816309-51d7c20e3b21', desc: 'ë¹›ìœ¼ë¡œ ìˆ˜ë†“ëŠ” í¬í•­ì˜ ë°¤.' },
            { id: 17, title: 'í†µì˜ êµ­ì œìŒì•…ì œ', region: 'ê²½ë‚¨', lat: 34.854, lng: 128.433, country: 'Korea', type: 'ìŒì•…', celeb: 'ì„¸ê³„ ìŒì•…ê°€', img: 'https://images.unsplash.com/photo-1465847899084-d164df4dedc6', desc: 'ìŒì•…ì˜ ë„ì‹œ í†µì˜ì—ì„œ ì—´ë¦¬ëŠ” í´ë˜ì‹ í–¥ì—°.' },
            { id: 18, title: 'ê³ ì„± ê³µë£¡ ì„¸ê³„ ì—‘ìŠ¤í¬', region: 'ê²½ë‚¨', lat: 34.973, lng: 128.322, country: 'Korea', type: 'ë¬¸í™”', celeb: 'ê³ ìƒë¬¼í•™ì', img: 'https://images.unsplash.com/photo-1577896851231-70ef18881754', desc: 'ê³µë£¡ ë°œìêµ­ í™”ì„ì˜ ê³ ì¥ì—ì„œ í¼ì³ì§€ëŠ” ê³µë£¡ ì¶•ì œ.' },
            { id: 19, title: 'êµ°ì‚° ì‹œê°„ì—¬í–‰ì¶•ì œ', region: 'ì „ë¶', lat: 35.968, lng: 126.736, country: 'Korea', type: 'ë¬¸í™”', celeb: 'ì—­ì‚¬ ì¬í˜„ ë°°ìš°', img: 'https://images.unsplash.com/photo-1464746133101-a2c3f88e0dd9', desc: 'ê·¼ëŒ€ ì—­ì‚¬ì˜ í”ì ì„ ë”°ë¼ ë– ë‚˜ëŠ” ì—¬í–‰.' },
            { id: 20, title: 'ì—¬ìˆ˜ ë°¤ë°”ë‹¤ ì¶•ì œ', region: 'ì „ë‚¨', lat: 34.760, lng: 127.662, country: 'Korea', type: 'ë¬¸í™”', celeb: 'K-POP ê°€ìˆ˜', img: 'https://images.unsplash.com/photo-1543722530-d2c3201371e7', desc: 'ì—¬ìˆ˜ ë°¤ë°”ë‹¤ë¥¼ ìˆ˜ë†“ëŠ” ë¶ˆë¹›ê³¼ ìŒì•….' },
            { id: 21, title: 'ë‹´ì–‘ ì£½ë…¹ì› ëŒ€ë‚˜ë¬´ ì¶•ì œ', region: 'ì „ë‚¨', lat: 35.320, lng: 126.988, country: 'Korea', type: 'ë¬¸í™”', celeb: 'ëŒ€ê¸ˆ ì—°ì£¼ì', img: 'https://images.unsplash.com/photo-1520250497591-112f2f40a3f4', desc: 'í‘¸ë¥¸ ëŒ€ìˆ²ì—ì„œ ì¦ê¸°ëŠ” íë§ ì¶•ì œ.' },
            { id: 22, title: 'ì„œìš¸ ì¬ì¦ˆ í˜ìŠ¤í‹°ë²Œ', region: 'ì„œìš¸', lat: 37.520, lng: 127.047, country: 'Korea', type: 'ìŒì•…', celeb: 'ì„¸ê³„ ì¬ì¦ˆ ë®¤ì§€ì…˜', img: 'https://images.unsplash.com/photo-1511735111819-9a3f7709049c', desc: 'ì˜¬ë¦¼í”½ê³µì›ì—ì„œ ì—´ë¦¬ëŠ” ì¬ì¦ˆì˜ í–¥ì—°.' },
            { id: 23, title: 'ê²½ì£¼ ë²šê½ƒ ë§ˆë¼í†¤', region: 'ê²½ë¶', lat: 35.856, lng: 129.225, country: 'Korea', type: 'ë¬¸í™”', celeb: 'ë§ˆë¼í†¤ ì„ ìˆ˜', img: 'https://images.unsplash.com/photo-1502224562085-639556652f33', desc: 'ë²šê½ƒì´ í©ë‚ ë¦¬ëŠ” ì‹ ë¼ ì—­ì‚¬ì˜ ê¸¸ì„ ë‹¬ë¦°ë‹¤.' },
            { id: 24, title: 'í•´ìš´ëŒ€ ëª¨ë˜ ì¶•ì œ', region: 'ë¶€ì‚°', lat: 35.158, lng: 129.160, country: 'Korea', type: 'ë¬¸í™”', celeb: 'ëª¨ë˜ ì¡°ê°ê°€', img: 'https://images.unsplash.com/photo-1516815231560-8f41ec531527', desc: 'ëª¨ë˜ë¡œ ë§Œë“œëŠ” ì˜ˆìˆ  ì‘í’ˆì˜ í–¥ì—°.' },
            
            // --- ì¼ë³¸ (13ê°œ) ---
            { id: 101, title: 'ê¸°ì˜¨ ë§ˆì¸ ë¦¬', region: 'êµí† ', lat: 35.003, lng: 135.768, country: 'Japan', type: 'ë¬¸í™”', celeb: 'ì „í†µ ê³„ìŠ¹ì', img: 'https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e', desc: 'êµí† ì˜ ì—¬ë¦„ì„ ì•Œë¦¬ëŠ” ì¼ë³¸ 3ëŒ€ ë§ˆì¸ ë¦¬.' },
            { id: 102, title: 'ìŠ¤ë¯¸ë‹¤ê°€ì™€ ë¶ˆê½ƒë†€ì´', region: 'ë„ì¿„', lat: 35.710, lng: 139.800, country: 'Japan', type: 'ë¬¸í™”', celeb: 'ë¶ˆê½ƒ ì¥ì¸', img: 'https://images.unsplash.com/photo-1506869640319-fe1a24fd76dc', desc: 'ë„ì¿„ì—ì„œ ê°€ì¥ ì˜¤ë˜ë˜ê³  ìœ ëª…í•œ ë¶ˆê½ƒë†€ì´ ëŒ€íšŒ.' },
            { id: 103, title: 'ì‚¿í¬ë¡œ ëˆˆì¶•ì œ', region: 'í™‹ì¹´ì´ë„', lat: 43.061, lng: 141.354, country: 'Japan', type: 'ë¬¸í™”', celeb: 'ì¡°ê°ê°€', img: 'https://images.unsplash.com/photo-1483921020237-2ff51e8e4b22', desc: 'ì„¸ê³„ 3ëŒ€ ì¶•ì œ ì¤‘ í•˜ë‚˜, ê±°ëŒ€í•œ ëˆˆ ì¡°ê° ì „ì‹œ.' },
            { id: 104, title: 'í…ì§„ ë§ˆì¸ ë¦¬', region: 'ì˜¤ì‚¬ì¹´', lat: 34.696, lng: 135.519, country: 'Japan', type: 'ë¬¸í™”', celeb: 'ì˜¤ì‚¬ì¹´ ì‹œë¯¼', img: 'https://images.unsplash.com/photo-1542051841857-5f90071e7989', desc: 'ì²œë…„ ì´ìƒì˜ ì—­ì‚¬ë¥¼ ê°€ì§„ ì˜¤ì‚¬ì¹´ì˜ ëŒ€í‘œ ì¶•ì œ.' },
            { id: 105, title: 'ì•„ì˜¤ëª¨ë¦¬ ë„¤ë¶€íƒ€ ë§ˆì¸ ë¦¬', region: 'í™‹ì¹´ì´ë„', lat: 40.824, lng: 140.740, country: 'Japan', type: 'ë¬¸í™”', celeb: 'ë„¤ë¶€íƒ€ ì œì‘ì', img: 'https://images.unsplash.com/photo-1480796927426-f609979314bd', desc: 'ê±°ëŒ€í•œ ë“±ë¶ˆ ì¸í˜•ì´ í–‰ì§„í•˜ëŠ” ì—¬ë¦„ ì¶•ì œ.' },
            { id: 106, title: 'ë‚˜ê³ ì•¼ ì•„ì¸ íƒ€ ë§ˆì¸ ë¦¬', region: 'ë‚˜ê³ ì•¼', lat: 35.127, lng: 136.907, country: 'Japan', type: 'ë¬¸í™”', celeb: 'ì‹ ì‚¬ ì‹ ê´€', img: 'https://images.unsplash.com/photo-1528164344705-47542687000d', desc: 'ì•„ì¸ íƒ€ ì‹ ê¶ì—ì„œ ì—´ë¦¬ëŠ” ì „í†µ ì¶•ì œ.' },
            { id: 107, title: 'í›„ì¿ ì˜¤ì¹´ í•˜ì¹´íƒ€ ê¸°ì˜¨ ì•¼ë§ˆì¹´ì‚¬', region: 'í›„ì¿ ì˜¤ì¹´', lat: 33.590, lng: 130.402, country: 'Japan', type: 'ë¬¸í™”', celeb: 'ì•¼ë§ˆì¹´ì‚¬ ìš´ë°˜ì', img: 'https://images.unsplash.com/photo-1554797589-7241bb691973', desc: 'ê±°ëŒ€í•œ ìˆ˜ë ˆë¥¼ ëŒê³  ë‹¬ë¦¬ëŠ” ì—­ë™ì ì¸ ì¶•ì œ.' },
            { id: 108, title: 'ì˜¤í‚¤ë‚˜ì™€ ì—ì´ì‚¬ ë§ˆì¸ ë¦¬', region: 'ì˜¤í‚¤ë‚˜ì™€', lat: 26.212, lng: 127.679, country: 'Japan', type: 'ìŒì•…', celeb: 'ì—ì´ì‚¬ ëŒ„ì„œ', img: 'https://images.unsplash.com/photo-1519904981063-b0cf448d479e', desc: 'ì˜¤í‚¤ë‚˜ì™€ ì „í†µ ì¶¤ê³¼ ë¶ ê³µì—°.' },
            { id: 109, title: 'ë„ì¿„ ë²šê½ƒ ì¶•ì œ', region: 'ë„ì¿„', lat: 35.685, lng: 139.752, country: 'Japan', type: 'ë¬¸í™”', celeb: 'í•˜ë‚˜ë¯¸ ì „ë¬¸ê°€', img: 'https://images.unsplash.com/photo-1522383225653-ed111181a951', desc: 'ìš°ì—ë…¸ ê³µì›ì—ì„œ ì¦ê¸°ëŠ” ë²šê½ƒ ì¶•ì œ.' },
            { id: 110, title: 'êµí†  ì•„ì˜¤ì´ ë§ˆì¸ ë¦¬', region: 'êµí† ', lat: 35.039, lng: 135.780, country: 'Japan', type: 'ë¬¸í™”', celeb: 'ê·€ì¡± í–‰ë ¬ë‹¨', img: 'https://images.unsplash.com/photo-1480796927426-f609979314bd', desc: 'í—¤ì´ì•ˆ ì‹œëŒ€ ê·€ì¡± ì˜ìƒì„ ì¬í˜„í•œ í–‰ë ¬.' },
            { id: 111, title: 'ì˜¤ì‚¬ì¹´ ê°€ì´ìœ ì¹¸ ì¡°ëª… ì¶•ì œ', region: 'ì˜¤ì‚¬ì¹´', lat: 34.654, lng: 135.428, country: 'Japan', type: 'ë¬¸í™”', celeb: 'ì¡°ëª… ë””ìì´ë„ˆ', img: 'https://images.unsplash.com/photo-1478436127897-769e1b3f0f36', desc: 'ìˆ˜ì¡±ê´€ê³¼ í•¨ê»˜ ì¦ê¸°ëŠ” ë¹›ì˜ ì¶•ì œ.' },
            { id: 112, title: 'í›„ì¿ ì˜¤ì¹´ ëª¨ì¸ ë‚˜ë²  ì¶•ì œ', region: 'í›„ì¿ ì˜¤ì¹´', lat: 33.590, lng: 130.402, country: 'Japan', type: 'ìŒì‹', celeb: 'ìš”ë¦¬ì‚¬', img: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd', desc: 'ê·œìŠˆ ëŒ€í‘œ ìŒì‹ ëª¨ì¸ ë‚˜ë² ë¥¼ ë§›ë³´ëŠ” ì¶•ì œ.' },
            { id: 113, title: 'í™‹ì¹´ì´ë„ ë¼ë²¤ë” ì¶•ì œ', region: 'í™‹ì¹´ì´ë„', lat: 43.676, lng: 142.367, country: 'Japan', type: 'ë¬¸í™”', celeb: 'ë†ë¶€', img: 'https://images.unsplash.com/photo-1464820453369-31d2c0b651af', desc: 'ë³´ë¼ìƒ‰ ë¼ë²¤ë” ë°­ì´ í¼ì³ì§€ëŠ” ì—¬ë¦„ ì¶•ì œ.' }
        ];

        window.onload = function() {
            initializeMap();
            loadTags();
            setupEventListeners();
            loadRecentSearches();
        };

        function initializeMap() {
            map = L.map('map', { zoomControl: false }).setView([35.9, 127.5], 7);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            markersCluster = L.markerClusterGroup({
                iconCreateFunction: function(cluster) {
                    var childCount = cluster.getChildCount();
                    var c = ' marker-cluster-';
                    var densityClass = '';
                    
                    if (childCount < 5) {
                        c += 'small';
                    } else if (childCount < 10) {
                        c += 'medium';
                    } else {
                        c += 'large';
                        densityClass = 'cluster-high-density';
                    }

                    return new L.DivIcon({ 
                        html: '<div class="' + densityClass + '"><span>' + childCount + '</span></div>', 
                        className: 'marker-cluster' + c, 
                        iconSize: new L.Point(40, 40) 
                    });
                }
            });
            
            map.addLayer(markersCluster);
            loadEventMarkers();
        }

        function loadEventMarkers() {
            markersCluster.clearLayers();
            
            const filteredEvents = mockEvents.filter(e => e.country === currentCountry);

            filteredEvents.forEach(event => {
                const markerIcon = L.divIcon({
                    className: 'custom-pin',
                    html: `<div class="w-10 h-10 rounded-full border-2 border-white overflow-hidden shadow-lg bg-gray-800 transition-transform hover:scale-110" data-id="${event.id}" style="filter: brightness(${markerBrightnessValue});">
                             <img src="${event.img}" class="w-full h-full object-cover">
                           </div>`,
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });

                const marker = L.marker([event.lat, event.lng], { icon: markerIcon });
                marker.eventData = event;

                marker.on('click', () => {
                    showDetailSheet(event);
                });

                markersCluster.addLayer(marker);
            });
            
            if(currentCountry === 'Korea') map.panTo([35.9, 127.5]);
            else map.panTo([36.2048, 138.2529]);
        }

        function setCountry(country) {
            currentCountry = country;
            document.getElementById('btn-kr').className = country === 'Korea' ? 
                "bg-blue-600 hover:bg-blue-500 text-white px-4 py-1.5 rounded-full text-xs font-bold shadow-lg ring-2 ring-white/20" : 
                "bg-gray-700 hover:bg-blue-500 text-white px-4 py-1.5 rounded-full text-xs font-bold shadow-lg";
                
            document.getElementById('btn-jp').className = country === 'Japan' ? 
                "bg-red-600 hover:bg-red-500 text-white px-4 py-1.5 rounded-full text-xs font-bold shadow-lg ring-2 ring-white/20" : 
                "bg-gray-700 hover:bg-red-500 text-white px-4 py-1.5 rounded-full text-xs font-bold shadow-lg";
            
            loadEventMarkers();
            loadTags();
        }

        // #upgrade í…Œë§ˆ í•„í„° ì¶”ê°€ + ì§€ì—­ íƒœê·¸
        function loadTags() {
            const container = document.getElementById('tagContainer');
            container.innerHTML = '';
            
            const regions = currentCountry === 'Korea' 
                ? ['ì „ì²´', 'ì„œìš¸', 'ê²½ê¸°', 'ê°•ì›', 'ì¶©ë‚¨', 'ì¶©ë¶', 'ì „ë¶', 'ì „ë‚¨', 'ê²½ë¶', 'ê²½ë‚¨', 'ë¶€ì‚°', 'ì œì£¼']
                : ['ì „ì²´', 'ë„ì¿„', 'ì˜¤ì‚¬ì¹´', 'êµí† ', 'í›„ì¿ ì˜¤ì¹´', 'í™‹ì¹´ì´ë„', 'ì˜¤í‚¤ë‚˜ì™€', 'ë‚˜ê³ ì•¼'];

            // ì§€ì—­ ë²„íŠ¼
            regions.forEach(region => {
                const btn = document.createElement('button');
                btn.className = "bg-gray-800/80 hover:bg-gray-700 border border-gray-600 text-gray-300 px-3 py-1 rounded-full text-xs transition-all hover:text-white hover:border-white";
                btn.innerText = region;
                btn.onclick = () => filterByRegion(region);
                container.appendChild(btn);
            });
            
            // êµ¬ë¶„ì„ 
            const divider = document.createElement('span');
            divider.className = "text-gray-600 mx-2";
            divider.innerText = '|';
            container.appendChild(divider);
            
            // #upgrade í…Œë§ˆ í•„í„° ë²„íŠ¼
            const themes = ['ë¬¸í™”', 'ìŒì‹', 'ìŒì•…'];
            themes.forEach(theme => {
                const btn = document.createElement('button');
                btn.className = "bg-purple-800/80 hover:bg-purple-700 border border-purple-600 text-purple-300 px-3 py-1 rounded-full text-xs transition-all hover:text-white hover:border-white";
                btn.innerText = theme;
                btn.onclick = () => filterByTheme(theme);
                container.appendChild(btn);
            });
        }

        function filterByRegion(region) {
            if (currentGlowLayer) {
                map.removeLayer(currentGlowLayer);
                currentGlowLayer = null;
            }

            if (region === 'ì „ì²´') {
                loadEventMarkers();
                return;
            }

            markersCluster.clearLayers();
            const filtered = mockEvents.filter(e => e.country === currentCountry && e.region === region);
            filtered.forEach(event => {
                const markerIcon = L.divIcon({
                    className: 'custom-pin',
                    html: `<div class="w-10 h-10 rounded-full border-2 border-white overflow-hidden shadow-lg bg-gray-800" data-id="${event.id}" style="filter: brightness(${markerBrightnessValue});">
                             <img src="${event.img}" class="w-full h-full object-cover">
                           </div>`,
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });
                const marker = L.marker([event.lat, event.lng], { icon: markerIcon });
                marker.eventData = event;
                marker.on('click', () => showDetailSheet(event));
                markersCluster.addLayer(marker);
            });

            if (regionBoundaryParams[region]) {
                const bounds = regionBoundaryParams[region];
                map.fitBounds(bounds, { padding: [50, 50], duration: 1.5 });

                currentGlowLayer = L.rectangle(bounds, {
                    className: 'region-glow-path',
                    weight: 3,
                    color: '#ffeb3b',
                    fillOpacity: 0.1
                }).addTo(map);
            }
        }

        // #upgrade í…Œë§ˆë³„ í•„í„°ë§
        function filterByTheme(theme) {
            if (currentGlowLayer) {
                map.removeLayer(currentGlowLayer);
                currentGlowLayer = null;
            }
            
            markersCluster.clearLayers();
            const filtered = mockEvents.filter(e => e.country === currentCountry && e.type === theme);
            filtered.forEach(event => {
                const markerIcon = L.divIcon({
                    className: 'custom-pin',
                    html: `<div class="w-10 h-10 rounded-full border-2 border-white overflow-hidden shadow-lg bg-gray-800" data-id="${event.id}" style="filter: brightness(${markerBrightnessValue});">
                             <img src="${event.img}" class="w-full h-full object-cover">
                           </div>`,
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });
                const marker = L.marker([event.lat, event.lng], { icon: markerIcon });
                marker.eventData = event;
                marker.on('click', () => showDetailSheet(event));
                markersCluster.addLayer(marker);
            });
        }

        function showDetailSheet(event) {
            const sheet = document.getElementById('detailSheet');
            document.getElementById('sheetTitle').innerText = event.title;
            document.getElementById('sheetRegion').innerText = event.region;
            document.getElementById('sheetSummary').innerText = event.desc;
            document.getElementById('sheetCeleb').innerText = event.celeb;
            document.getElementById('sheetDate').innerText = '2026.02.11 ~ 2026.02.14';
            document.getElementById('sheetImage').src = event.img;
            
            sheet.classList.add('active');
        }

        document.getElementById('closeButton').addEventListener('click', () => {
            document.getElementById('detailSheet').classList.remove('active');
        });

        // #upgrade Alt + ë“œë˜ê·¸ ì„ íƒ ë¡œì§ ê°œì„ 
        function setupEventListeners() {
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') deselectAll();
            });

            const mapContainer = document.getElementById('map');

            mapContainer.addEventListener('mousedown', (e) => {
                if (e.altKey) {
                    isSelecting = true;
                    map.dragging.disable();
                    selectionStart = { x: e.clientX, y: e.clientY };
                    
                    selectionBox.style.left = e.clientX + 'px';
                    selectionBox.style.top = e.clientY + 'px';
                    selectionBox.style.width = '0px';
                    selectionBox.style.height = '0px';
                    selectionBox.style.display = 'block';
                }
            });

            window.addEventListener('mousemove', (e) => {
                if (!isSelecting) return;

                const currentX = e.clientX;
                const currentY = e.clientY;

                const width = Math.abs(currentX - selectionStart.x);
                const height = Math.abs(currentY - selectionStart.y);
                const left = Math.min(currentX, selectionStart.x);
                const top = Math.min(currentY, selectionStart.y);

                selectionBox.style.width = width + 'px';
                selectionBox.style.height = height + 'px';
                selectionBox.style.left = left + 'px';
                selectionBox.style.top = top + 'px';
            });

            window.addEventListener('mouseup', (e) => {
                if (!isSelecting) return;
                
                isSelecting = false;
                selectionBox.style.display = 'none';
                map.dragging.enable();

                // #upgrade ì„ íƒ ì˜ì—­ ê³„ì‚° ê°œì„ 
                const boxRect = selectionBox.getBoundingClientRect();
                const southWest = map.containerPointToLatLng([boxRect.bottom, boxRect.left]);
                const northEast = map.containerPointToLatLng([boxRect.top, boxRect.right]);
                const bounds = L.latLngBounds(southWest, northEast);

                // #upgrade ë§ˆì»¤ ì„ íƒ ë¡œì§ ê°œì„  (í´ëŸ¬ìŠ¤í„° ëŒ€ì‘)
                markersCluster.eachLayer((layer) => {
                    if (bounds.contains(layer.getLatLng())) {
                        selectedMarkers.add(layer);
                        // _iconì€ ë§ˆì»¤ê°€ í™”ë©´ì— ë Œë”ë§ëœ í›„ì—ë§Œ ì¡´ì¬
                        setTimeout(() => {
                            if (layer._icon) {
                                const iconDiv = layer._icon.querySelector('div');
                                if (iconDiv) iconDiv.classList.add('marker-selected');
                            }
                        }, 100);
                    }
                });
                
                console.log(`ì„ íƒëœ ë§ˆì»¤ ìˆ˜: ${selectedMarkers.size}`);
            });
        }

        // #upgrade ESCë¡œ ì„ íƒ í•´ì œ
        function deselectAll() {
            selectedMarkers.forEach(marker => {
                if (marker._icon) {
                    const iconDiv = marker._icon.querySelector('div');
                    if (iconDiv) iconDiv.classList.remove('marker-selected');
                }
            });
            selectedMarkers.clear();
            console.log('ì„ íƒ í•´ì œë¨');
        }
        
        // #upgrade ì„ íƒëœ ë§ˆì»¤ ì¼ê´„ ì‘ì—… ì¸í„°í˜ì´ìŠ¤
        function bulkAddTag(tagName) {
            selectedMarkers.forEach(marker => {
                if (!marker.eventData.tags) marker.eventData.tags = [];
                if (!marker.eventData.tags.includes(tagName)) {
                    marker.eventData.tags.push(tagName);
                }
            });
            alert(`${selectedMarkers.size}ê°œ ë§ˆì»¤ì— "${tagName}" íƒœê·¸ ì¶”ê°€ë¨`);
        }
        
        function bulkDelete() {
            if (confirm(`${selectedMarkers.size}ê°œ ë§ˆì»¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                selectedMarkers.forEach(marker => {
                    markersCluster.removeLayer(marker);
                });
                selectedMarkers.clear();
            }
        }
        
        function bulkExport() {
            const data = Array.from(selectedMarkers).map(m => m.eventData);
            console.log(JSON.stringify(data, null, 2));
            alert('ì„ íƒëœ ë°ì´í„°ê°€ ì½˜ì†”ì— ì¶œë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
        
        // #upgrade ìµœê·¼ ê²€ìƒ‰ì–´ localStorage
        function saveRecentSearch(query) {
            if (!query || query.trim() === '') return;
            let recents = JSON.parse(localStorage.getItem('recentSearches') || '[]');
            recents = [query, ...recents.filter(q => q !== query)].slice(0, 5);
            localStorage.setItem('recentSearches', JSON.stringify(recents));
            loadRecentSearches();
        }
        
        function loadRecentSearches() {
            const recents = JSON.parse(localStorage.getItem('recentSearches') || '[]');
            const container = document.getElementById('recentList');
            container.innerHTML = recents.map(q => 
                `<span class="bg-gray-700 px-2 py-1 rounded cursor-pointer hover:bg-gray-600" onclick="document.querySelector('input[name=query]').value='${q}'">${q}</span>`
            ).join('');
            document.getElementById('recentSearch').classList.toggle('hidden', recents.length === 0);
        }
        
        function toggleMemoMode() {
            alert('ë©”ëª¨ ëª¨ë“œ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤ (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì—°ë™ ì˜ˆì •)');
        }
    </script>
</body>
</html>
